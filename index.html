<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wang Weize | SULTAN OMNIVERSE - AI Director & Super Store Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@700;900&family=Playfair+Display:wght@900&family=Cormorant+Garamond:wght@600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* ======= TEMA IMLEK SULTAN - ROOT COLORS (UNTOUCHED) ======= */
        :root { --imperial-red: #8B0000; --emperor-gold: #FFD700; --rice-paper: #FDF6E3; }
        body { background-color: var(--rice-paper); color: #1a1a1a; font-family: 'Noto Serif SC', serif; background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'); overflow-x: hidden; padding-bottom: 120px; }

        .emperor-name { font-family: 'Playfair Display', serif; font-size: clamp(3rem, 8vw, 6.5rem); font-weight: 900; color: #ffffff; -webkit-text-stroke: 2.5px var(--imperial-red); text-shadow: 4px 4px 0 var(--emperor-gold), 8px 8px 20px rgba(0,0,0,0.5); letter-spacing: 6px; display: inline-block; line-height: 1.2; padding: 15px; filter: drop-shadow(0 5px 15px rgba(139,0,0,0.4)); }

        .imlek-calligraphy { font-family: 'Ma Shan Zheng', cursive; font-size: clamp(1.8rem, 5vw, 3rem); color: var(--emperor-gold); text-shadow: 1px 1px 3px rgba(139,0,0,0.7), 0 0 20px rgba(255,215,0,0.5); letter-spacing: 8px; display: block; margin-top: 8px; animation: glowGold 2s ease-in-out infinite alternate; }
        @keyframes glowGold { from { text-shadow: 1px 1px 3px rgba(139,0,0,0.7), 0 0 10px rgba(255,215,0,0.4); } to { text-shadow: 2px 2px 6px rgba(139,0,0,0.9), 0 0 30px rgba(255,215,0,0.9), 0 0 50px rgba(255,215,0,0.4); } }

        .glass-scroll { background: rgba(253, 246, 227, 0.95); backdrop-filter: blur(10px); border: 3px solid var(--imperial-red); border-radius: 12px; transition: 0.5s; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden-tab { display: none !important; }
        .active-nav { background: var(--imperial-red) !important; color: var(--emperor-gold) !important; transform: scale(1.05); box-shadow: 0 -5px 15px rgba(139,0,0,0.5); }

        .canvas-box { position: relative; width: 360px; height: 360px; margin: 0 auto; background: #fff; border: 6px double var(--imperial-red); border-radius: 10px; }
        canvas { touch-action: none; cursor: crosshair; position: absolute; top: 0; left: 0; }

        .imperial-particle { position: fixed; top: -10px; pointer-events: none; z-index: 0; opacity: 0.18; animation: fall linear infinite; font-size: 24px; color: var(--emperor-gold); }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        .vocab-card { background: white; border: 2px solid var(--imperial-red); border-radius: 16px; padding: 20px; box-shadow: 6px 6px 0 var(--imperial-red); transition: 0.3s; }
        .vocab-card:hover { transform: translateY(-5px); border-color: var(--emperor-gold); box-shadow: 8px 8px 0 var(--emperor-gold); }
        .vocab-hanzi { font-size: 42px; font-family: 'Ma Shan Zheng', cursive; color: var(--imperial-red); text-shadow: 1px 1px 0 var(--emperor-gold); }
        .vocab-btn { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--imperial-red); background: var(--emperor-gold); color: var(--imperial-red); transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .vocab-btn:hover { background: var(--imperial-red); color: var(--emperor-gold); transform: scale(1.1); }

        .profil-container { background: linear-gradient(145deg, #faf3e0, #f5e6d3); border: 3px solid var(--imperial-red); border-radius: 40px; box-shadow: 20px 20px 0 rgba(139,0,0,0.3); padding: 40px; position: relative; overflow: hidden; }
        .kartu-generasi { background: rgba(255,255,255,0.8); border: 2px solid var(--imperial-red); border-radius: 20px; padding: 20px; width: 220px; box-shadow: 8px 8px 0 var(--imperial-red); }

        .learning-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .search-wrapper { margin: 20px 0; }
        .search-wrapper input { width: 100%; padding: 15px 20px; border: 3px solid var(--imperial-red); border-radius: 50px; font-size: 16px; font-weight: bold; outline: none; transition: 0.3s; }
        .search-wrapper input:focus { border-color: var(--emperor-gold); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }

        .progress-bar { height: 30px; background: linear-gradient(90deg, var(--emperor-gold), var(--imperial-red)); border-radius: 15px; transition: width 0.5s; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .stat-card { background: linear-gradient(135deg, #fff 0%, #f8f8f8 100%); border: 2px solid var(--imperial-red); border-radius: 15px; padding: 20px; text-align: center; }

        .ai-suggestion { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 10px 0; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        .badge { display: inline-block; background: var(--emperor-gold); color: var(--imperial-red); padding: 5px 15px; border-radius: 20px; font-weight: bold; margin: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .level-badge { font-size: 24px; font-weight: 900; color: var(--emperor-gold); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        .flashcard { perspective: 1000px; height: 300px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; }
        .flashcard-front { background: linear-gradient(135deg, var(--imperial-red), #5a0000); color: white; }
        .flashcard-back { background: linear-gradient(135deg, var(--emperor-gold), #DAA520); color: var(--imperial-red); transform: rotateY(180deg); }

        .quiz-option { background: white; border: 3px solid var(--imperial-red); padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; margin: 10px 0; }
        .quiz-option:hover { background: var(--rice-paper); transform: translateX(10px); }
        .quiz-option.correct { background: #4ade80; border-color: #16a34a; }
        .quiz-option.wrong { background: #f87171; border-color: #dc2626; }

        .tone-visual { height: 80px; background: linear-gradient(to top, #e0e0e0, white); border-radius: 10px; position: relative; overflow: hidden; margin: 20px 0; }
        .tone-line { position: absolute; left: 0; width: 100%; height: 4px; background: var(--imperial-red); transition: all 0.3s; }

        .radical-part { display: inline-block; padding: 5px 10px; margin: 5px; background: rgba(139,0,0,0.1); border: 2px solid var(--imperial-red); border-radius: 8px; font-family: 'Ma Shan Zheng', cursive; font-size: 24px; cursor: help; transition: 0.3s; }
        .radical-part:hover { background: var(--emperor-gold); transform: scale(1.2); }

        .stroke-analysis { border: 2px dashed var(--imperial-red); padding: 15px; border-radius: 10px; margin: 15px 0; background: rgba(255,215,0,0.1); }

        .srs-indicator { height: 10px; border-radius: 5px; margin: 10px 0; }
        .srs-new { background: #60a5fa; }
        .srs-learning { background: #fbbf24; }
        .srs-review { background: #34d399; }
        .srs-master { background: #a78bfa; }

        .context-sentence { background: rgba(255,255,255,0.9); border-left: 4px solid var(--emperor-gold); padding: 15px; margin: 10px 0; border-radius: 5px; font-style: italic; }

        .pronunciation-heat { display: inline-block; padding: 3px 8px; border-radius: 5px; margin: 2px; }
        .heat-1 { background: #dcfce7; }
        .heat-2 { background: #fef3c7; }
        .heat-3 { background: #fecaca; }

        .streak-day { width: 30px; height: 30px; border-radius: 5px; display: inline-block; margin: 3px; }
        .streak-complete { background: var(--emperor-gold); }
        .streak-incomplete { background: #e5e5e5; }

        .leaderboard-item { background: white; border: 2px solid var(--imperial-red); padding: 15px; margin: 10px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .rank-medal { font-size: 32px; }

        .achievement-popup { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, var(--emperor-gold), #DAA520); color: var(--imperial-red); padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.5s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }

        .study-timer { font-size: 48px; font-weight: 900; color: var(--imperial-red); text-align: center; font-family: monospace; }

        .difficulty-btn { padding: 10px 20px; margin: 5px; border: 2px solid var(--imperial-red); border-radius: 20px; cursor: pointer; transition: 0.3s; background: white; }
        .difficulty-btn.active { background: var(--imperial-red); color: white; }
        .difficulty-btn.easy { border-color: #22c55e; }
        .difficulty-btn.active.easy { background: #22c55e; }
        .difficulty-btn.medium { border-color: #f59e0b; }
        .difficulty-btn.active.medium { background: #f59e0b; }
        .difficulty-btn.hard { border-color: #ef4444; }
        .difficulty-btn.active.hard { background: #ef4444; }

        /* ======= DOMPET ANGPAO FLOATING ======= */
        #angpaoWidget { position: fixed; top: 16px; right: 16px; z-index: 5000; background: linear-gradient(135deg, #8B0000, #C41E3A); border: 3px solid var(--emperor-gold); border-radius: 16px; padding: 10px 14px; color: var(--emperor-gold); font-family: 'Noto Serif SC', serif; box-shadow: 0 8px 25px rgba(139,0,0,0.5), 0 0 0 2px rgba(255,215,0,0.3); min-width: 160px; text-align: center; cursor: pointer; }
        #angpaoWidget .aw-label { font-size: 10px; font-weight: 900; letter-spacing: 2px; opacity: 0.85; }
        #angpaoWidget .aw-saldo { font-size: 18px; font-weight: 900; font-family: monospace; margin: 4px 0; }
        #angpaoWidget .aw-btn { background: var(--emperor-gold); color: var(--imperial-red); border: none; border-radius: 8px; padding: 6px 12px; font-weight: 900; font-size: 12px; cursor: pointer; transition: 0.2s; width: 100%; margin-top: 4px; }
        #angpaoWidget .aw-btn:hover { background: #ffe97a; transform: scale(1.03); }
        #angpaoWidget .aw-btn:disabled { background: #aaa; color: #666; cursor: not-allowed; transform: none; }

        /* ======= MODAL PENARIKAN ======= */
        .sultan-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sultan-modal { background: linear-gradient(145deg, #fff8e7, #fffdf0); border: 4px solid var(--emperor-gold); border-radius: 24px; padding: 32px; max-width: 420px; width: 92%; box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,215,0,0.3); position: relative; }
        .sultan-modal h3 { color: var(--imperial-red); font-size: 22px; font-weight: 900; margin-bottom: 20px; text-align: center; }
        .sultan-modal input, .sultan-modal select { width: 100%; padding: 12px 16px; border: 2px solid var(--imperial-red); border-radius: 10px; font-size: 15px; margin-bottom: 14px; font-family: 'Noto Serif SC', serif; outline: none; transition: 0.2s; background: #fffdf7; }
        .sultan-modal input:focus, .sultan-modal select:focus { border-color: var(--emperor-gold); box-shadow: 0 0 12px rgba(255,215,0,0.3); }
        .sultan-modal label { font-size: 12px; font-weight: 900; color: var(--imperial-red); letter-spacing: 1px; margin-bottom: 4px; display: block; }
        .sultan-modal .close-modal { position: absolute; top: 12px; right: 16px; font-size: 22px; cursor: pointer; color: var(--imperial-red); font-weight: 900; line-height: 1; }
        .sultan-modal .submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--imperial-red), #C41E3A); color: var(--emperor-gold); border: none; border-radius: 12px; font-size: 16px; font-weight: 900; cursor: pointer; transition: 0.3s; letter-spacing: 1px; }
        .sultan-modal .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139,0,0,0.4); }
        .saldo-info-modal { background: linear-gradient(135deg, #8B0000, #C41E3A); color: var(--emperor-gold); padding: 12px 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }

        /* ======= CINEMA TAB ======= */
        .cinema-search { display: flex; gap: 10px; margin-bottom: 16px; }
        .cinema-search input { flex: 1; padding: 12px 18px; border: 3px solid var(--imperial-red); border-radius: 50px; font-size: 15px; outline: none; transition: 0.3s; font-family: 'Noto Serif SC', serif; }
        .cinema-search input:focus { border-color: var(--emperor-gold); box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .cinema-search button { padding: 12px 22px; background: var(--imperial-red); color: var(--emperor-gold); border: none; border-radius: 50px; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .cinema-search button:hover { background: #6b0000; transform: scale(1.05); }

        .smart-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .chip { padding: 7px 16px; border: 2px solid var(--imperial-red); border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 13px; transition: 0.2s; background: white; color: var(--imperial-red); }
        .chip:hover, .chip.active { background: var(--imperial-red); color: var(--emperor-gold); transform: scale(1.05); }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; margin-top: 16px; }
        .video-card { background: white; border: 2px solid #e5e7eb; border-radius: 14px; overflow: hidden; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .video-card:hover { border-color: var(--imperial-red); transform: translateY(-4px); box-shadow: 0 12px 30px rgba(139,0,0,0.2); }
        .video-thumb { position: relative; width: 100%; padding-top: 56.25%; background: #111; }
        .video-thumb img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        .video-thumb .play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); opacity: 0; transition: 0.2s; font-size: 48px; }
        .video-card:hover .play-overlay { opacity: 1; }
        .video-badges { position: absolute; bottom: 6px; right: 6px; display: flex; gap: 4px; }
        .vbadge { background: rgba(0,0,0,0.8); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .video-info { padding: 12px; }
        .video-title { font-weight: 700; font-size: 13px; line-height: 1.4; color: #111; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-channel { font-size: 12px; color: #666; }

        /* Cinema Video Modal */
        .cinema-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 8000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .cinema-modal { background: #111; border: 3px solid var(--emperor-gold); border-radius: 20px; width: 96%; max-width: 860px; max-height: 95vh; overflow-y: auto; box-shadow: 0 0 60px rgba(255,215,0,0.3); }
        .cinema-modal .iframe-wrap { position: relative; padding-top: 56.25%; background: #000; border-radius: 16px 16px 0 0; overflow: hidden; }
        .cinema-modal .iframe-wrap iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }
        .cinema-modal-body { padding: 20px; }
        .cinema-modal-body h3 { color: var(--emperor-gold); font-size: 16px; font-weight: 900; margin-bottom: 14px; }
        .comment-card { background: #1e1e1e; border-left: 3px solid var(--emperor-gold); padding: 10px 14px; border-radius: 8px; margin-bottom: 10px; }
        .comment-card .cc-author { color: var(--emperor-gold); font-weight: 700; font-size: 12px; margin-bottom: 4px; }
        .comment-card .cc-text { color: #ddd; font-size: 13px; line-height: 1.5; }
        .reward-btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        .reward-btn-xp { padding: 12px 20px; background: linear-gradient(135deg, var(--imperial-red), #C41E3A); color: var(--emperor-gold); border: none; border-radius: 10px; font-weight: 900; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .reward-btn-xp:hover:not(:disabled) { transform: scale(1.05); }
        .reward-btn-xp:disabled { background: #444; color: #888; cursor: not-allowed; }
        .reward-btn-dl { padding: 12px 20px; background: linear-gradient(135deg, #1a7a1a, #2da72d); color: #fff; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .reward-btn-dl:hover { transform: scale(1.05); }
        .cinema-loading { text-align: center; padding: 40px; color: var(--imperial-red); font-size: 18px; font-weight: 900; }
        .cinema-loading span { display: inline-block; animation: bounce 0.8s infinite alternate; }
        @keyframes bounce { to { transform: translateY(-8px); } }
        .cinema-close { position: sticky; top: 0; z-index: 10; display: flex; justify-content: flex-end; padding: 10px 16px; background: #111; border-radius: 16px 16px 0 0; }
        .cinema-close button { background: #8B0000; color: #FFD700; border: none; padding: 8px 18px; border-radius: 8px; font-weight: 900; cursor: pointer; font-size: 14px; }

        /* ======= KARAOKE & RADAR STYLES ======= */
        .karaoke-card { background: #1a1a1a; border: 2px solid var(--emperor-gold); border-radius: 16px; overflow: hidden; color: white; position: relative; transition: 0.3s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .karaoke-card:hover { transform: scale(1.03); box-shadow: 0 0 20px rgba(255,215,0,0.5); }
        .karaoke-thumb { height: 150px; background-size: cover; background-position: center; position: relative; }
        .karaoke-thumb::after { content: 'ðŸŽ¤'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 40px; background: rgba(0,0,0,0.5); }
        .karaoke-info { padding: 15px; }
        .karaoke-modal { position: fixed; inset: 0; background: #000; z-index: 9500; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .lyric-glow { font-family: 'Ma Shan Zheng', cursive; font-size: 3rem; color: var(--emperor-gold); text-shadow: 0 0 20px var(--imperial-red); animation: pulseText 1.5s infinite alternate; text-align: center; margin-top: 20px; }
        @keyframes pulseText { from { opacity: 0.7; transform: scale(0.95); } to { opacity: 1; transform: scale(1.05); } }

        .radar-box { background: #111; color: #0f0; border: 2px solid #333; padding: 15px; border-radius: 10px; font-family: monospace; margin-top: 20px; position: relative; overflow: hidden; }
        .radar-box::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, rgba(0, 255, 0, 0.1), transparent 30%); animation: radarSpin 4s linear infinite; pointer-events: none; }
        @keyframes radarSpin { 100% { transform: rotate(360deg); } }
        .ping-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .ping-good { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .ping-warn { background: #ff0; box-shadow: 0 0 10px #ff0; }
        .ping-bad { background: #f00; box-shadow: 0 0 10px #f00; }

        /* ================================================================ */
        /* ======= STORE SULTAN - STYLES (BARU) ========================== */
        /* ================================================================ */
        #store { background: linear-gradient(160deg, #0a0a0a 0%, #1a0000 50%, #0a0a0a 100%); border: 3px solid var(--emperor-gold); border-radius: 20px; padding: 30px; box-shadow: 0 0 60px rgba(255,215,0,0.15), inset 0 0 100px rgba(139,0,0,0.1); }
        .store-title { font-family: 'Playfair Display', serif; font-size: clamp(1.5rem, 4vw, 2.5rem); font-weight: 900; color: var(--emperor-gold); text-shadow: 0 0 20px rgba(255,215,0,0.5); letter-spacing: 3px; text-align: center; margin-bottom: 8px; }
        .store-subtitle { text-align: center; color: #aaa; font-size: 13px; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; }

        .store-category-label { font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--emperor-gold); padding: 8px 20px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 4px; display: inline-block; margin-bottom: 20px; }

        /* Product Cards - Top Up */
        .topup-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 10px; }
        .topup-product-card { background: linear-gradient(145deg, #1a1a1a, #111); border: 1px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; position: relative; overflow: hidden; }
        .topup-product-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,215,0,0.05), transparent); opacity: 0; transition: 0.3s; }
        .topup-product-card:hover { border-color: var(--emperor-gold); box-shadow: 0 0 25px rgba(255,215,0,0.2); transform: translateY(-4px); }
        .topup-product-card:hover::before { opacity: 1; }
        .topup-product-card.selected { border-color: var(--emperor-gold); background: linear-gradient(145deg, #1a1500, #0a0800); box-shadow: 0 0 30px rgba(255,215,0,0.3); }
        .topup-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .topup-name { color: white; font-weight: 900; font-size: 14px; margin-bottom: 6px; }
        .topup-desc { color: #888; font-size: 11px; }

        /* Form Topup */
        .store-form { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,215,0,0.15); border-radius: 16px; padding: 24px; margin: 20px 0; }
        .store-form label { display: block; color: var(--emperor-gold); font-size: 11px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; margin-top: 16px; }
        .store-form label:first-child { margin-top: 0; }
        .store-input { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,215,0,0.25); border-radius: 10px; color: white; font-size: 15px; font-weight: 700; outline: none; transition: 0.3s; font-family: 'Noto Serif SC', serif; }
        .store-input::placeholder { color: #555; }
        .store-input:focus { border-color: var(--emperor-gold); box-shadow: 0 0 15px rgba(255,215,0,0.2); background: rgba(255,255,255,0.08); }
        .store-select { width: 100%; padding: 14px 18px; background: #1a1a1a; border: 1px solid rgba(255,215,0,0.25); border-radius: 10px; color: white; font-size: 14px; font-weight: 700; outline: none; transition: 0.3s; cursor: pointer; }
        .store-select:focus { border-color: var(--emperor-gold); }
        .store-select option { background: #1a1a1a; }

        /* Nominal Chips */
        .nominal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 6px; }
        .nominal-chip { padding: 10px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 10px; color: #ccc; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; text-align: center; }
        .nominal-chip:hover { border-color: var(--emperor-gold); color: var(--emperor-gold); background: rgba(255,215,0,0.08); }
        .nominal-chip.active { border-color: var(--emperor-gold); color: #000; background: var(--emperor-gold); }
        .nominal-chip .nc-price { font-size: 10px; color: inherit; opacity: 0.8; display: block; }

        /* Payment Method Logos */
        .payment-section { margin-top: 6px; }
        .payment-group-label { color: #666; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .payment-logos { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
        .payment-logo { padding: 8px 14px; border: 1px solid #333; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 700; background: rgba(255,255,255,0.04); color: #bbb; }
        .payment-logo:hover { border-color: rgba(255,215,0,0.5); color: white; }
        .payment-logo.selected { border-color: var(--emperor-gold); background: rgba(255,215,0,0.1); color: var(--emperor-gold); }
        .pay-icon { width: 22px; height: 22px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; }
        .pay-bca { background: #005BAA; }
        .pay-mandiri { background: #003F8A; }
        .pay-bri { background: #00529B; }
        .pay-dana { background: #118EEA; }
        .pay-ovo { background: #4C3FA0; }
        .pay-gopay { background: #00AED6; }
        .pay-tsel { background: #FF0000; }
        .pay-xl { background: #0A4FA8; }
        .pay-indosat { background: #FFCB00; color: #000 !important; }
        .pay-tri { background: #FA3232; }

        /* Pay Button */
        .store-pay-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #c8960c, var(--emperor-gold), #c8960c); color: #000; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; cursor: pointer; transition: 0.3s; letter-spacing: 2px; text-transform: uppercase; font-family: 'Orbitron', monospace; box-shadow: 0 0 20px rgba(255,215,0,0.3); margin-top: 20px; }
        .store-pay-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255,215,0,0.5); }
        .store-pay-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Premium Account Cards */
        .premium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .premium-card { background: linear-gradient(145deg, #111, #1a1a1a); border: 1px solid rgba(255,215,0,0.2); border-radius: 20px; padding: 24px; position: relative; overflow: hidden; transition: 0.3s; }
        .premium-card::after { content: ''; position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: radial-gradient(circle, rgba(255,215,0,0.12), transparent 70%); }
        .premium-card:hover { border-color: var(--emperor-gold); transform: translateY(-5px); box-shadow: 0 15px 40px rgba(255,215,0,0.15); }
        .premium-icon { font-size: 44px; margin-bottom: 12px; display: block; }
        .premium-name { color: white; font-weight: 900; font-size: 18px; margin-bottom: 4px; }
        .premium-type { color: #888; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 16px; }
        .premium-price-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .premium-price-cross { color: #666; font-size: 13px; text-decoration: line-through; }
        .premium-price-main { color: var(--emperor-gold); font-size: 24px; font-weight: 900; font-family: monospace; }
        .premium-markup { background: rgba(139,0,0,0.4); color: #f87171; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .premium-buy-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #00c400, #00a000); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 900; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .premium-buy-btn:hover { transform: scale(1.03); box-shadow: 0 5px 20px rgba(0,200,0,0.3); }

        /* Divider */
        .store-divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,215,0,0.3), transparent); margin: 35px 0; }

        /* ================================================================ */
        /* ======= AI DIRECTOR LAB - STYLES (BARU) ======================= */
        /* ================================================================ */
        #ai-lab { background: linear-gradient(160deg, #020215 0%, #0a0a2a 40%, #150015 100%); border: 2px solid #00f0ff; border-radius: 20px; padding: 30px; box-shadow: 0 0 60px rgba(0,240,255,0.1), inset 0 0 100px rgba(0,0,50,0.5); position: relative; overflow: hidden; }
        #ai-lab::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(0,240,255,0.015) 40px, rgba(0,240,255,0.015) 41px), repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,240,255,0.015) 40px, rgba(0,240,255,0.015) 41px); pointer-events: none; }

        .lab-title { font-family: 'Orbitron', monospace; font-size: clamp(1.2rem, 4vw, 2rem); font-weight: 900; color: #00f0ff; text-shadow: 0 0 20px rgba(0,240,255,0.7), 0 0 40px rgba(0,240,255,0.3); letter-spacing: 4px; text-align: center; margin-bottom: 4px; }
        .lab-subtitle { text-align: center; color: rgba(0,240,255,0.5); font-size: 11px; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 30px; font-family: 'Orbitron', monospace; }

        .lab-prompt-area { background: rgba(0,240,255,0.04); border: 1px solid rgba(0,240,255,0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; }
        .lab-prompt-area::before { content: '// IMAJINASI LIAR MODE'; position: absolute; top: -10px; left: 15px; background: #020215; color: rgba(0,240,255,0.6); font-size: 10px; font-family: 'Orbitron', monospace; padding: 0 8px; letter-spacing: 2px; }
        .lab-textarea { width: 100%; min-height: 120px; background: transparent; border: none; color: #e0f0ff; font-size: 15px; font-family: 'Noto Serif SC', serif; outline: none; resize: vertical; line-height: 1.7; }
        .lab-textarea::placeholder { color: rgba(0,240,255,0.25); font-style: italic; }

        .lab-specs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .lab-spec-group { background: rgba(0,240,255,0.03); border: 1px solid rgba(0,240,255,0.15); border-radius: 10px; padding: 16px; }
        .lab-spec-label { font-family: 'Orbitron', monospace; font-size: 9px; letter-spacing: 3px; color: rgba(0,240,255,0.6); text-transform: uppercase; margin-bottom: 10px; display: block; }
        .lab-select { width: 100%; padding: 10px 12px; background: rgba(0,0,20,0.8); border: 1px solid rgba(0,240,255,0.25); border-radius: 8px; color: #00f0ff; font-size: 13px; font-weight: 700; outline: none; cursor: pointer; transition: 0.2s; font-family: monospace; }
        .lab-select:focus { border-color: #00f0ff; box-shadow: 0 0 10px rgba(0,240,255,0.2); }
        .lab-select option { background: #0a0a2a; }

        /* Model Preview Cards */
        .lab-model-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .lab-model-card { padding: 14px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: 0.3s; text-align: center; background: rgba(255,255,255,0.03); }
        .lab-model-card:hover { border-color: rgba(0,240,255,0.5); transform: translateY(-3px); }
        .lab-model-card.selected { border-color: #00f0ff; background: rgba(0,240,255,0.08); box-shadow: 0 0 20px rgba(0,240,255,0.2); }
        .lab-model-card.video-type { border-color: rgba(255,100,0,0.3); }
        .lab-model-card.video-type.selected { border-color: #ff6400; background: rgba(255,100,0,0.08); box-shadow: 0 0 20px rgba(255,100,0,0.2); }
        .lab-model-card.image-type { border-color: rgba(150,0,255,0.3); }
        .lab-model-card.image-type.selected { border-color: #9600ff; background: rgba(150,0,255,0.08); box-shadow: 0 0 20px rgba(150,0,255,0.2); }
        .model-emoji { font-size: 30px; display: block; margin-bottom: 8px; }
        .model-name { font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700; color: white; margin-bottom: 4px; }
        .model-type-badge { font-size: 9px; letter-spacing: 1px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
        .type-video { background: rgba(255,100,0,0.2); color: #ff9966; }
        .type-image { background: rgba(150,0,255,0.2); color: #cc88ff; }

        /* Generate Button */
        .lab-generate-btn { width: 100%; padding: 20px; background: linear-gradient(135deg, #001a33, #003366, #001a33); border: 2px solid #00f0ff; border-radius: 12px; color: #00f0ff; font-size: 16px; font-weight: 900; cursor: pointer; transition: 0.3s; letter-spacing: 4px; text-transform: uppercase; font-family: 'Orbitron', monospace; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,240,255,0.15); }
        .lab-generate-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent, rgba(0,240,255,0.1), transparent); transform: translateX(-100%); transition: 0.5s; }
        .lab-generate-btn:hover { box-shadow: 0 0 40px rgba(0,240,255,0.4); }
        .lab-generate-btn:hover::before { transform: translateX(100%); }

        /* Clipboard Toast */
        #labToast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #001a33, #003366); border: 1px solid #00f0ff; color: #00f0ff; padding: 12px 24px; border-radius: 30px; font-family: 'Orbitron', monospace; font-size: 12px; letter-spacing: 2px; box-shadow: 0 0 20px rgba(0,240,255,0.3); z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #labToast.show { opacity: 1; }

        /* Store Toast */
        #storeToast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #1a0000, #330000); border: 1px solid var(--emperor-gold); color: var(--emperor-gold); padding: 12px 24px; border-radius: 30px; font-family: 'Noto Serif SC', serif; font-size: 13px; font-weight: 900; box-shadow: 0 0 20px rgba(255,215,0,0.3); z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #storeToast.show { opacity: 1; }

        /* ================================================================ */
        /* ======= STORE V3 â€” SMART PAYMENT HUB STYLES =================== */
        /* ================================================================ */

        /* â”€â”€ 3D COIN â”€â”€ */
        .coin-3d {
            width: 56px; height: 56px; border-radius: 50%; margin: 0 auto 10px;
            background: radial-gradient(circle at 35% 35%, #fff7a0, #FFD700 40%, #c8960c 70%, #7a5c00 100%);
            box-shadow:
                3px 3px 0 #a07800,
                6px 6px 0 #8a6600,
                9px 9px 0 rgba(0,0,0,0.25),
                inset -4px -4px 8px rgba(0,0,0,0.3),
                inset 4px 4px 8px rgba(255,255,255,0.5),
                0 0 20px rgba(255,215,0,0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; transition: transform 0.5s;
            transform-style: preserve-3d;
        }
        .topup-product-card:hover .coin-3d { transform: rotateY(360deg); }
        .coin-3d-wrap { perspective: 600px; }

        /* â”€â”€ CSS PAYMENT LOGOS â”€â”€ */
        .pay-logo-qris {
            width: 44px; height: 26px; background: #fff; border: 2px solid #cc0000;
            border-radius: 5px; display: inline-flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; color: #cc0000; letter-spacing: 0.5px; font-family: monospace;
        }
        .pay-logo-bca {
            width: 44px; height: 26px; background: #005BAA; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff; letter-spacing: 0.5px;
        }
        .pay-logo-dana {
            width: 44px; height: 26px; background: #118EEA; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
        }
        .pay-logo-ovo {
            width: 44px; height: 26px; background: #4C3FA0; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
        }
        .pay-logo-gopay {
            width: 44px; height: 26px; background: #00AED6; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
        }
        .pay-logo-mandiri {
            width: 44px; height: 26px; background: #003F8A; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; color: #FFCB00;
        }
        .pay-logo-bri {
            width: 44px; height: 26px; background: #00529B; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
        }
        .pay-logo-tsel {
            width: 44px; height: 26px; background: #FF0000; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: 900; color: #fff; letter-spacing: 0;
        }
        .pay-logo-xl {
            width: 44px; height: 26px; background: #0A4FA8; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
        }
        .pay-logo-indosat {
            width: 44px; height: 26px; background: #FFCB00; border-radius: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; color: #000; letter-spacing: 0;
        }

        /* â”€â”€ NOMOR INPUT WRAPPER â”€â”€ */
        .nomor-input-wrap { position: relative; display: flex; gap: 8px; align-items: center; }
        .nomor-input-wrap .store-input { flex: 1; }
        .btn-contact-book {
            flex-shrink: 0; width: 46px; height: 48px;
            background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.4);
            border-radius: 10px; color: var(--emperor-gold); font-size: 22px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-contact-book:hover { background: rgba(255,215,0,0.2); transform: scale(1.05); }

        /* â”€â”€ CONTACT BOOK PANEL â”€â”€ */
        #contactBookPanel {
            display: none; background: rgba(15,10,0,0.98); border: 1px solid rgba(255,215,0,0.3);
            border-radius: 12px; padding: 16px; margin-top: 10px;
        }
        #contactBookPanel h4 { color: var(--emperor-gold); font-size: 12px; font-weight: 900; letter-spacing: 2px; margin-bottom: 12px; text-transform: uppercase; }
        .contact-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: rgba(255,215,0,0.05);
            border: 1px solid rgba(255,215,0,0.15); border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s;
        }
        .contact-item:hover { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.4); }
        .contact-item .cn { color: white; font-weight: 700; font-size: 13px; }
        .contact-item .cd { color: #888; font-size: 11px; }
        .contact-item .del-btn { color: #f87171; font-size: 16px; padding: 2px 6px; background: none; border: none; cursor: pointer; }
        .contact-save-row { display: flex; gap: 8px; margin-top: 12px; }
        .contact-save-row input { flex: 1; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: white; font-size: 13px; outline: none; }
        .contact-save-row button { padding: 10px 16px; background: var(--emperor-gold); color: #000; border: none; border-radius: 8px; font-weight: 900; font-size: 12px; cursor: pointer; }

        /* â”€â”€ TRANSACTION HISTORY â”€â”€ */
        #txHistory { margin-top: 16px; }
        #txHistory h4 { color: var(--emperor-gold); font-size: 11px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; background: rgba(255,215,0,0.04);
            border-left: 3px solid rgba(255,215,0,0.4); border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
        }
        .tx-item .tp { color: white; font-weight: 700; font-size: 12px; }
        .tx-item .tn { color: var(--emperor-gold); font-size: 11px; font-family: monospace; }
        .tx-item .td { color: #666; font-size: 10px; }

        /* ======= SULTAN AI TAB ======= */
        #ask-ai { margin: 0 auto; }
        #aiChatBox::-webkit-scrollbar { width: 6px; }
        #aiChatBox::-webkit-scrollbar-track { background: rgba(168,85,247,0.05); border-radius: 4px; }
        #aiChatBox::-webkit-scrollbar-thumb { background: rgba(168,85,247,0.4); border-radius: 4px; }
        #aiUserInput::placeholder { color: rgba(168,85,247,0.35); }
        #aiUserInput::-webkit-scrollbar { width: 4px; }
        #aiUserInput::-webkit-scrollbar-thumb { background: rgba(168,85,247,0.3); border-radius: 4px; }
        #aiProviderSelect option { background: #1a0028; }
        .ai-quick-btn { padding:6px 14px; background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.4); border-radius:20px; color:#c4b5fd; font-size:12px; cursor:pointer; transition:0.2s; font-weight:700; }
        .ai-quick-btn:hover { background:rgba(168,85,247,0.3); }

        /* â”€â”€ LOADING OVERLAY â”€â”€ */
        #paymentLoadingOverlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 99999; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Noto Serif SC', serif;
        }
        #paymentLoadingOverlay .lo-spinner {
            width: 80px; height: 80px; border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff7a0, #FFD700 40%, #c8960c 70%, #7a5c00);
            box-shadow: 0 0 40px rgba(255,215,0,0.5);
            animation: spinCoin 1s linear infinite;
            margin-bottom: 28px;
            display: flex; align-items: center; justify-content: center; font-size: 36px;
        }
        @keyframes spinCoin { to { transform: rotateY(360deg); } }
        #paymentLoadingOverlay .lo-title { color: var(--emperor-gold); font-size: 20px; font-weight: 900; letter-spacing: 2px; text-align: center; }
        #paymentLoadingOverlay .lo-sub { color: #888; font-size: 12px; margin-top: 10px; letter-spacing: 1px; font-family: monospace; }
        #paymentLoadingOverlay .lo-dots { color: var(--emperor-gold); font-size: 28px; animation: blink 1s infinite; letter-spacing: 4px; margin-top: 8px; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* ================================================================ */
        /* ======= WANG DYNASTY HEADER â€” NEW CSS ========================= */
        /* ================================================================ */
        .wang-dynasty-header {
            padding: 60px 20px 40px;
            background:
                radial-gradient(ellipse at top, rgba(139,0,0,0.12) 0%, transparent 65%),
                url('https://www.transparenttextures.com/patterns/silk.png');
            background-color: var(--rice-paper);
            position: relative;
            border-bottom: 6px double var(--imperial-red);
        }
        .dynasty-top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 8px;
            background: repeating-linear-gradient(90deg, var(--imperial-red) 0px, var(--imperial-red) 30px, var(--emperor-gold) 30px, var(--emperor-gold) 36px);
        }
        .dynasty-bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 8px;
            background: repeating-linear-gradient(90deg, var(--emperor-gold) 0px, var(--emperor-gold) 30px, var(--imperial-red) 30px, var(--imperial-red) 36px);
            margin-top: 30px;
        }

        /* Lanterns */
        .lantern {
            position: absolute; top: 18px; font-size: 3rem;
            animation: lanternSwing 4s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(139,0,0,0.5));
            transform-origin: top center;
        }
        .lantern-left { left: 30px; animation-delay: 0s; }
        .lantern-right { right: 30px; animation-delay: 0.8s; }
        @keyframes lanternSwing {
            0%, 100% { transform: rotate(-8deg); }
            50% { transform: rotate(8deg); }
        }

        /* Imperial Emblem */
        .imperial-emblem-wrap {
            position: relative; display: inline-block; margin-bottom: 24px; margin-top: 10px;
        }
        .imperial-frame-outer {
            width: 160px; height: 160px; margin: 0 auto;
            border: 8px double var(--imperial-red);
            border-radius: 50%;
            background: radial-gradient(circle, #fff8e7 40%, #f5e0b0 100%);
            box-shadow:
                0 0 0 4px var(--emperor-gold),
                0 0 0 8px var(--imperial-red),
                0 0 40px rgba(139,0,0,0.4),
                0 0 80px rgba(255,215,0,0.15);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .imperial-frame-outer::before {
            content: '';
            position: absolute; inset: 8px;
            border: 3px solid var(--emperor-gold);
            border-radius: 50%;
            opacity: 0.6;
        }
        .imperial-frame-inner { display: flex; align-items: center; justify-content: center; }
        .wang-character {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 90px;
            color: var(--imperial-red);
            text-shadow:
                3px 3px 0 var(--emperor-gold),
                0 0 30px rgba(139,0,0,0.4);
            line-height: 1;
            animation: glowGold 2.5s ease-in-out infinite alternate;
        }
        .dragon-left, .dragon-right {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 2.2rem; filter: drop-shadow(0 0 10px rgba(255,215,0,0.5));
            animation: dragonFloat 3s ease-in-out infinite alternate;
        }
        .dragon-left { left: -60px; transform: translateY(-50%) scaleX(-1); }
        .dragon-right { right: -60px; }
        @keyframes dragonFloat {
            0% { transform: translateY(-50%) translateX(0); }
            100% { transform: translateY(-60%) translateX(4px); }
        }
        .dragon-left { animation-delay: 0.4s; }

        /* Name block */
        .dynasty-name-block { margin-bottom: 14px; }
        .wang-imperial-name {
            font-family: 'Cormorant Garamond', 'Playfair Display', serif;
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            font-weight: 700;
            color: var(--imperial-red);
            text-shadow:
                2px 2px 0 var(--emperor-gold),
                0 0 30px rgba(139,0,0,0.3);
            letter-spacing: 6px;
            text-transform: uppercase;
        }
        .dynasty-separator {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; margin: 12px auto; max-width: 400px;
        }
        .sep-line {
            flex: 1; height: 2px;
            background: linear-gradient(90deg, transparent, var(--emperor-gold), transparent);
        }
        .sep-diamond { color: var(--emperor-gold); font-size: 14px; }

        /* Bloodline ribbon */
        .bloodline-ribbon {
            display: inline-block;
            background: linear-gradient(135deg, var(--imperial-red) 0%, #a00000 50%, var(--imperial-red) 100%);
            padding: 10px 32px;
            clip-path: polygon(16px 0%, calc(100% - 16px) 0%, 100% 50%, calc(100% - 16px) 100%, 16px 100%, 0% 50%);
            box-shadow: 0 4px 20px rgba(139,0,0,0.5), inset 0 1px 0 rgba(255,215,0,0.3);
            margin: 4px 0;
            position: relative;
        }
        .bloodline-ribbon::before, .bloodline-ribbon::after {
            content: '';
            position: absolute; top: 3px; bottom: 3px;
            left: 22px; right: 22px;
            border-top: 1px solid rgba(255,215,0,0.3);
            border-bottom: 1px solid rgba(255,215,0,0.3);
            pointer-events: none;
        }
        .ribbon-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(0.85rem, 2.5vw, 1.05rem);
            font-weight: 700;
            color: var(--emperor-gold);
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            white-space: nowrap;
        }
        .ribbon-dot { margin: 0 10px; }
        .flag-emoji { font-style: normal; }

        /* ================================================================ */
        /* ======= SULTAN MAGIC AI STUDIO â€” CSS ========================== */
        /* ================================================================ */
        #ai-lab.magic-studio {
            background: linear-gradient(160deg, #1a0000 0%, #2d0a00 40%, #1a0000 100%);
            border: 3px solid var(--emperor-gold);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 60px rgba(255,215,0,0.15), inset 0 0 80px rgba(139,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        #ai-lab.magic-studio::before {
            content: '';
            position: absolute; inset: 0;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255,215,0,0.018) 50px, rgba(255,215,0,0.018) 51px),
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255,215,0,0.012) 50px, rgba(255,215,0,0.012) 51px);
            pointer-events: none;
        }
        .magic-studio-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.3rem, 4vw, 2rem);
            font-weight: 900;
            color: var(--emperor-gold);
            text-shadow: 0 0 20px rgba(255,215,0,0.6), 2px 2px 0 rgba(139,0,0,0.5);
            letter-spacing: 3px;
            text-align: center;
            margin-bottom: 6px;
        }
        .magic-studio-subtitle {
            text-align: center;
            color: rgba(255,215,0,0.5);
            font-size: 11px;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 28px;
            font-family: monospace;
        }

        /* Engine & config selects */
        .magic-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px;
        }
        @media (max-width: 600px) { .magic-config-grid { grid-template-columns: 1fr; } }
        .magic-config-group {
            background: rgba(255,215,0,0.04);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 10px;
            padding: 14px;
        }
        .magic-config-label {
            font-family: monospace;
            font-size: 9px;
            letter-spacing: 3px;
            color: rgba(255,215,0,0.6);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }
        .magic-select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            color: var(--emperor-gold);
            font-size: 13px;
            font-weight: 700;
            outline: none;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'Cormorant Garamond', serif;
        }
        .magic-select:focus { border-color: var(--emperor-gold); box-shadow: 0 0 10px rgba(255,215,0,0.25); }
        .magic-select option { background: #1a0000; }

        /* Prompt area */
        .magic-prompt-area {
            background: rgba(255,215,0,0.03);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .magic-prompt-area::before {
            content: '// DESCRIBE YOUR IMAGINATION';
            position: absolute;
            top: -10px; left: 15px;
            background: #1a0000;
            color: rgba(255,215,0,0.5);
            font-size: 10px;
            font-family: monospace;
            padding: 0 8px;
            letter-spacing: 2px;
        }
        .magic-textarea {
            width: 100%; min-height: 110px;
            background: transparent; border: none;
            color: #ffeeba;
            font-size: 15px;
            font-family: 'Cormorant Garamond', serif;
            outline: none; resize: vertical; line-height: 1.7;
        }
        .magic-textarea::placeholder { color: rgba(255,215,0,0.25); font-style: italic; }

        /* Generate button */
        .magic-generate-btn {
            width: 100%; padding: 20px;
            background: linear-gradient(135deg, #8B0000, #C41E3A, #8B0000);
            color: var(--emperor-gold);
            border: 3px solid var(--emperor-gold);
            border-radius: 14px;
            font-size: 18px; font-weight: 900;
            cursor: pointer; transition: 0.3s;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Playfair Display', serif;
            box-shadow: 0 0 30px rgba(255,215,0,0.2);
            position: relative; overflow: hidden;
        }
        .magic-generate-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(255,215,0,0.4); }
        .magic-generate-btn:disabled { background: #333; color: #666; border-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Loading Screen */
        #magicLoadingScreen {
            display: none;
            background: rgba(10,0,0,0.98);
            border: 2px solid var(--emperor-gold);
            border-radius: 14px;
            padding: 40px 24px;
            text-align: center;
            margin: 20px 0;
        }
        .magic-progress-bar-bg {
            height: 16px;
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        .magic-progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--imperial-red), var(--emperor-gold));
            border-radius: 8px;
            transition: width 0.5s ease;
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }
        .magic-terminal-text {
            font-family: monospace;
            font-size: 13px;
            color: #00ff88;
            text-align: left;
            background: rgba(0,255,100,0.04);
            border: 1px solid rgba(0,255,100,0.15);
            border-radius: 8px;
            padding: 14px;
            min-height: 80px;
        }
        .magic-terminal-text .t-cursor { animation: blink 0.8s infinite; display: inline-block; }

        /* Video Result */
        #magicVideoResult {
            display: none;
            margin-top: 20px;
        }
        .magic-video-wrapper {
            position: relative;
            padding-top: 56.25%;
            background: #000;
            border-radius: 14px;
            overflow: hidden;
            border: 3px solid var(--emperor-gold);
            box-shadow: 0 0 40px rgba(255,215,0,0.2);
        }
        .magic-video-wrapper iframe {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            border: none;
            pointer-events: none;
        }
        .magic-watermark {
            position: absolute;
            bottom: 14px; right: 14px;
            background: rgba(0,0,0,0.72);
            color: var(--emperor-gold);
            font-size: 10px;
            font-family: monospace;
            padding: 4px 10px;
            border-radius: 4px;
            letter-spacing: 1px;
            border: 1px solid rgba(255,215,0,0.3);
            pointer-events: none;
            z-index: 10;
        }
        .magic-result-info {
            background: rgba(255,215,0,0.05);
            border: 1px solid rgba(255,215,0,0.15);
            border-radius: 10px;
            padding: 16px;
            margin-top: 14px;
            font-family: monospace;
            font-size: 12px;
            color: rgba(255,215,0,0.7);
        }
        .magic-download-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, #006400, #008000);
            color: #fff;
            border: 2px solid #00a000;
            border-radius: 12px;
            font-size: 16px; font-weight: 900;
            cursor: pointer; transition: 0.3s;
            letter-spacing: 2px;
            margin-top: 14px;
            font-family: 'Playfair Display', serif;
        }
        .magic-download-btn:hover { transform: scale(1.02); box-shadow: 0 6px 25px rgba(0,200,0,0.3); }

        /* ================================================================ */
        /* ======= CINEMATIC INTRO SCREEN ================================= */
        /* ================================================================ */
        #cinematicIntro {
            position: fixed; inset: 0; z-index: 999999;
            background: #000;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
            transition: opacity 0.8s ease;
        }
        #cinematicIntro.fade-out { opacity: 0; pointer-events: none; }
        .intro-ink-ring {
            width: 220px; height: 220px; border-radius: 50%;
            border: 4px solid transparent;
            position: relative;
            animation: inkExpand 1.2s cubic-bezier(0.25,0.46,0.45,0.94) forwards;
        }
        @keyframes inkExpand {
            0%  { transform: scale(0); border-color: rgba(139,0,0,0); box-shadow: none; }
            60% { transform: scale(1.1); border-color: var(--imperial-red); box-shadow: 0 0 60px rgba(139,0,0,0.8), inset 0 0 60px rgba(139,0,0,0.3); }
            100%{ transform: scale(1); border-color: var(--emperor-gold); box-shadow: 0 0 40px rgba(255,215,0,0.6), inset 0 0 40px rgba(255,215,0,0.1); }
        }
        .intro-wang {
            position: absolute; font-family: 'Ma Shan Zheng', cursive;
            font-size: 120px; color: transparent;
            animation: inkWrite 1.5s 0.5s ease forwards;
            line-height: 1;
        }
        @keyframes inkWrite {
            0%  { color: transparent; text-shadow: none; transform: scale(0.5); }
            100%{ color: var(--imperial-red); text-shadow: 0 0 30px rgba(255,215,0,0.8), 4px 4px 0 var(--emperor-gold); transform: scale(1); }
        }
        .intro-title {
            font-family: 'Cormorant Garamond', serif;
            color: transparent; font-size: 1.4rem; letter-spacing: 8px;
            font-weight: 700; margin-top: 30px;
            animation: fadeInGold 1s 1.2s ease forwards;
        }
        .intro-subtitle {
            color: transparent; font-size: 0.75rem; letter-spacing: 5px;
            font-family: monospace; margin-top: 8px;
            animation: fadeInGold 1s 1.6s ease forwards;
        }
        @keyframes fadeInGold {
            to { color: var(--emperor-gold); text-shadow: 0 0 20px rgba(255,215,0,0.5); }
        }
        .intro-progress-bar {
            width: 200px; height: 3px;
            background: rgba(255,215,0,0.15);
            border-radius: 2px; margin-top: 40px; overflow: hidden;
            animation: fadeInGold 0.5s 0.3s ease forwards; opacity: 0;
        }
        .intro-progress-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--imperial-red), var(--emperor-gold));
            animation: loadProgress 2.5s 0.3s ease forwards;
        }
        @keyframes loadProgress { to { width: 100%; } }

        /* ================================================================ */
        /* ======= DRAGON CURSOR TRAIL ==================================== */
        /* ================================================================ */
        #dragonCanvas {
            position: fixed; inset: 0; z-index: 9998;
            pointer-events: none;
        }

        /* ================================================================ */
        /* ======= INK SPLASH TAB TRANSITION ============================== */
        /* ================================================================ */
        #inkSplash {
            position: fixed; inset: 0; z-index: 99998;
            pointer-events: none; display: none;
        }
        .ink-circle {
            position: absolute; border-radius: 50%;
            background: radial-gradient(circle, rgba(20,0,0,0.95) 0%, rgba(0,0,0,0.98) 60%, transparent 100%);
            transform: scale(0); transform-origin: center;
            animation: inkBurst 0.5s cubic-bezier(0.36,0.07,0.19,0.97) forwards;
        }
        @keyframes inkBurst {
            0%  { transform: scale(0); opacity: 1; }
            60% { transform: scale(8); opacity: 0.95; }
            100%{ transform: scale(16); opacity: 0; }
        }

        /* ================================================================ */
        /* ======= ANGPAO RAIN EVENT ====================================== */
        /* ================================================================ */
        .rain-angpao {
            position: fixed; z-index: 99000; font-size: 2.5rem;
            cursor: pointer; pointer-events: all;
            animation: angpaoFall linear forwards;
            filter: drop-shadow(0 4px 12px rgba(139,0,0,0.8));
            transition: transform 0.1s;
            user-select: none;
        }
        .rain-angpao:hover { transform: scale(1.3) rotate(10deg) !important; }
        @keyframes angpaoFall {
            0%  { top: -80px; opacity: 1; }
            90% { opacity: 1; }
            100%{ top: 105vh; opacity: 0; }
        }
        #angpaoEventBanner {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 98000;
            background: linear-gradient(135deg, #8B0000, #C41E3A, #8B0000);
            color: var(--emperor-gold); text-align: center;
            padding: 10px 20px; font-weight: 900; font-size: 14px;
            letter-spacing: 2px; border-bottom: 3px solid var(--emperor-gold);
            box-shadow: 0 4px 20px rgba(139,0,0,0.6);
            transform: translateY(-100%); transition: transform 0.5s ease;
            font-family: 'Playfair Display', serif;
        }
        #angpaoEventBanner.show { transform: translateY(0); }

        /* ================================================================ */
        /* ======= DAILY FORTUNE POPUP ==================================== */
        /* ================================================================ */
        #fortuneOverlay {
            position: fixed; inset: 0; z-index: 97000;
            background: rgba(0,0,0,0.85); display: none;
            align-items: center; justify-content: center;
        }
        #fortuneOverlay.show { display: flex; }
        .fortune-scroll {
            background: linear-gradient(145deg, #fdf3d0, #f5e0b0);
            border: 5px double var(--imperial-red);
            border-radius: 20px; padding: 40px 36px;
            max-width: 460px; width: 92%;
            box-shadow: 0 0 0 3px var(--emperor-gold), 0 20px 60px rgba(0,0,0,0.5);
            text-align: center; position: relative;
            animation: scrollUnfurl 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards;
        }
        @keyframes scrollUnfurl {
            0%  { transform: scaleY(0); opacity: 0; }
            100%{ transform: scaleY(1); opacity: 1; }
        }
        .fortune-scroll::before {
            content: '';
            position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
            border: 1px solid rgba(139,0,0,0.2); border-radius: 14px;
            pointer-events: none;
        }
        .fortune-chengyu {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem; color: var(--imperial-red);
            text-shadow: 2px 2px 0 var(--emperor-gold);
            margin-bottom: 8px;
        }
        .fortune-pinyin { color: #8B4513; font-weight: 700; letter-spacing: 3px; margin-bottom: 16px; font-size: 0.9rem; }
        .fortune-meaning { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: #3a1a00; line-height: 1.6; margin-bottom: 20px; }
        .fortune-prediction {
            background: linear-gradient(135deg, var(--imperial-red), #8B0000);
            color: var(--emperor-gold); border-radius: 12px;
            padding: 14px 20px; font-size: 0.9rem; line-height: 1.6;
            font-weight: 700; margin-bottom: 20px;
        }
        .fortune-lucky { font-size: 0.8rem; color: #8B4513; margin-bottom: 20px; letter-spacing: 2px; }
        .fortune-close-btn {
            background: linear-gradient(135deg, var(--imperial-red), #C41E3A);
            color: var(--emperor-gold); border: 2px solid var(--emperor-gold);
            border-radius: 10px; padding: 12px 28px;
            font-weight: 900; cursor: pointer; font-size: 14px;
            transition: 0.2s; letter-spacing: 2px; margin: 4px;
        }
        .fortune-close-btn:hover { transform: scale(1.05); }
        .fortune-share-btn {
            background: linear-gradient(135deg, #004d00, #006400);
            color: #fff; border: 2px solid #00a000;
            border-radius: 10px; padding: 12px 28px;
            font-weight: 900; cursor: pointer; font-size: 14px;
            transition: 0.2s; letter-spacing: 2px; margin: 4px;
        }
        .fortune-share-btn:hover { transform: scale(1.05); }

        /* ================================================================ */
        /* ======= FLASH SALE TIMER (STORE) =============================== */
        /* ================================================================ */
        #flashSaleBar {
            background: linear-gradient(135deg, #1a0000, #2d0000);
            border: 2px solid var(--emperor-gold);
            border-radius: 12px; padding: 14px 20px;
            margin-bottom: 20px; display: flex;
            align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 10px;
        }
        .flash-sale-label {
            font-family: 'Playfair Display', serif;
            color: var(--emperor-gold); font-size: 15px; font-weight: 900;
            letter-spacing: 2px;
        }
        .flash-timer-digits {
            display: flex; gap: 6px; align-items: center;
        }
        .flash-digit {
            background: var(--imperial-red); color: var(--emperor-gold);
            border-radius: 6px; padding: 6px 12px;
            font-size: 1.4rem; font-weight: 900; font-family: monospace;
            box-shadow: 0 3px 10px rgba(139,0,0,0.5);
            min-width: 48px; text-align: center;
        }
        .flash-sep { color: var(--emperor-gold); font-size: 1.4rem; font-weight: 900; }

        /* ================================================================ */
        /* ======= VIRAL SHARE CARD MODAL ================================= */
        /* ================================================================ */
        #shareCardOverlay {
            position: fixed; inset: 0; z-index: 96000;
            background: rgba(0,0,0,0.88); display: none;
            align-items: center; justify-content: center;
        }
        #shareCardOverlay.show { display: flex; }
        .share-card-modal {
            background: #1a0000; border: 3px solid var(--emperor-gold);
            border-radius: 20px; padding: 28px;
            max-width: 460px; width: 92%; text-align: center;
        }
        #shareCardCanvas {
            border-radius: 12px; max-width: 100%;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .share-close-btn {
            background: var(--imperial-red); color: var(--emperor-gold);
            border: 2px solid var(--emperor-gold); border-radius: 10px;
            padding: 12px 24px; font-weight: 900; cursor: pointer;
            margin: 8px; transition: 0.2s; letter-spacing: 1px;
        }
        .share-dl-btn {
            background: linear-gradient(135deg, #004d00, #006400);
            color: #fff; border: 2px solid #00a000; border-radius: 10px;
            padding: 12px 24px; font-weight: 900; cursor: pointer;
            margin: 8px; transition: 0.2s; letter-spacing: 1px;
        }
        .share-dl-btn:hover, .share-close-btn:hover { transform: scale(1.04); }

        /* ================================================================ */
        /* ======= CHARACTER PUZZLE MINI GAME ============================= */
        /* ================================================================ */
        #puzzleOverlay {
            position: fixed; inset: 0; z-index: 95000;
            background: rgba(0,0,0,0.9); display: none;
            align-items: center; justify-content: center;
        }
        #puzzleOverlay.show { display: flex; }
        .puzzle-modal {
            background: linear-gradient(145deg, #1a0000, #2d0a00);
            border: 4px double var(--emperor-gold);
            border-radius: 20px; padding: 32px;
            max-width: 500px; width: 92%; text-align: center;
            box-shadow: 0 0 60px rgba(255,215,0,0.2);
        }
        .puzzle-title { font-family: 'Playfair Display', serif; color: var(--emperor-gold); font-size: 1.5rem; font-weight: 900; margin-bottom: 6px; }
        .puzzle-timer-display { font-size: 2rem; font-weight: 900; font-family: monospace; color: #fff; margin: 10px 0; }
        .puzzle-timer-display.danger { color: #f87171; animation: pulse 0.5s infinite; }
        .puzzle-char-target { font-family: 'Ma Shan Zheng', cursive; font-size: 6rem; color: var(--imperial-red); text-shadow: 3px 3px 0 var(--emperor-gold); margin: 16px 0; }
        .puzzle-pieces-area { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 16px 0; min-height: 80px; padding: 14px; background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.15); border-radius: 10px; }
        .puzzle-drop-area { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0; min-height: 80px; padding: 14px; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,215,0,0.4); border-radius: 10px; }
        .puzzle-piece {
            font-family: 'Ma Shan Zheng', cursive; font-size: 2.2rem;
            background: var(--imperial-red); color: var(--emperor-gold);
            padding: 10px 16px; border-radius: 10px;
            cursor: grab; border: 2px solid var(--emperor-gold);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: 0.2s; user-select: none;
        }
        .puzzle-piece:hover { transform: scale(1.15) rotate(-3deg); background: #C41E3A; }
        .puzzle-piece.dropped { background: #006400; border-color: #00a000; cursor: default; }
        .puzzle-start-btn, .puzzle-close-btn {
            padding: 12px 28px; border-radius: 12px; font-weight: 900;
            cursor: pointer; margin: 6px; font-size: 15px; transition: 0.2s;
            letter-spacing: 1px;
        }
        .puzzle-start-btn { background: linear-gradient(135deg, var(--imperial-red), #C41E3A); color: var(--emperor-gold); border: 2px solid var(--emperor-gold); }
        .puzzle-close-btn { background: #333; color: #aaa; border: 2px solid #555; }
        .puzzle-start-btn:hover { transform: scale(1.05); }

        /* ================================================================ */
        /* ======= DEBUG PANEL ============================================ */
        /* ================================================================ */
        #debugPanel {
            position: fixed; bottom: 140px; left: 16px;
            z-index: 99997; background: rgba(0,0,0,0.97);
            border: 2px solid #00ff88; border-radius: 14px;
            padding: 20px; min-width: 280px;
            font-family: monospace; font-size: 12px; color: #00ff88;
            display: none; box-shadow: 0 0 40px rgba(0,255,100,0.2);
        }
        #debugPanel h4 { color: #ffd700; font-size: 14px; margin-bottom: 14px; letter-spacing: 2px; }
        .debug-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .debug-row input { background: rgba(0,255,100,0.1); border: 1px solid #00ff88; color: #00ff88; border-radius: 4px; padding: 4px 8px; width: 80px; font-family: monospace; outline: none; }
        .debug-btn { background: #00ff88; color: #000; border: none; border-radius: 4px; padding: 4px 10px; font-weight: 900; cursor: pointer; font-size: 11px; }

        /* ================================================================ */
        /* ======= CHANGELOG POPUP ======================================== */
        /* ================================================================ */
        #changelogOverlay {
            position: fixed; inset: 0; z-index: 94000;
            background: rgba(0,0,0,0.8); display: none;
            align-items: center; justify-content: center;
        }
        #changelogOverlay.show { display: flex; }
        .changelog-modal {
            background: linear-gradient(145deg, #fff8e7, #f5e6d3);
            border: 4px double var(--imperial-red);
            border-radius: 20px; padding: 32px;
            max-width: 480px; width: 92%;
            box-shadow: 0 0 0 3px var(--emperor-gold), 0 20px 60px rgba(0,0,0,0.5);
            position: relative;
        }
        .changelog-badge {
            background: var(--imperial-red); color: var(--emperor-gold);
            font-size: 10px; font-weight: 900; letter-spacing: 2px;
            padding: 4px 12px; border-radius: 20px; display: inline-block;
            margin-bottom: 12px;
        }
        .changelog-item { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; font-size: 13px; }
        .changelog-icon { font-size: 18px; line-height: 1.4; }
        .changelog-text { color: #3a1a00; line-height: 1.5; }
        .changelog-close { background: linear-gradient(135deg, var(--imperial-red), #C41E3A); color: var(--emperor-gold); border: 2px solid var(--emperor-gold); border-radius: 10px; padding: 12px 32px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 16px; font-size: 15px; letter-spacing: 2px; transition: 0.2s; }
        .changelog-close:hover { transform: translateY(-2px); }

        /* ================================================================ */
        /* ======= LANDSCAPE WARNING ====================================== */
        /* ================================================================ */
        #landscapeWarn {
            display: none; position: fixed; inset: 0; z-index: 999998;
            background: #1a0000;
            align-items: center; justify-content: center;
            flex-direction: column; text-align: center; padding: 40px;
        }
        #landscapeWarn .lw-icon { font-size: 5rem; animation: rotateHint 2s ease-in-out infinite; }
        @keyframes rotateHint { 0%,100%{transform:rotate(0)} 50%{transform:rotate(-90deg)} }
        #landscapeWarn h2 { font-family: 'Playfair Display', serif; color: var(--emperor-gold); font-size: 1.5rem; margin: 20px 0 10px; }
        #landscapeWarn p { color: rgba(255,215,0,0.6); font-size: 0.9rem; }

        /* ================================================================ */
        /* ======= OFFLINE BANNER ========================================= */
        /* ================================================================ */
        #offlineBanner {
            position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%);
            z-index: 99996; background: #1a1a1a; color: #f87171;
            border: 2px solid #f87171; border-radius: 30px;
            padding: 10px 24px; font-size: 13px; font-weight: 900;
            letter-spacing: 1px; box-shadow: 0 4px 20px rgba(248,113,113,0.3);
            display: none; white-space: nowrap;
        }
        #offlineBanner.show { display: block; }

        /* ================================================================ */
        /* ======= RENDER STATS (POST VIDEO) ============================== */
        /* ================================================================ */
        .render-stats-box {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 10px; padding: 14px 18px;
            font-family: monospace; font-size: 11px;
            color: rgba(255,215,0,0.5);
            margin-top: 10px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
        }
        .rs-item { display: flex; justify-content: space-between; }
        .rs-val { color: #00ff88; }

        /* ================================================================ */
        /* ======= STREAK FREEZE ITEM IN STORE ============================ */
        /* ================================================================ */
        .streak-freeze-card {
            background: linear-gradient(145deg, #001a33, #002244);
            border: 2px solid #00a8ff;
            border-radius: 16px; padding: 22px;
            text-align: center; transition: 0.3s; cursor: pointer;
        }
        .streak-freeze-card:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,168,255,0.2); }
        .sf-icon { font-size: 3rem; margin-bottom: 8px; display: block; }
        .sf-name { color: #00a8ff; font-weight: 900; font-size: 15px; margin-bottom: 4px; }
        .sf-desc { color: #888; font-size: 11px; margin-bottom: 14px; }
        .sf-price { color: var(--emperor-gold); font-size: 1.4rem; font-weight: 900; font-family: monospace; }
        .sf-owned { background: rgba(0,168,255,0.1); color: #00a8ff; font-size: 11px; margin-top: 6px; }

        /* ================================================================ */
        /* ======= THEME VARS MORNING/NIGHT =============================== */
        /* ================================================================ */
        body.theme-morning { --rice-paper: #fff8f0; }
        body.theme-noon    { --rice-paper: #FDF6E3; }
        body.theme-night   { --rice-paper: #1a0a00; color: #f0d5b0; }
        body.theme-night .glass-scroll { background: rgba(30,10,0,0.95); }
        body.theme-night .stat-card { background: #1a0a00; border-color: var(--emperor-gold); }
        body.theme-night .learning-container { background: #1a0a00; color: #f0d5b0; }
        body.theme-night .vocab-card { background: #1a0a00; color: #f0d5b0; }

        /* Theme toggle button */
        #themeToggleBtn {
            position: fixed; top: 80px; right: 16px; z-index: 4999;
            background: linear-gradient(135deg, #1a0000, #2d0a00);
            border: 2px solid var(--emperor-gold);
            border-radius: 50%; width: 42px; height: 42px;
            color: var(--emperor-gold); font-size: 18px;
            cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(139,0,0,0.4);
        }
        #themeToggleBtn:hover { transform: scale(1.1) rotate(20deg); }

        /* ================================================================ */
        /* ======= PAGE TITLE BLINK ======================================= */
        /* ================================================================ */
        /* handled in JS only */

        /* ================================================================ */
        /* ======= NAV ACTIVE IMPROVEMENT ================================= */
        /* ================================================================ */
        .nav-active-glow { box-shadow: 0 0 20px rgba(255,215,0,0.5) !important; }

        /* ================================================================ */
        /* ======= GENERAL POLISH ======================================== */
        /* ================================================================ */
        ::selection { background: var(--imperial-red); color: var(--emperor-gold); }
        * { box-sizing: border-box; }
        @media (max-width: 480px) {
            .lantern { font-size: 2rem; }
            .wang-character { font-size: 70px; }
            .imperial-frame-outer { width: 120px; height: 120px; }
            .dragon-left { left: -40px; }
            .dragon-right { right: -40px; }
        }

    </style>
</head>
<body>

    <!-- ================================================================ -->
    <!-- ======= CINEMATIC INTRO ======================================== -->
    <!-- ================================================================ -->
    <div id="cinematicIntro">
        <div class="intro-ink-ring">
            <div class="intro-wang">æ±ª</div>
        </div>
        <div class="intro-title">WANG DYNASTY</div>
        <div class="intro-subtitle">SULTAN OMNIVERSE v4.0 â€¢ LOADING...</div>
        <div class="intro-progress-bar"><div class="intro-progress-fill"></div></div>
    </div>

    <!-- Dragon cursor trail canvas -->
    <canvas id="dragonCanvas"></canvas>

    <!-- Ink splash transition overlay -->
    <div id="inkSplash"></div>

    <!-- Offline banner -->
    <div id="offlineBanner">ðŸ“¡ OFFLINE â€” Koneksi terputus bos!</div>

    <!-- Landscape warning (mobile) -->
    <div id="landscapeWarn">
        <div class="lw-icon">ðŸ“±</div>
        <h2>Putar ke Portrait</h2>
        <p>Istana Digital Wang Dynasty<br>paling indah dilihat dalam mode Portrait ðŸ®</p>
    </div>

    <!-- Angpao event banner -->
    <div id="angpaoEventBanner">
        ðŸ§§ JAM HOKI SULTAN! KLIK ANGPAO YANG JATUH UNTUK KLAIM XP! ðŸ§§
    </div>

    <!-- Theme toggle -->
    <button id="themeToggleBtn" onclick="cycleTheme()" title="Ganti Tema">ðŸŒ…</button>

    <!-- ================================================================ -->
    <!-- ======= FORTUNE POPUP ========================================== -->
    <!-- ================================================================ -->
    <div id="fortuneOverlay" onclick="if(event.target===this)closeFortune()">
        <div class="fortune-scroll">
            <div style="font-family:'Ma Shan Zheng',cursive; font-size:0.85rem; color:var(--imperial-red); letter-spacing:4px; margin-bottom:16px;">âœ¦ ä»Šæ—¥è¿åŠ¿ âœ¦</div>
            <div class="fortune-chengyu" id="fortuneChengyu">é¾™é©¬ç²¾ç¥ž</div>
            <div class="fortune-pinyin" id="fortunePinyin">lÃ³ng mÇŽ jÄ«ng shÃ©n</div>
            <div class="fortune-meaning" id="fortuneMeaning">Semangat kuda naga â€” penuh tenaga dan vitalitas yang tak terbendung</div>
            <div class="fortune-prediction" id="fortunePrediction">ðŸ”® Hari ini energimu meluap-luap! Proyek yang terbengkalai akan menemukan momentum baru. Angka hoki 8 & 88 menyertaimu.</div>
            <div class="fortune-lucky" id="fortuneLucky">ðŸŽ¨ Warna Hoki: Merah Kerajaan â€¢ ðŸ”¢ Angka: 8, 18, 88 â€¢ â° Jam Hoki: 08:08</div>
            <div>
                <button class="fortune-close-btn" onclick="closeFortune()">ðŸ® Terima Nasib</button>
                <button class="fortune-share-btn" onclick="shareFortuneCard()">ðŸ“¸ Bagikan</button>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ======= SHARE CARD MODAL ======================================= -->
    <!-- ================================================================ -->
    <div id="shareCardOverlay" onclick="if(event.target===this)closeShareCard()">
        <div class="share-card-modal">
            <div style="color:var(--emperor-gold); font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:900; margin-bottom:16px; letter-spacing:2px;">ðŸ“¸ KARTU BERBAGI</div>
            <canvas id="shareCardCanvas" width="400" height="560"></canvas>
            <div style="margin-top:14px;">
                <button class="share-dl-btn" onclick="downloadShareCard()">â¬‡ï¸ Download PNG</button>
                <button class="share-close-btn" onclick="closeShareCard()">âœ• Tutup</button>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ======= CHARACTER PUZZLE OVERLAY =============================== -->
    <!-- ================================================================ -->
    <div id="puzzleOverlay" onclick="if(event.target===this)closePuzzle()">
        <div class="puzzle-modal">
            <div class="puzzle-title">ðŸ§© CHARACTER PUZZLE</div>
            <div style="color:rgba(255,215,0,0.5); font-size:11px; letter-spacing:3px; margin-bottom:16px;">SUSUN KARAKTER YANG BENAR DALAM 30 DETIK!</div>
            <div id="puzzleTimerDisplay" class="puzzle-timer-display">30</div>
            <div style="color:rgba(255,215,0,0.6); font-size:12px; margin-bottom:6px; font-family:monospace;">TARGET:</div>
            <div class="puzzle-char-target" id="puzzleTarget">æ±ª</div>
            <div style="color:rgba(255,215,0,0.6); font-size:11px; margin-bottom:6px; font-family:monospace;">PILIH RADIKAL YANG BENAR:</div>
            <div class="puzzle-pieces-area" id="puzzlePieces"></div>
            <div style="color:rgba(255,215,0,0.6); font-size:11px; margin-bottom:6px; font-family:monospace;">JAWABAN KAMU:</div>
            <div class="puzzle-drop-area" id="puzzleAnswer"></div>
            <div id="puzzleResult" style="font-weight:900; font-size:1.2rem; min-height:30px; margin:10px 0;"></div>
            <div>
                <button class="puzzle-start-btn" id="puzzleStartBtn" onclick="startPuzzle()">ðŸŽ® MAIN SEKARANG</button>
                <button class="puzzle-close-btn" onclick="closePuzzle()">âœ• Tutup</button>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ======= CHANGELOG POPUP ======================================== -->
    <!-- ================================================================ -->
    <div id="changelogOverlay" onclick="if(event.target===this)closeChangelog()">
        <div class="changelog-modal">
            <div style="text-align:center; margin-bottom:16px;">
                <div class="changelog-badge">ðŸ†• WANG DYNASTY v4.0 UPDATE</div>
                <div style="font-family:'Playfair Display',serif; font-size:1.4rem; font-weight:900; color:var(--imperial-red);">æ±ª Sultan Omniverse</div>
                <div style="font-size:11px; color:#888; margin-top:4px; letter-spacing:2px;">SUPER CANGGIH EDITION</div>
            </div>
            <div class="changelog-item"><span class="changelog-icon">ðŸŽ¬</span><span class="changelog-text"><strong>Cinematic Intro</strong> â€” Layar pembuka animasi tinta seperti film ðŸ‰</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸ‰</span><span class="changelog-text"><strong>Dragon Cursor Trail</strong> â€” Jejak partikel emas mengikuti mouse/finger</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸ§§</span><span class="changelog-text"><strong>Angpao Rain Event</strong> â€” Hujan angpao di jam hoki! Klik untuk klaim XP</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸ”®</span><span class="changelog-text"><strong>Daily Fortune</strong> â€” Ramalan æˆè¯­ harianmu + angka hoki</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸ§©</span><span class="changelog-text"><strong>Character Puzzle</strong> â€” Game susun radikal karakter Mandarin</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸª„</span><span class="changelog-text"><strong>Magic AI Studio</strong> â€” Generate video AI dengan YouTube Engine</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸŒ…</span><span class="changelog-text"><strong>Dynamic Theme</strong> â€” Tema berubah otomatis pagi/siang/malam</span></div>
            <div class="changelog-item"><span class="changelog-icon">ðŸ“¸</span><span class="changelog-text"><strong>Share Card Generator</strong> â€” Buat kartu hasil quiz untuk IG/WA</span></div>
            <button class="changelog-close" onclick="closeChangelog()">ðŸ® MASUKI ISTANA DIGITAL ðŸ®</button>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ======= DEBUG PANEL ============================================ -->
    <!-- ================================================================ -->
    <div id="debugPanel">
        <h4>âš™ï¸ DEBUG PANEL â€” SULTAN EYES ONLY</h4>
        <div class="debug-row"><span>Set XP:</span><input type="number" id="dbXP" value="100"><button class="debug-btn" onclick="dbSetXP()">SET</button></div>
        <div class="debug-row"><span>Set Saldo:</span><input type="number" id="dbSaldo" value="1000000"><button class="debug-btn" onclick="dbSetSaldo()">SET</button></div>
        <div class="debug-row"><span>Streak Freeze:</span><span id="dbFreezeCount" style="color:#ffd700;">0</span><button class="debug-btn" onclick="dbAddFreeze()">+1</button></div>
        <div class="debug-row"><span>Trigger Fortune:</span><button class="debug-btn" onclick="openFortune()">OPEN</button></div>
        <div class="debug-row"><span>Trigger Angpao:</span><button class="debug-btn" onclick="triggerAngpaoRain()">RAIN</button></div>
        <div class="debug-row"><span>Open Puzzle:</span><button class="debug-btn" onclick="openPuzzle()">PLAY</button></div>
        <div class="debug-row" style="margin-top:10px; padding-top:10px; border-top:1px solid #00ff88;">
            <span style="color:#f87171;">RESET ALL DATA:</span>
            <button class="debug-btn" style="background:#f87171;" onclick="if(confirm('Reset semua data?')){localStorage.clear();location.reload();}">RESET</button>
        </div>
    </div>

    <div id="particle-container"></div>
    <div id="achievementContainer"></div>
    <div id="labToast">âœ… PROMPT DISALIN! MEMBUKA AI...</div>
    <div id="storeToast">âœ… Membuka halaman resmi...</div>

    <!-- PAYMENT LOADING OVERLAY -->
    <div id="paymentLoadingOverlay">
        <div style="transform-style:preserve-3d;">
            <div class="lo-spinner">ðŸ’°</div>
        </div>
        <div class="lo-title">ðŸ”„ Menghubungkan ke Server Pembayaran</div>
        <div class="lo-sub">Menyiapkan sesi aman & menyalin nomor...</div>
        <div class="lo-dots">â€¢ â€¢ â€¢</div>
    </div>

    <!-- ANGPAO WIDGET -->
    <div id="angpaoWidget">
        <div class="aw-label">ðŸ’° SALDO ANGPAO</div>
        <div class="aw-saldo" id="angpaoSaldoDisplay">Rp 0</div>
        <button class="aw-btn" onclick="bukaModalTarik()" id="tarikBtn">ðŸ§ Tarik Cuan</button>
    </div>

    <!-- MODAL ANGPAO -->
    <div id="modalTarik" class="sultan-modal-overlay" style="display:none;">
        <div class="sultan-modal">
            <span class="close-modal" onclick="tutupModalTarik()">âœ•</span>
            <h3>ðŸ§§ TARIK ANGPAO SULTAN</h3>
            <div class="saldo-info-modal">
                <div style="font-size:11px; font-weight:900; letter-spacing:2px;">SALDO TERSEDIA</div>
                <div style="font-size:28px; font-weight:900; font-family:monospace;" id="modalSaldoText">Rp 0</div>
            </div>
            <label>Platform Transfer</label>
            <select id="wdPlatform">
                <option value="DANA">ðŸ’³ DANA</option>
                <option value="OVO">ðŸ’œ OVO</option>
                <option value="GoPay">ðŸ’š GoPay</option>
                <option value="BRI">ðŸ¦ BRI</option>
                <option value="BCA">ðŸ¦ BCA</option>
            </select>
            <label>Nama Lengkap</label>
            <input type="text" id="wdNama" placeholder="Nama sesuai akun/rekening">
            <label>Nomor HP / Rekening</label>
            <input type="text" id="wdNomor" placeholder="08xxxxxxxxxx">
            <label>Nominal Tarik (min. Rp 1.000.000)</label>
            <input type="number" id="wdNominal" placeholder="1000000" min="1000000">
            <button class="submit-btn" onclick="submitTarik()">ðŸš€ KIRIM VIA WHATSAPP</button>
        </div>
    </div>

    <!-- CINEMA PLAYER MODAL -->
    <div id="cinemaPlayerModal" class="cinema-modal-overlay" style="display:none;">
        <div class="cinema-modal">
            <div class="cinema-close"><button onclick="tutupCinemaPlayer()">âœ• Tutup</button></div>
            <div class="iframe-wrap">
                <iframe id="cinemaIframe" src="" allowfullscreen allow="autoplay; encrypted-media"></iframe>
            </div>
            <div class="cinema-modal-body">
                <h3 id="cinemaPlayerTitle">Loading...</h3>
                <div id="cinemaComments"><div style="color:#888; font-size:13px;">Memuat komentar...</div></div>
                <div class="reward-btns">
                    <button class="reward-btn-xp" id="claimXpBtn" disabled onclick="claimVideoXP()">â³ Klaim 50 XP (10 detik...)</button>
                    <button class="reward-btn-dl" onclick="downloadVideo()">â¬‡ï¸ Download (Bypass)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KARAOKE MODAL -->
    <div id="karaokeModal" class="karaoke-modal" style="display:none;">
        <button onclick="closeKaraoke()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:30px; cursor:pointer; z-index:10;">âœ•</button>
        <!-- Song Title Display -->
        <div id="karaokeNowPlaying" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); color:var(--emperor-gold); font-family:'Ma Shan Zheng',cursive; font-size:1.1rem; text-shadow:0 0 15px rgba(255,215,0,0.7); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%; text-align:center;"></div>
        <div style="width: 80%; max-width: 600px; aspect-ratio: 16/9; border: 4px solid var(--emperor-gold); border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(255,215,0,0.5); margin-top:40px;">
            <iframe id="karaokeIframe" src="" style="width:100%; height:100%; border:none;" allow="autoplay"></iframe>
        </div>
        <div class="lyric-glow">BERNYANYILAH SANG SULTAN!</div>
        <button id="karaokeRewardBtn" disabled onclick="claimKaraokeXP()" class="mt-8 px-8 py-4 bg-red-600 text-white font-black text-xl rounded-full disabled:opacity-50 disabled:cursor-not-allowed transition hover:scale-105 border-4 border-yellow-500">
            â³ TUNGGU 30 DETIK...
        </button>
        <!-- XP Progress Bar -->
        <div style="width:80%; max-width:400px; margin-top:12px; background:rgba(255,255,255,0.1); border-radius:20px; height:8px; overflow:hidden;">
            <div id="karaokeXpBar" style="height:100%; width:0%; background:linear-gradient(90deg, var(--emperor-gold), var(--imperial-red)); border-radius:20px; transition:width 1s linear;"></div>
        </div>
        <div id="karaokeXpBarLabel" style="color:rgba(255,215,0,0.6); font-size:11px; margin-top:4px; font-family:monospace;">0 / 30 detik</div>
    </div>

    <!-- WANG DYNASTY IMPERIAL HEADER -->
    <header class="wang-dynasty-header text-center relative overflow-hidden z-10">
        <!-- Top ornamental bar -->
        <div class="dynasty-top-bar"></div>

        <!-- Lanterns decoration -->
        <div class="lantern lantern-left">ðŸ®</div>
        <div class="lantern lantern-right">ðŸ®</div>

        <!-- Imperial Emblem -->
        <div class="imperial-emblem-wrap">
            <!-- Outer octagonal frame -->
            <div class="imperial-frame-outer">
                <div class="imperial-frame-inner">
                    <!-- æ±ª character -->
                    <div class="wang-character">æ±ª</div>
                </div>
            </div>

            <!-- Dragon flourishes -->
            <div class="dragon-left">ðŸ‰</div>
            <div class="dragon-right">ðŸ‰</div>
        </div>

        <!-- Name block -->
        <div class="dynasty-name-block">
            <h1 class="wang-imperial-name">WANG WEIZE &amp; JANE BEATRIX</h1>
            <div class="dynasty-separator">
                <span class="sep-line"></span>
                <span class="sep-diamond">â—†</span>
                <span class="sep-line"></span>
            </div>

            <!-- Cultural ribbon tagline -->
            <div class="bloodline-ribbon">
                <span class="ribbon-text">
                    Shaanxi Bloodline <span class="flag-emoji">ðŸ‡¨ðŸ‡³</span>
                    <span class="ribbon-dot">â€¢</span>
                    Medan Soul <span class="flag-emoji">ðŸ‡®ðŸ‡©</span>
                </span>
            </div>
        </div>

        <!-- Calligraphy tagline -->
        <span class="imlek-calligraphy" style="margin-top:12px;">æ±ªæ°å®¶æ— â€¢ æ­å–œå‘è´¢</span>

        <!-- Stats row -->
        <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto px-4">
            <div class="stat-card"><div class="text-3xl font-black text-red-900" id="totalWords">0</div><div class="text-sm">Kata Dikuasai</div></div>
            <div class="stat-card"><div class="text-3xl font-black text-red-900" id="studyStreak">0</div><div class="text-sm">Hari Beruntun</div></div>
            <div class="stat-card"><div class="text-3xl font-black text-red-900" id="totalXP">0</div><div class="text-sm">Total XP</div></div>
            <div class="stat-card"><div class="level-badge" id="userLevel">Lv 1</div><div class="text-sm">Level Sultan</div></div>
        </div>

        <!-- Bottom ornamental bar -->
        <div class="dynasty-bottom-bar"></div>
    </header>

    <!-- NAV -->
    <nav class="fixed bottom-0 w-full z-40 flex justify-center gap-2 p-3 bg-[#1a1a1a] border-t-4 border-yellow-500 overflow-x-auto shadow-2xl whitespace-nowrap">
        <button onclick="tab('home')" id="n-home" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded active-nav shrink-0">Utama</button>
        <button onclick="tab('silsilah')" id="n-silsilah" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Silsilah</button>
        <button onclick="tab('dasar')" id="n-dasar" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Latihan Tulis</button>
        <button onclick="tab('kamus')" id="n-kamus" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Kamus ðŸŽ™ï¸</button>
        <button onclick="tab('flashcard')" id="n-flashcard" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Flashcard ðŸŽ´</button>
        <button onclick="tab('quiz')" id="n-quiz" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Quiz ðŸŽ¯</button>
        <button onclick="tab('ai-tutor')" id="n-ai-tutor" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">AI Tutor ðŸ¤–</button>
        <button onclick="tab('progress')" id="n-progress" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Progress ðŸ“Š</button>
        <button onclick="tab('cinema')" id="n-cinema" class="px-4 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0">Cinema ðŸŽ¥</button>
        <button onclick="tab('karaoke')" id="n-karaoke" class="px-3 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0 border-2 border-red-600">Karaoke ðŸŽ¤</button>
        <button onclick="tab('store')" id="n-store" class="px-3 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0 border-2 border-yellow-500">Store ðŸ›’</button>
        <button onclick="tab('ai-lab')" id="n-ai-lab" class="px-3 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0 border-2 border-cyan-400">AI Lab ðŸŽ¬</button>
        <button onclick="tab('ask-ai')" id="n-ask-ai" class="px-3 py-2 bg-white text-red-900 font-black text-xs rounded shrink-0 border-2 border-purple-500">Ask AI ðŸ¤–</button>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-10 relative z-10">

        <!-- HOME TAB -->
        <div id="home" class="tab-content text-center">
            <div class="glass-scroll p-12 space-y-8">
                <h2 class="text-4xl font-black text-red-900">KEKAISARAN MANDARIN - SULTAN OMNIVERSE</h2>
                <p class="text-lg font-bold opacity-80">Marga æ±ª Tunggal â€¢ 8 Tahun Sekolah di Shaanxi, China (2006-2014)</p>
                <div class="radar-box max-w-md mx-auto text-left">
                    <h3 class="text-green-400 font-bold border-b border-green-800 pb-2 mb-3 flex justify-between items-center">
                        <span>ðŸ“¡ SULTAN INTEL â€” RADAR LIVE</span>
                        <span id="radarLiveLabel" style="font-size:10px; background:#0f0; color:#000; padding:2px 8px; border-radius:10px; animation:radarSpin 0s; font-family:sans-serif; letter-spacing:1px;">â— LIVE</span>
                    </h3>
                    <div style="display:grid; gap:10px; font-size:13px;">
                        <!-- Ping -->
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,255,0,0.06); padding:8px 12px; border-radius:8px; border:1px solid rgba(0,255,0,0.15);">
                            <span style="color:#0f0;">ðŸ“¶ PING (Ms)</span>
                            <span id="radarPing" class="font-bold" style="color:#fff; font-family:monospace; font-size:16px;">-- ms</span>
                        </div>
                        <!-- Provider -->
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,255,0,0.06); padding:8px 12px; border-radius:8px; border:1px solid rgba(0,255,0,0.15);">
                            <span style="color:#0f0;">ðŸ”´ PROVIDER</span>
                            <span id="radarProvider" class="font-bold" style="color:#fff; font-family:monospace;">Deteksi...</span>
                        </div>
                        <!-- Device -->
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,255,0,0.06); padding:8px 12px; border-radius:8px; border:1px solid rgba(0,255,0,0.15);">
                            <span style="color:#0f0;">ðŸ’» PERANGKAT</span>
                            <span id="radarDevice" class="font-bold" style="color:#fff; font-family:monospace;">Deteksi...</span>
                        </div>
                        <!-- Status -->
                        <div style="padding:8px 12px; border-radius:8px; border:1px solid rgba(0,255,0,0.15); text-align:center;">
                            <div id="radarStatus" class="font-bold text-gray-500" style="font-size:13px;">Tekan tombol untuk cek sinyal</div>
                        </div>
                    </div>
                    <button onclick="checkSignal()" class="w-full mt-4 bg-green-900 hover:bg-green-700 text-green-100 py-2 rounded font-bold transition" style="letter-spacing:1px;">ðŸš€ CEK SINYAL SEKARANG</button>
                </div>
                <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-2xl border-2 border-purple-600 mt-6">
                    <h3 class="font-black text-purple-800 mb-4">ðŸš€ FITUR SULTAN OMNIVERSE:</h3>
                    <div class="grid md:grid-cols-3 gap-4 text-left">
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="tab('karaoke')"><div class="text-2xl mb-2">ðŸŽ¤</div><div class="font-bold">Karaoke Sultan</div><div class="text-sm text-gray-600">Nyanyi lagu Mandarin biar healing!</div></div>
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="tab('store')"><div class="text-2xl mb-2">ðŸ›’</div><div class="font-bold">Sultan Super Store</div><div class="text-sm text-gray-600">Top Up & Akun Premium murah cuan!</div></div>
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="tab('ai-lab')"><div class="text-2xl mb-2">ðŸŽ¬</div><div class="font-bold">Magic AI Studio</div><div class="text-sm text-gray-600">Generate video AI canggih!</div></div>
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="openFortune()"><div class="text-2xl mb-2">ðŸ”®</div><div class="font-bold">Ramalan Harian</div><div class="text-sm text-gray-600">Nasib & æˆè¯­ harianmu!</div></div>
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="openPuzzle()"><div class="text-2xl mb-2">ðŸ§©</div><div class="font-bold">Character Puzzle</div><div class="text-sm text-gray-600">Game susun radikal Mandarin!</div></div>
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition" onclick="tab('ask-ai')"><div class="text-2xl mb-2">ðŸ¤–</div><div class="font-bold">Sultan AI BYOK</div><div class="text-sm text-gray-600">Chat AI pakai key sendiri!</div></div>
                    </div>
                </div>
                <div class="bg-white/50 p-6 rounded-2xl border-2 border-yellow-600 mt-6">
                    <h3 class="font-black text-red-800 mb-4">HUBUNGI SANG SULTAN:</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                        <a href="https://wa.me/6288277200044" target="_blank" class="bg-green-600 text-white px-6 py-3 rounded-xl font-black shadow-lg hover:scale-105 transition">ðŸ“± WhatsApp</a>
                        <a href="https://www.tiktok.com/@wangweize10" target="_blank" class="bg-black text-white px-6 py-3 rounded-xl font-black shadow-lg hover:scale-105 transition">ðŸŽµ TikTok</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- SILSILAH TAB -->
        <div id="silsilah" class="tab-content hidden-tab animate-fade-in">
            <div class="profil-container p-10 text-center">
                <h2 class="text-4xl font-black text-red-900 mb-10" style="font-family: 'Playfair Display';">ðŸ‘‘ SILSILAH KELUARGA ðŸ‘‘</h2>
                <div class="flex flex-wrap justify-center gap-8">
                    <div class="kartu-generasi"><p class="text-red-900 font-black border-b border-yellow-500 mb-2">GENERASI 1</p><p class="text-sm font-bold">Kakek: Wang (Shaanxi é™•è¥¿)<br>Nenek: Wu (Hokkian)</p></div>
                    <div class="kartu-generasi"><p class="text-red-900 font-black border-b border-yellow-500 mb-2">GENERASI 2</p><p class="text-sm font-bold">Ayah: Wang (Shaanxi é™•è¥¿)<br>Ibu: Huang (Medan Hokkian)</p></div>
                    <div class="kartu-generasi" style="border-color: #D4AF37; background: #fffdf0;"><p class="text-red-900 font-black border-b border-yellow-500 mb-2">GENERASI 3</p><p class="text-xl font-black text-red-600">æ±ªä¸ºæ³½ (WANG WEIZE)</p><p class="text-xs font-bold text-gray-500">Satu-satunya æ±ª di Medan</p></div>
                </div>
                <div class="my-10 h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
                <p class="italic text-gray-600 font-serif">"Darah Shaanxi mengalir, jiwa Medan merajut. Keras bos! ðŸ”¥"</p>
            </div>
        </div>

        <!-- LATIHAN TULIS TAB -->
        <div id="dasar" class="tab-content hidden-tab text-center">
            <div class="glass-scroll p-8">
                <h2 class="text-3xl font-black text-red-900 mb-4">ðŸ–Œï¸ PAPAN TULIS SULTAN (MI ZI GE) - AI POWERED</h2>
                <div class="stroke-analysis mb-4"><div class="font-bold text-red-900 mb-2">ðŸ“Š Analisis Tulisan Real-time:</div><div id="strokeAnalysis" class="text-sm">Mulai tulis untuk melihat analisis...</div></div>
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    <button onclick="setPractice('æ±ª')" class="px-4 py-2 bg-red-900 text-white font-black rounded hover:bg-yellow-500">Marga æ±ª</button>
                    <button onclick="setPractice('èµš')" class="px-4 py-2 bg-red-900 text-white font-black rounded hover:bg-yellow-500">Cuan èµš</button>
                    <button onclick="setPractice('ä½ å¥½')" class="px-4 py-2 bg-red-900 text-white font-black rounded hover:bg-yellow-500">Halo ä½ å¥½</button>
                    <button onclick="setPractice('è°¢è°¢')" class="px-4 py-2 bg-red-900 text-white font-black rounded hover:bg-yellow-500">Terima kasih è°¢è°¢</button>
                    <button onclick="setPractice('')" class="px-4 py-2 bg-gray-800 text-white font-black rounded">Hapus Grid</button>
                </div>
                <div class="canvas-box">
                    <canvas id="gridCanvas" width="360" height="360"></canvas>
                    <canvas id="drawCanvas" width="360" height="360"></canvas>
                </div>
                <div class="mt-6 flex justify-center gap-4 flex-wrap">
                    <button onclick="clearDraw()" class="bg-red-900 text-white px-8 py-2 rounded-lg font-black shadow-lg">BERSIHKAN</button>
                    <button onclick="analyzeWriting()" class="bg-purple-600 text-white px-8 py-2 rounded-lg font-black shadow-lg">ðŸ¤– ANALISIS AI</button>
                    <button onclick="saveWriting()" class="bg-green-600 text-white px-8 py-2 rounded-lg font-black shadow-lg">ðŸ’¾ SIMPAN</button>
                </div>
                <div class="mt-8 bg-white/70 p-6 rounded-xl border-2 border-red-900"><h3 class="font-black text-red-900 mb-4">ðŸ“š Riwayat Latihan Tulis</h3><div id="writingHistory" class="text-sm text-gray-700">Belum ada riwayat latihan</div></div>
            </div>
        </div>

        <!-- KAMUS TAB -->
        <div id="kamus" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-4">ðŸ“– KAMUS MANDARIN SULTAN - ULTRA EDITION</h2>
                <div class="text-center mb-4">
                    <button onclick="filterDifficulty('all')" class="difficulty-btn active" id="diff-all">Semua Level</button>
                    <button onclick="filterDifficulty('easy')" class="difficulty-btn easy" id="diff-easy">Pemula</button>
                    <button onclick="filterDifficulty('medium')" class="difficulty-btn medium" id="diff-medium">Menengah</button>
                    <button onclick="filterDifficulty('hard')" class="difficulty-btn hard" id="diff-hard">Mahir</button>
                </div>
                <div class="search-wrapper"><input type="text" id="searchInput" placeholder="ðŸ” Cari kata (makan, åƒ, chi)..." onkeyup="searchVocab()"></div>
                <div class="ai-suggestion"><div class="font-bold mb-2">ðŸ¤– AI Recommendation:</div><div id="aiSuggestion">Berdasarkan progress Anda, coba fokus ke kata-kata tentang makanan!</div></div>
                <div id="vocabGrid" class="vocab-grid"></div>
            </div>
        </div>

        <!-- FLASHCARD TAB -->
        <div id="flashcard" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-8">ðŸŽ´ SMART FLASHCARD SYSTEM</h2>
                <div class="text-center mb-6"><div class="study-timer" id="flashcardTimer">00:00</div><div class="text-sm text-gray-600">Waktu Belajar Hari Ini</div></div>
                <div class="mb-8">
                    <h3 class="font-bold mb-3">Spaced Repetition Status:</h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="text-center"><div class="srs-indicator srs-new"></div><div class="text-xs mt-1">Baru: <span id="srsNew">0</span></div></div>
                        <div class="text-center"><div class="srs-indicator srs-learning"></div><div class="text-xs mt-1">Belajar: <span id="srsLearning">0</span></div></div>
                        <div class="text-center"><div class="srs-indicator srs-review"></div><div class="text-xs mt-1">Review: <span id="srsReview">0</span></div></div>
                        <div class="text-center"><div class="srs-indicator srs-master"></div><div class="text-xs mt-1">Master: <span id="srsMaster">0</span></div></div>
                    </div>
                </div>
                <div id="flashcardContainer" class="max-w-md mx-auto">
                    <div class="flashcard" onclick="flipCard()">
                        <div class="flashcard-inner">
                            <div class="flashcard-front"><div id="flashcardFront">ä½ å¥½</div></div>
                            <div class="flashcard-back"><div id="flashcardBack">Halo</div></div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button onclick="rateCard('easy')" class="bg-green-500 text-white px-6 py-3 rounded-lg font-bold">ðŸ˜Š Mudah</button>
                        <button onclick="rateCard('medium')" class="bg-yellow-500 text-white px-6 py-3 rounded-lg font-bold">ðŸ¤” Sedang</button>
                        <button onclick="rateCard('hard')" class="bg-red-500 text-white px-6 py-3 rounded-lg font-bold">ðŸ˜° Sulit</button>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-gray-600">Card <span id="cardProgress">1/20</span></div>
                        <div class="bg-gray-200 h-2 rounded-full mt-2"><div id="cardProgressBar" class="progress-bar" style="width: 5%"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUIZ TAB -->
        <div id="quiz" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-8">ðŸŽ¯ QUIZ INTERAKTIF</h2>
                <div class="max-w-2xl mx-auto">
                    <div class="mb-6 text-center">
                        <button onclick="startQuiz('translation')" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg m-2">Terjemahan</button>
                        <button onclick="startQuiz('mixed')" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg m-2">Campur</button>
                    </div>
                    <div id="quizContainer" class="bg-white p-8 rounded-xl border-2 border-red-900 shadow-xl">
                        <div class="mb-6">
                            <div class="flex justify-between mb-2"><span class="font-bold">Pertanyaan <span id="quizNumber">1</span>/10</span><span class="font-bold">Skor: <span id="quizScore">0</span></span></div>
                            <div class="bg-gray-200 h-2 rounded-full"><div id="quizProgressBar" class="progress-bar" style="width: 10%"></div></div>
                        </div>
                        <div class="mb-6"><div class="text-4xl font-black text-center mb-4 text-red-900" id="quizQuestion">ä½ å¥½</div><div class="text-center text-sm text-gray-600" id="quizHint">Apa arti dari karakter di atas?</div></div>
                        <div id="quizOptions"></div>
                        <div id="quizFeedback" class="mt-6 p-4 rounded-lg hidden"></div>
                    </div>
                    <div id="quizResults" class="hidden mt-6 bg-gradient-to-r from-yellow-100 to-yellow-200 p-8 rounded-xl border-2 border-yellow-600 text-center">
                        <h3 class="text-3xl font-black text-red-900 mb-4">ðŸŽ‰ QUIZ SELESAI!</h3>
                        <div class="text-6xl font-black text-yellow-700 mb-4" id="finalScore">80%</div>
                        <div class="text-xl mb-6" id="quizGrade">Bagus sekali!</div>
                        <button onclick="resetQuiz()" class="bg-red-900 text-white px-8 py-3 rounded-lg font-black">Coba Lagi</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI TUTOR TAB -->
        <div id="ai-tutor" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-8">ðŸ¤– AI PERSONAL TUTOR</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border-2 border-purple-600">
                        <h3 class="font-black text-purple-900 mb-4">ðŸ” Analisis Karakter Detail</h3>
                        <div class="text-center mb-4"><input type="text" id="analyzeChar" placeholder="Masukkan karakter" class="text-4xl text-center border-2 border-purple-400 rounded-lg p-3 w-32" maxlength="1"></div>
                        <div id="charAnalysis" class="space-y-3">
                            <div class="font-bold">Radikal & Komponen:</div>
                            <div id="radicals" class="text-center">Masukkan karakter untuk analisis</div>
                            <div class="font-bold mt-4">Etimologi:</div>
                            <div id="etymology" class="text-sm text-gray-600">-</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border-2 border-blue-600">
                        <h3 class="font-black text-blue-900 mb-4">ðŸŽµ Latihan Nada (Tones)</h3>
                        <div class="space-y-4">
                            <div><div class="flex justify-between items-center mb-2"><span class="font-bold">Nada 1 (å¹³)</span><button onclick="playTone(1)" class="vocab-btn">ðŸ”Š</button></div><div class="tone-visual"><div class="tone-line" style="top: 20%; width: 100%;"></div></div></div>
                            <div><div class="flex justify-between items-center mb-2"><span class="font-bold">Nada 2 (å‡)</span><button onclick="playTone(2)" class="vocab-btn">ðŸ”Š</button></div><div class="tone-visual"><div class="tone-line" style="top: 60%; width: 100%; transform: rotate(-20deg);"></div></div></div>
                            <div><div class="flex justify-between items-center mb-2"><span class="font-bold">Nada 3 (é™å‡)</span><button onclick="playTone(3)" class="vocab-btn">ðŸ”Š</button></div><div class="tone-visual"><div class="tone-line" style="top: 40%; width: 100%;"></div></div></div>
                            <div><div class="flex justify-between items-center mb-2"><span class="font-bold">Nada 4 (é™)</span><button onclick="playTone(4)" class="vocab-btn">ðŸ”Š</button></div><div class="tone-visual"><div class="tone-line" style="top: 20%; width: 100%; transform: rotate(20deg);"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESS TAB -->
        <div id="progress" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-8">ðŸ“Š PROGRESS & ANALYTICS</h2>
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card"><div class="text-4xl mb-2">ðŸ”¥</div><div class="text-3xl font-black text-red-900" id="streakDays">0</div><div class="text-sm">Hari Beruntun</div></div>
                    <div class="stat-card"><div class="text-4xl mb-2">â±ï¸</div><div class="text-3xl font-black text-red-900" id="totalStudyTime">0</div><div class="text-sm">Menit Belajar</div></div>
                    <div class="stat-card"><div class="text-4xl mb-2">ðŸ“ˆ</div><div class="text-3xl font-black text-red-900" id="accuracyRate">0%</div><div class="text-sm">Tingkat Akurasi</div></div>
                </div>
                <div class="bg-white p-6 rounded-xl border-2 border-yellow-600 mb-6">
                    <h3 class="font-black text-yellow-900 mb-4">ðŸ“… Kalender Belajar (30 Hari)</h3>
                    <div class="flex flex-wrap gap-2" id="streakCalendar"></div>
                </div>
                <div class="bg-white p-6 rounded-xl border-2 border-green-600">
                    <h3 class="font-black text-green-900 mb-4">ðŸ‘‘ Leaderboard Mingguan</h3>
                    <div class="leaderboard-item"><div class="flex items-center gap-3"><span class="rank-medal">ðŸ¥‡</span><div><div class="font-bold">Wang Weize</div><div class="text-sm text-gray-600">Level 15 â€¢ 2,450 XP</div></div></div><div class="badge">You!</div></div>
                    <div class="leaderboard-item"><div class="flex items-center gap-3"><span class="rank-medal">ðŸ¥ˆ</span><div><div class="font-bold">Li Ming</div><div class="text-sm text-gray-600">Level 14 â€¢ 2,380 XP</div></div></div></div>
                </div>
            </div>
        </div>

        <!-- CINEMA TAB -->
        <div id="cinema" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-2">ðŸŽ¥ CINEMA SULTAN</h2>
                <p class="text-center text-gray-600 mb-6 text-sm">Tonton video Mandarin, pelajari slang dari komentar netizen!</p>
                <div class="cinema-search">
                    <input type="text" id="cinemaSearchInput" placeholder="ðŸ” Cari video Mandarin..." onkeydown="if(event.key==='Enter') cariCinema()">
                    <button onclick="cariCinema()">ðŸ” Cari</button>
                </div>
                <div class="smart-chips">
                    <div class="chip" onclick="chipSearch('HSK 1 Mandarin', this)">ðŸ“— HSK 1</div>
                    <div class="chip" onclick="chipSearchTW('Trending Taiwan Mandarin', this)">ðŸ‡¹ðŸ‡¼ Taiwan</div>
                    <div class="chip" onclick="chipSearch('Lagu Mandarin populer', this)">ðŸŽµ Lagu</div>
                    <div class="chip" onclick="chipSearch('Bisnis Mandarin belajar', this)">ðŸ’¼ Bisnis</div>
                    <div class="chip" onclick="chipSearch('belajar Mandarin pemula', this)">ðŸ“š Pemula</div>
                    <div class="chip" onclick="chipSearch('slang Mandarin China', this)">ðŸ—£ï¸ Slang</div>
                </div>
                <div id="cinemaGrid" class="video-grid">
                    <div class="cinema-loading col-span-full py-20"><span>ðŸŽ¥</span> Pilih filter atau cari video untuk mulai!</div>
                </div>
            </div>
        </div>

        <!-- KARAOKE TAB -->
        <div id="karaoke" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-3xl font-black text-center text-red-900 mb-1">ðŸŽ¤ KARAOKE SULTAN</h2>
                <p class="text-center text-gray-500 mb-5 text-sm">Cari lagu, nyanyi bareng, klaim <strong>150 XP</strong> setelah 30 detik! ðŸ®</p>

                <!-- Search Bar -->
                <div class="cinema-search mb-3">
                    <input
                        type="text"
                        id="karaokeSearchInput"
                        placeholder="ðŸ” Cari Lagu Karaoke Sultan... (contoh: Teresa Teng, Jay Chou)"
                        onkeydown="if(event.key==='Enter') searchKaraoke()"
                        style="font-family:'Noto Serif SC',serif;"
                    >
                    <button onclick="searchKaraoke()" style="background:var(--imperial-red); color:var(--emperor-gold); border:none; border-radius:50px; padding:12px 22px; font-weight:900; cursor:pointer; transition:0.2s; white-space:nowrap;">
                        ðŸŽµ Cari
                    </button>
                </div>

                <!-- Quick Chips -->
                <div class="smart-chips mb-5" id="karaokeChips">
                    <div class="chip" onclick="karaokeChip('Teresa Teng', this)">ðŸŒ™ Teresa Teng</div>
                    <div class="chip" onclick="karaokeChip('Jay Chou', this)">ðŸŽ¹ Jay Chou</div>
                    <div class="chip" onclick="karaokeChip('S.H.E', this)">ðŸŽ€ S.H.E</div>
                    <div class="chip" onclick="karaokeChip('Lagu Mandarin Populer', this)">ðŸ”¥ Trending</div>
                    <div class="chip" onclick="karaokeChip('Lagu Mandarin Anak-anak', this)">ðŸ‘¶ Anak-anak</div>
                    <div class="chip" onclick="karaokeChip('Lagu Imlek', this)">ðŸ§§ Imlek</div>
                </div>

                <!-- Results Grid -->
                <div id="karaokeGrid" class="video-grid">
                    <div class="cinema-loading col-span-full py-20" id="karaokeEmptyState">
                        <span>ðŸŽ¤</span>
                        <div style="margin-top:12px; font-size:16px; color:var(--imperial-red);">Cari lagu favorit kamu atau klik chip di atas!</div>
                        <div style="font-size:12px; color:#888; margin-top:6px;">Kata "Karaoke Pinyin" otomatis ditambahkan agar hasil akurat ðŸŽ¯</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- ======= SULTAN SMART PAYMENT HUB V3 =========================== -->
        <!-- ================================================================ -->
        <div id="store" class="tab-content hidden-tab">
            <div class="store-title">ðŸ’³ SMART PAYMENT HUB</div>
            <div class="store-subtitle">Top Up Cerdas â€¢ Memory Nomor â€¢ Riwayat Transaksi</div>

            <!-- FLASH SALE TIMER -->
            <div id="flashSaleBar">
                <div>
                    <div class="flash-sale-label">âš¡ FLASH SALE SULTAN</div>
                    <div style="color:rgba(255,215,0,0.5); font-size:11px; letter-spacing:2px; margin-top:3px;">PENAWARAN SPESIAL BERAKHIR DALAM</div>
                </div>
                <div class="flash-timer-digits">
                    <div class="flash-digit" id="flashH">00</div>
                    <span class="flash-sep">:</span>
                    <div class="flash-digit" id="flashM">00</div>
                    <span class="flash-sep">:</span>
                    <div class="flash-digit" id="flashS">00</div>
                </div>
            </div>

            <!-- PAYMENT METHOD SHOWCASE (CSS Only - No External Images) -->
            <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,215,0,0.15); border-radius:14px; padding:18px; margin-bottom:24px; text-align:center;">
                <div style="color:#666; font-size:10px; letter-spacing:3px; text-transform:uppercase; margin-bottom:14px;">âœ“ METODE PEMBAYARAN TERSEDIA</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center;">
                    <div class="pay-logo-qris">â–  QRIS</div>
                    <div class="pay-logo-bca">BCA</div>
                    <div class="pay-logo-mandiri">MNDRI</div>
                    <div class="pay-logo-bri">BRI</div>
                    <div class="pay-logo-dana">DANA</div>
                    <div class="pay-logo-ovo">OVO</div>
                    <div class="pay-logo-gopay">GoPay</div>
                    <div class="pay-logo-tsel">Telkomsel</div>
                    <div class="pay-logo-xl">XL</div>
                    <div class="pay-logo-indosat">Indosat</div>
                </div>
            </div>

            <!-- CATEGORY A: TOP UP OFFICIAL -->
            <div class="mb-2"><span class="store-category-label">ðŸª A. TOP UP OFFICIAL â€” SMART REDIRECT</span></div>
            <p style="color:#888; font-size:12px; margin-bottom:18px;">Pilih produk â†’ Isi data â†’ Klik BAYAR â†’ Auto-copy nomor â†’ Redirect aman âœ“</p>

            <!-- Product Selector with 3D Coins -->
            <div class="topup-grid" id="topupProductGrid">
                <div class="topup-product-card" onclick="selectTopupProduct(this,'tiktok')" data-product="tiktok">
                    <div class="coin-3d-wrap"><div class="coin-3d">ðŸŽµ</div></div>
                    <div class="topup-name">TikTok Coin</div>
                    <div class="topup-desc">70 â€“ 17.500 Koin</div>
                </div>
                <div class="topup-product-card" onclick="selectTopupProduct(this,'pulsa')" data-product="pulsa">
                    <div class="coin-3d-wrap"><div class="coin-3d">ðŸ“±</div></div>
                    <div class="topup-name">Pulsa & Data</div>
                    <div class="topup-desc">All Operator Indonesia</div>
                </div>
                <div class="topup-product-card" onclick="selectTopupProduct(this,'pln')" data-product="pln">
                    <div class="coin-3d-wrap"><div class="coin-3d">âš¡</div></div>
                    <div class="topup-name">PLN Token</div>
                    <div class="topup-desc">Semua meteran listrik</div>
                </div>
                <div class="topup-product-card" onclick="selectTopupProduct(this,'ewallet')" data-product="ewallet">
                    <div class="coin-3d-wrap"><div class="coin-3d">ðŸ’³</div></div>
                    <div class="topup-name">E-Wallet</div>
                    <div class="topup-desc">DANA / OVO / GoPay</div>
                </div>
                <div class="topup-product-card" onclick="selectTopupProduct(this,'travel')" data-product="travel">
                    <div class="coin-3d-wrap"><div class="coin-3d">âœˆï¸</div></div>
                    <div class="topup-name">Travel & Hotel</div>
                    <div class="topup-desc">Tiket & Penginapan Murah</div>
                </div>
            </div>

            <!-- Form Top Up -->
            <div class="store-form" id="topupForm">
                <label>NOMOR HP / ID PENGGUNA</label>
                <div class="nomor-input-wrap">
                    <input type="tel" class="store-input" id="topupNomor" placeholder="08xxxxxxxxxx atau ID TikTok..." oninput="validateTopupBtn()">
                    <button class="btn-contact-book" onclick="toggleContactBook()" title="Buku Kontak">ðŸ“’</button>
                </div>

                <!-- Contact Book Panel -->
                <div id="contactBookPanel">
                    <h4>ðŸ“’ BUKU KONTAK SULTAN</h4>
                    <div id="contactList">
                        <div style="color:#555; font-size:12px; text-align:center; padding:12px;">Belum ada kontak tersimpan</div>
                    </div>
                    <div class="contact-save-row">
                        <input type="text" id="contactNameInput" placeholder="Nama (opsional)">
                        <button onclick="saveCurrentContact()">ðŸ’¾ Simpan</button>
                    </div>
                </div>

                <!-- Nominal -->
                <label>PILIH NOMINAL</label>
                <div class="nominal-grid" id="nominalGrid">
                    <div class="nominal-chip" onclick="selectNominal(this, 'Pilih produk dulu')">â€” pilih produk â€”</div>
                </div>

                <!-- Metode Pembayaran -->
                <label>METODE PEMBAYARAN</label>
                <div class="payment-section">
                    <span class="payment-group-label">ðŸ’³ Transfer Bank</span>
                    <div class="payment-logos">
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="BCA"><div class="pay-logo-bca" style="width:36px;height:20px;font-size:9px;">BCA</div> BCA</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="Mandiri"><div class="pay-logo-mandiri" style="width:36px;height:20px;font-size:8px;">MNDRI</div> Mandiri</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="BRI"><div class="pay-logo-bri" style="width:36px;height:20px;font-size:9px;">BRI</div> BRI</div>
                    </div>
                    <span class="payment-group-label">ðŸ“² E-Wallet</span>
                    <div class="payment-logos">
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="DANA"><div class="pay-logo-dana" style="width:36px;height:20px;font-size:9px;">DANA</div> DANA</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="OVO"><div class="pay-logo-ovo" style="width:36px;height:20px;font-size:9px;">OVO</div> OVO</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="GoPay"><div class="pay-logo-gopay" style="width:36px;height:20px;font-size:9px;">GoPay</div> GoPay</div>
                    </div>
                    <span class="payment-group-label">ðŸ“² QRIS</span>
                    <div class="payment-logos">
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="QRIS"><div class="pay-logo-qris" style="width:36px;height:20px;font-size:8px;">â–  QRIS</div> QRIS</div>
                    </div>
                    <span class="payment-group-label">ðŸ“¶ Pulsa Operator</span>
                    <div class="payment-logos">
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="Telkomsel"><div class="pay-logo-tsel" style="width:36px;height:20px;font-size:7px;">Telkomsel</div> Tsel</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="XL"><div class="pay-logo-xl" style="width:36px;height:20px;font-size:9px;">XL</div> XL</div>
                        <div class="payment-logo" onclick="selectPayment(this)" data-pay="Indosat"><div class="pay-logo-indosat" style="width:36px;height:20px;font-size:8px;">Indosat</div> Indosat</div>
                    </div>
                </div>

                <button class="store-pay-btn" id="topupPayBtn" disabled onclick="handleSmartRedirect()">
                    ðŸ”’ ISI NOMOR HP DULU
                </button>

                <!-- Transaction History -->
                <div id="txHistory" style="display:none;">
                    <h4>ðŸ• RIWAYAT TRANSAKSI</h4>
                    <div id="txList"></div>
                </div>

                <p style="color:#555; font-size:11px; text-align:center; margin-top:10px;">âœ… Nomor HP otomatis disalin â€¢ Redirect ke website resmi â€¢ Data aman</p>
            </div>

            <div class="store-divider"></div>

            <!-- CATEGORY B: AKUN PREMIUM -->
            <div class="mb-2"><span class="store-category-label">ðŸ’Ž B. AKUN PREMIUM MURAH â€” VIA WA SULTAN</span></div>
            <p style="color:#888; font-size:12px; margin-bottom:18px;">Sharing/Private account. Harga terjangkau + markup Rp 5.000. Order via WhatsApp ðŸ“±</p>

            <div class="premium-grid">
                <div class="premium-card">
                    <span class="premium-icon">â–¶ï¸</span>
                    <div class="premium-name">YouTube Premium</div>
                    <div class="premium-type">Sharing Account â€¢ 1 Bulan</div>
                    <div class="premium-price-row">
                        <span class="premium-price-cross">Rp 79.000</span>
                        <span class="premium-price-main">Rp 15.000</span>
                        <span class="premium-markup">HEMAT 81%</span>
                    </div>
                    <button class="premium-buy-btn" onclick="buyPremiumWA('YouTube Premium','Rp 15.000')">ðŸ“± BELI VIA WA SULTAN</button>
                </div>
                <div class="premium-card">
                    <span class="premium-icon">ðŸ¤–</span>
                    <div class="premium-name">ChatGPT Plus</div>
                    <div class="premium-type">GPT-4o Access â€¢ 1 Bulan</div>
                    <div class="premium-price-row">
                        <span class="premium-price-cross">Rp 320.000</span>
                        <span class="premium-price-main">Rp 55.000</span>
                        <span class="premium-markup">HEMAT 83%</span>
                    </div>
                    <button class="premium-buy-btn" onclick="buyPremiumWA('ChatGPT Plus','Rp 55.000')">ðŸ“± BELI VIA WA SULTAN</button>
                </div>
                <div class="premium-card">
                    <span class="premium-icon">âœ¨</span>
                    <div class="premium-name">Gemini Advanced</div>
                    <div class="premium-type">Google AI Pro â€¢ 1 Bulan</div>
                    <div class="premium-price-row">
                        <span class="premium-price-cross">Rp 319.000</span>
                        <span class="premium-price-main">Rp 55.000</span>
                        <span class="premium-markup">HEMAT 83%</span>
                    </div>
                    <button class="premium-buy-btn" onclick="buyPremiumWA('Gemini Advanced','Rp 55.000')">ðŸ“± BELI VIA WA SULTAN</button>
                </div>
                <div class="premium-card">
                    <span class="premium-icon">ðŸ§ </span>
                    <div class="premium-name">Claude Pro</div>
                    <div class="premium-type">Anthropic AI Pro â€¢ 1 Bulan</div>
                    <div class="premium-price-row">
                        <span class="premium-price-cross">Rp 320.000</span>
                        <span class="premium-price-main">Rp 55.000</span>
                        <span class="premium-markup">HEMAT 83%</span>
                    </div>
                    <button class="premium-buy-btn" onclick="buyPremiumWA('Claude Pro','Rp 55.000')">ðŸ“± BELI VIA WA SULTAN</button>
                </div>
            </div>

            <div class="store-divider"></div>

            <!-- CATEGORY C: SULTAN POWER-UPS -->
            <div class="mb-2"><span class="store-category-label">ðŸ§Š C. SULTAN POWER-UPS â€” BELI DENGAN XP</span></div>
            <p style="color:#888; font-size:12px; margin-bottom:18px;">Tukar XP jadi keuntungan nyata! XP kamu: <strong id="xpBalanceDisplay" style="color:var(--emperor-gold);">0</strong></p>
            <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; margin-bottom:20px;">
                <div class="streak-freeze-card" onclick="buyStreakFreeze()">
                    <span class="sf-icon">ðŸ§Š</span>
                    <div class="sf-name">STREAK FREEZE</div>
                    <div class="sf-desc">Streak tidak putus walau sehari tidak belajar. Otomatis aktif saat diperlukan!</div>
                    <div class="sf-price">500 XP</div>
                    <div class="sf-owned">Dimiliki: <span id="freezeOwnedCount">0</span> buah</div>
                </div>
                <div class="streak-freeze-card" onclick="buyXPBooster()" style="border-color:#FFD700;">
                    <span class="sf-icon">âš¡</span>
                    <div class="sf-name" style="color:var(--emperor-gold);">XP BOOSTER 2x</div>
                    <div class="sf-desc">Semua XP yang kamu dapatkan berlipat 2x selama 24 jam penuh!</div>
                    <div class="sf-price">1.000 XP</div>
                    <div class="sf-owned"><span id="boosterStatus">Tidak aktif</span></div>
                </div>
                <div class="streak-freeze-card" onclick="openPuzzle()" style="border-color:#a855f7; cursor:pointer;">
                    <span class="sf-icon">ðŸ§©</span>
                    <div class="sf-name" style="color:#a855f7;">CHARACTER PUZZLE</div>
                    <div class="sf-desc">Game susun radikal karakter! Menang dalam 30 detik = klaim 300 XP!</div>
                    <div class="sf-price" style="color:#a855f7;">GRATIS MAIN</div>
                    <div class="sf-owned" style="color:#a855f7;">â–¶ Mainkan Sekarang</div>
                </div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- ======= SULTAN MAGIC AI STUDIO ================================ -->
        <!-- ================================================================ -->
        <div id="ai-lab" class="tab-content hidden-tab magic-studio">

            <div class="magic-studio-title">ðŸª„ SULTAN MAGIC AI STUDIO</div>
            <div class="magic-studio-subtitle">â–¸ Neural Video Generation â–¸ Powered by Omniverse Engine â–¸</div>

            <!-- Config Row -->
            <div class="magic-config-grid">
                <div class="magic-config-group">
                    <span class="magic-config-label">ðŸ¤– AI Engine</span>
                    <select class="magic-select" id="magicEngine">
                        <option value="sora3">ðŸŒ€ SORA 3 (Ultra-Realism)</option>
                        <option value="veo3" selected>ðŸŽ¬ VEO 3 (Cinematic)</option>
                        <option value="runway">âœ‚ï¸ RUNWAY GEN-3 (VFX)</option>
                        <option value="kling">ðŸŽ‹ KLING AI (Asian Style)</option>
                    </select>
                </div>
                <div class="magic-config-group">
                    <span class="magic-config-label">â±ï¸ Durasi Video</span>
                    <select class="magic-select" id="magicDuration">
                        <option value="short">10 Detik</option>
                        <option value="short" selected>30 Detik</option>
                        <option value="short">1 Menit</option>
                        <option value="long">10 Menit</option>
                        <option value="long">1 Jam</option>
                    </select>
                </div>
            </div>

            <!-- Prompt -->
            <div class="magic-prompt-area">
                <textarea class="magic-textarea" id="magicPrompt" placeholder="Describe your imagination... Contoh: 'A golden imperial dragon soaring over Shanghai at night, cinematic 8K volumetric light, oil painting style, epic score...'"></textarea>
                <div style="color:rgba(255,215,0,0.3); font-size:10px; text-align:right; margin-top:6px; font-family:monospace;" id="magicCharCount">0 / 2000</div>
            </div>

            <!-- Generate Button -->
            <button class="magic-generate-btn" id="magicGenerateBtn" onclick="handleMagicGenerate()">
                ðŸŽ¬ GENERATE VIDEO
            </button>

            <!-- Loading Screen -->
            <div id="magicLoadingScreen">
                <div style="font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--emperor-gold); margin-bottom:16px; letter-spacing:3px;">
                    ðŸ§  Neural Network Active
                </div>
                <div class="magic-progress-bar-bg">
                    <div class="magic-progress-bar-fill" id="magicProgressBar"></div>
                </div>
                <div style="color:rgba(255,215,0,0.6); font-size:12px; margin-bottom:14px;" id="magicProgressPct">0%</div>
                <div class="magic-terminal-text" id="magicTerminal">
                    &gt; Booting Sultan Omniverse Engine...<span class="t-cursor">â–ˆ</span>
                </div>
            </div>

            <!-- Video Result -->
            <div id="magicVideoResult">
                <div style="color:rgba(255,215,0,0.6); font-size:11px; font-family:monospace; letter-spacing:2px; margin-bottom:10px; text-align:center;">
                    âœ… GENERATION COMPLETE â€” PLAYING YOUR AI VIDEO
                </div>
                <div class="magic-video-wrapper">
                    <iframe id="magicIframe" src="" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                    <div class="magic-watermark">ðŸª„ Generated by Sultan Omniverse AI</div>
                </div>
                <div class="magic-result-info" id="magicResultInfo">
                    // Engine: â€” | Prompt: â€”
                </div>
                <div class="render-stats-box" id="renderStatsBox" style="display:none;">
                    <div class="rs-item"><span>ðŸ§  Neural Nodes</span><span class="rs-val" id="rsNodes">â€”</span></div>
                    <div class="rs-item"><span>ðŸŽžï¸ Frames Rendered</span><span class="rs-val" id="rsFrames">â€”</span></div>
                    <div class="rs-item"><span>âš¡ GPU Clusters</span><span class="rs-val" id="rsGPU">â€”</span></div>
                    <div class="rs-item"><span>ðŸ“Š Quality Score</span><span class="rs-val" id="rsQuality">â€”</span></div>
                    <div class="rs-item"><span>ðŸ• Render Time</span><span class="rs-val" id="rsTime">â€”</span></div>
                    <div class="rs-item"><span>ðŸ† Sultan Rating</span><span class="rs-val" id="rsRating">â€”</span></div>
                </div>
                <button class="magic-download-btn" id="magicDownloadBtn" onclick="downloadMagicVideo()">
                    â¬‡ï¸ DOWNLOAD VIDEO (MP4)
                </button>
            </div>

        </div>

    </main>

    <!-- ================================================================ -->
    <!-- ======= SULTAN AI (ASK AI) TAB ================================= -->
    <!-- ================================================================ -->
    <!-- Tab is placed outside main so it can be full-width, but it's still within body -->
    <!-- ============================================================ -->
    <!-- ASK AI TAB â€” BYOK SYSTEM                                    -->
    <!-- ============================================================ -->
    <div id="ask-ai" class="tab-content hidden-tab" style="max-width:860px; margin:0 auto; padding:16px;">

        <!-- â–‘â–‘ OUTER SHELL (selalu tampil) â–‘â–‘ -->
        <div style="background:linear-gradient(160deg,#0d0d1e,#1a0028,#0d0d1e); border:2px solid #a855f7; border-radius:20px; padding:28px; box-shadow:0 0 60px rgba(168,85,247,0.2); position:relative; overflow:hidden;">

            <!-- Cyberpunk grid overlay -->
            <div style="position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 50px,rgba(168,85,247,0.018) 50px,rgba(168,85,247,0.018) 51px),repeating-linear-gradient(90deg,transparent,transparent 50px,rgba(168,85,247,0.010) 50px,rgba(168,85,247,0.010) 51px);pointer-events:none;"></div>

            <!-- â”€â”€ TITLE â”€â”€ -->
            <div style="text-align:center; margin-bottom:22px; position:relative;">
                <div style="font-family:'Orbitron',monospace; font-size:clamp(1.3rem,4vw,2rem); font-weight:900; color:#a855f7; text-shadow:0 0 20px rgba(168,85,247,0.7); letter-spacing:3px;">ðŸ¤– SULTAN AI</div>
                <div style="color:rgba(168,85,247,0.5); font-size:11px; letter-spacing:4px; text-transform:uppercase; font-family:'Orbitron',monospace; margin-top:4px;">BYOK â€¢ Bring Your Own Key â€¢ by Wang Weize</div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- PANEL A â€” "GERBANG AI" â€” tampil saat belum ada key    -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="aiGate" style="display:none;">

                <!-- Lock icon hero -->
                <div style="text-align:center; margin-bottom:24px;">
                    <div style="font-size:56px; filter:drop-shadow(0 0 18px rgba(168,85,247,0.7));">ðŸ”</div>
                    <div style="color:#e2d9f3; font-size:15px; font-weight:700; margin-top:8px;">Masukkan API Key kamu untuk mengaktifkan Sultan AI</div>
                    <div style="color:rgba(168,85,247,0.5); font-size:12px; margin-top:4px;">Key disimpan <em>hanya</em> di browser kamu â€” tidak dikirim ke mana pun selain provider yang kamu pilih.</div>
                </div>

                <!-- Provider dropdown -->
                <div style="margin-bottom:14px;">
                    <label style="display:block; color:#a855f7; font-size:11px; font-weight:900; letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; font-family:'Orbitron',monospace;">âš™ï¸ Pilih Provider</label>
                    <select id="aiProviderSelect"
                        style="width:100%; padding:14px 16px; background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.4); border-radius:12px; color:#e2d9f3; font-size:14px; font-weight:700; outline:none; cursor:pointer; transition:0.3s; font-family:'Noto Serif SC',serif;"
                        onchange="updateKeyPlaceholder()"
                        onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 0 14px rgba(168,85,247,0.3)'"
                        onblur="this.style.borderColor='rgba(168,85,247,0.4)'; this.style.boxShadow='none'">
                        <option value="gemini"     style="background:#1a0028;">âœ¨ Google Gemini (gemini-1.5-flash)</option>
                        <option value="openrouter" style="background:#1a0028;">ðŸŒ OpenRouter (gemini-2.0-flash-lite free)</option>
                    </select>
                </div>

                <!-- API Key input -->
                <div style="margin-bottom:14px;">
                    <label style="display:block; color:#a855f7; font-size:11px; font-weight:900; letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; font-family:'Orbitron',monospace;">ðŸ”‘ API Key</label>
                    <div style="position:relative;">
                        <input type="password" id="aiKeyInput"
                            placeholder="Tempel API Key kamu di sini..."
                            style="width:100%; padding:14px 48px 14px 16px; background:rgba(168,85,247,0.08); border:1px solid rgba(168,85,247,0.4); border-radius:12px; color:#e2d9f3; font-size:14px; font-weight:700; outline:none; transition:0.3s; font-family:monospace; box-sizing:border-box;"
                            onkeydown="if(event.key==='Enter') saveAIKey()"
                            onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 0 14px rgba(168,85,247,0.3)'"
                            onblur="this.style.borderColor='rgba(168,85,247,0.4)'; this.style.boxShadow='none'">
                        <!-- Show/hide password toggle -->
                        <button onclick="toggleKeyVisibility()" title="Tampilkan/Sembunyikan Key"
                            style="position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:18px; color:rgba(168,85,247,0.6); line-height:1;"
                            id="aiKeyToggleBtn">ðŸ‘ï¸</button>
                    </div>
                    <div id="aiKeyHint" style="color:rgba(168,85,247,0.45); font-size:11px; margin-top:6px; font-family:monospace;">
                        ðŸ’¡ Gemini key: aizaSy... &nbsp;|&nbsp; OpenRouter key: sk-or-v1-...
                    </div>
                </div>

                <!-- Save button -->
                <button onclick="saveAIKey()" id="aiSaveKeyBtn"
                    style="width:100%; padding:16px; background:linear-gradient(135deg,#6d28d9,#a855f7,#6d28d9); color:white; border:none; border-radius:12px; font-size:15px; font-weight:900; cursor:pointer; transition:0.3s; letter-spacing:2px; text-transform:uppercase; font-family:'Orbitron',monospace; box-shadow:0 0 20px rgba(168,85,247,0.3); margin-bottom:18px;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 30px rgba(168,85,247,0.5)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 20px rgba(168,85,247,0.3)'">
                    ðŸ’¾ SIMPAN &amp; MASUK
                </button>

                <!-- Error message -->
                <div id="aiGateError" style="display:none; background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4); border-radius:10px; padding:12px 16px; color:#fca5a5; font-size:13px; text-align:center; margin-bottom:12px;"></div>

                <!-- Helper links -->
                <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                        style="padding:8px 16px; background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:20px; color:#c4b5fd; font-size:12px; text-decoration:none; font-weight:700; transition:0.2s;"
                        onmouseover="this.style.background='rgba(168,85,247,0.25)'" onmouseout="this.style.background='rgba(168,85,247,0.1)'">
                        âœ¨ Daftar Gemini API Key (Gratis)
                    </a>
                    <a href="https://openrouter.ai/keys" target="_blank"
                        style="padding:8px 16px; background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); border-radius:20px; color:#c4b5fd; font-size:12px; text-decoration:none; font-weight:700; transition:0.2s;"
                        onmouseover="this.style.background='rgba(168,85,247,0.25)'" onmouseout="this.style.background='rgba(168,85,247,0.1)'">
                        ðŸŒ Daftar OpenRouter Key (Ada free tier)
                    </a>
                </div>
            </div>
            <!-- / PANEL A -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- PANEL B â€” CHAT â€” tampil saat key sudah tersimpan      -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="aiChat" style="display:none;">

                <!-- Active provider badge + logout -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; flex-wrap:wrap; gap:8px;">
                    <div id="aiActiveBadge" style="font-size:12px; background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.35); border-radius:20px; padding:5px 14px; color:#c4b5fd; font-weight:700; font-family:monospace;"></div>
                    <button onclick="logoutAIKey()"
                        style="padding:6px 14px; background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.3); border-radius:20px; color:#fca5a5; font-size:11px; font-weight:900; cursor:pointer; transition:0.2s; letter-spacing:1px;"
                        onmouseover="this.style.background='rgba(239,68,68,0.25)'" onmouseout="this.style.background='rgba(239,68,68,0.12)'">
                        âš™ï¸ Ganti API Key
                    </button>
                </div>

                <!-- Chat messages -->
                <div id="aiChatBox"
                    style="background:rgba(0,0,0,0.4); border:1px solid rgba(168,85,247,0.3); border-radius:14px; padding:16px; min-height:340px; max-height:460px; overflow-y:auto; margin-bottom:14px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth;">
                </div>

                <!-- Input row -->
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <textarea id="aiUserInput"
                        placeholder="Tanya apapun ke Sultan AI... (Enter = Kirim, Shift+Enter = Baris baru)"
                        style="flex:1; background:rgba(255,255,255,0.07); border:1px solid rgba(168,85,247,0.4); border-radius:12px; padding:14px 16px; color:white; font-size:14px; font-family:'Noto Serif SC',serif; resize:none; min-height:56px; max-height:140px; outline:none; transition:0.3s; line-height:1.5;"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendSultanAI();}"
                        oninput="this.style.height='56px';this.style.height=Math.min(this.scrollHeight,140)+'px';"
                        onfocus="this.style.borderColor='#a855f7';this.style.boxShadow='0 0 15px rgba(168,85,247,0.25)'"
                        onblur="this.style.borderColor='rgba(168,85,247,0.4)';this.style.boxShadow='none'"></textarea>
                    <button onclick="sendSultanAI()" id="aiSendBtn"
                        style="background:linear-gradient(135deg,#7c3aed,#a855f7); color:white; border:none; border-radius:12px; padding:14px 20px; font-weight:900; font-size:18px; cursor:pointer; transition:0.3s; flex-shrink:0; height:56px;"
                        onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">ðŸš€</button>
                </div>
                <div style="text-align:center; color:rgba(168,85,247,0.35); font-size:10px; margin-top:7px; font-family:monospace;">[ Enter = Kirim &nbsp;â€¢&nbsp; Shift+Enter = Baris Baru &nbsp;â€¢&nbsp; Kreator: Wang Weize çŽ‹ä¸ºæ³½ ]</div>

                <!-- Quick prompts -->
                <div style="margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                    <button onclick="quickAsk('Roasting gue dong dengan gaya paling sadis!')"           class="ai-quick-btn">ðŸ”¥ Roast Gue!</button>
                    <button onclick="quickAsk('Kasih gue 5 ide konten TikTok viral yang cuan abis!')"   class="ai-quick-btn">ðŸ’¡ Ide Konten</button>
                    <button onclick="quickAsk('Tips PDKT yang berhasil dan ga boncos?')"                class="ai-quick-btn">ðŸ’• Tips Asmara</button>
                    <button onclick="quickAsk('Siapa penciptamu?')"                                     class="ai-quick-btn">ðŸ‘‘ Siapa Kreatormu?</button>
                    <button onclick="quickAsk('Tips cuan bisnis online mulai dari nol!')"               class="ai-quick-btn">ðŸ’° Tips Cuan</button>
                </div>
            </div>
            <!-- / PANEL B -->

        </div>
    </div>

    <script>
        // ================================================================
        // ============= ORIGINAL FUNCTIONALITY (TIDAK DIUBAH) =============
        // ================================================================
        const vocabData = [
            {h:"ä½ å¥½", p:"nÇ hÇŽo", a:"Halo", d:"easy", c:"perkenalan", ctx:"ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚(Halo, senang berkenalan denganmu.)"},
            {h:"è°¢è°¢", p:"xiÃ¨ xiÃ¨", a:"Terima kasih", d:"easy", c:"perkenalan", ctx:"è°¢è°¢ä½ çš„å¸®åŠ©ã€‚(Terima kasih atas bantuanmu.)"},
            {h:"è€æ¿", p:"lÇŽo bÇŽn", a:"Bos Besar", d:"easy", c:"bisnis", ctx:"è€æ¿å¾ˆå¿™ã€‚(Bos sangat sibuk.)"},
            {h:"æœ€ä½Žä»·", p:"zuÃ¬ dÄ« jiÃ ", a:"Harga Pas", d:"medium", c:"bisnis", ctx:"è¿™æ˜¯æœ€ä½Žä»·äº†ã€‚(Ini sudah harga pas.)"},
            {h:"åˆä½œ", p:"hÃ© zuÃ²", a:"Kerjasama", d:"medium", c:"bisnis", ctx:"æˆ‘ä»¬å¯ä»¥åˆä½œã€‚(Kita bisa bekerjasama.)"},
            {h:"èµš", p:"zhuÃ n", a:"Cuan/Untung", d:"medium", c:"bisnis", ctx:"ä»–èµšäº†å¾ˆå¤šé’±ã€‚(Dia dapat banyak cuan.)"},
            {h:"èµ”", p:"pÃ©i", a:"Boncos/Rugi", d:"medium", c:"bisnis", ctx:"ç”Ÿæ„èµ”äº†ã€‚(Bisnis boncos.)"},
            {h:"å’‹æ ·", p:"zÇŽ yÃ ng", a:"Gimana? (Shaanxi)", d:"hard", c:"slang", ctx:"ä½ è§‰å¾—å’‹æ ·ï¼Ÿ(Menurutmu gimana?)"},
            {h:"æ’’", p:"sÄ", a:"Apa (Slang Shaanxi)", d:"hard", c:"slang", ctx:"ä½ æƒ³åƒæ’’ï¼Ÿ(Mau makan apa?)"},
            {h:"åƒé¥­", p:"chÄ« fÃ n", a:"Makan nasi", d:"easy", c:"makanan", ctx:"æˆ‘ä»¬ä¸€èµ·åƒé¥­å§ã€‚(Ayo makan bareng.)"},
            {h:"å–æ°´", p:"hÄ“ shuÇ", a:"Minum air", d:"easy", c:"makanan", ctx:"è¯·å–æ°´ã€‚(Silakan minum air.)"},
            {h:"åŽ»å“ªé‡Œ", p:"qÃ¹ nÇŽ lÇ", a:"Pergi ke mana", d:"medium", c:"perjalanan", ctx:"ä½ è¦åŽ»å“ªé‡Œï¼Ÿ(Mau pergi ke mana?)"},
        ];
        let currentDifficulty = 'all';
        let userStats = { totalWords: 0, studyStreak: 0, totalXP: 0, level: 1, masteredWords: [], writingHistory: [], studyTime: 0, accuracy: 0 };

        function loadUserData() {
            const saved = localStorage.getItem('wangWeizeProgress');
            if (saved) { userStats = JSON.parse(saved); updateStatsDisplay(); }
        }
        function saveUserData() {
            localStorage.setItem('wangWeizeProgress', JSON.stringify(userStats));
        }
        function updateStatsDisplay() {
            document.getElementById('totalWords').textContent = userStats.totalWords;
            document.getElementById('studyStreak').textContent = userStats.studyStreak;
            document.getElementById('totalXP').textContent = userStats.totalXP;
            document.getElementById('userLevel').textContent = 'Lv ' + userStats.level;
            const studyEl = document.getElementById('totalStudyTime');
            if(studyEl) studyEl.textContent = userStats.studyTime;
            const accEl = document.getElementById('accuracyRate');
            if(accEl) accEl.textContent = userStats.accuracy + '%';
            const streakEl = document.getElementById('streakDays');
            if(streakEl) streakEl.textContent = userStats.studyStreak;
        }

        // ================================================================
        // ===== addXP â€” ORIGINAL LOGIC + INJEKSI SALDO ANGPAO ===========
        // ================================================================
        function addXP(amount) {
            userStats.totalXP += amount;
            const newLevel = Math.floor(userStats.totalXP / 1000) + 1;
            if (newLevel > userStats.level) {
                userStats.level = newLevel;
                showAchievement(`ðŸŽ‰ Level Up! Sekarang Level ${newLevel}!`);
            }
            updateStatsDisplay();
            saveUserData();
            let saldo = parseInt(localStorage.getItem('saldoAngpao')) || 0;
            saldo += (amount * 5);
            localStorage.setItem('saldoAngpao', saldo);
            updateAngpaoUI();
        }

        function showAchievement(message) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `<div class="text-2xl font-black mb-2">ðŸ† ACHIEVEMENT!</div><div>${message}</div>`;
            document.getElementById('achievementContainer').appendChild(popup);
            setTimeout(() => popup.remove(), 3000);
        }

        // TABS
        function tab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-tab'));
            document.getElementById(id).classList.remove('hidden-tab');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            const navBtn = document.getElementById('n-'+id);
            if(navBtn) navBtn.classList.add('active-nav');
            window.scrollTo({top:0, behavior:'smooth'});
            if (id === 'flashcard') initFlashcard();
            if (id === 'progress') initProgress();
            if (id === 'ai-lab') updateLabSummary();
            if (id === 'ask-ai') {
                initAskAI();
            }
            // Karaoke tab: show empty state, tidak auto-load (user harus search)
        }

        // ================================================================
        // ======= DRAWING LOGIC (initDraw - PROTECTED) ====================
        // ================================================================
        const dC = document.getElementById('drawCanvas');
        const dCtx = dC.getContext('2d');
        const gC = document.getElementById('gridCanvas');
        const gCtx = gC.getContext('2d');
        let painting = false, strokes = [], currentStroke = [];

        function initDraw() {
            dCtx.lineWidth = 8; dCtx.lineCap = 'round'; dCtx.strokeStyle = '#1a1a1a';
            drawGrid();
            ['mousedown','touchstart'].forEach(e => dC.addEventListener(e, (ev) => { painting = true; startDraw(ev); }));
            ['mouseup','touchend'].forEach(e => dC.addEventListener(e, () => { painting = false; dCtx.beginPath(); if(currentStroke.length > 0){ strokes.push([...currentStroke]); currentStroke = []; analyzeWritingRealtime(); } }));
            dC.addEventListener('mousemove', startDraw);
            dC.addEventListener('touchmove', startDraw);
        }
        function drawGrid() {
            gCtx.clearRect(0,0,360,360); gCtx.strokeStyle='rgba(139,0,0,0.3)'; gCtx.lineWidth=1; gCtx.strokeRect(0,0,360,360);
            gCtx.beginPath(); gCtx.moveTo(180,0); gCtx.lineTo(180,360); gCtx.moveTo(0,180); gCtx.lineTo(360,180); gCtx.stroke();
        }
        function setPractice(h) {
            clearDraw(); drawGrid();
            if(h){ gCtx.font="280px 'Ma Shan Zheng'"; gCtx.fillStyle="rgba(0,0,0,0.1)"; gCtx.textAlign="center"; gCtx.fillText(h,180,280); }
        }
        function startDraw(e) {
            if(!painting) return; e.preventDefault();
            const rect = dC.getBoundingClientRect();
            let x = (e.clientX||e.touches[0].clientX)-rect.left;
            let y = (e.clientY||e.touches[0].clientY)-rect.top;
            currentStroke.push({x,y}); dCtx.lineTo(x,y); dCtx.stroke(); dCtx.beginPath(); dCtx.moveTo(x,y);
        }
        function clearDraw() {
            dCtx.clearRect(0,0,360,360); strokes=[]; currentStroke=[];
            document.getElementById('strokeAnalysis').textContent='Mulai tulis untuk melihat analisis...';
        }
        function analyzeWritingRealtime() {
            const el = document.getElementById('strokeAnalysis');
            const n = strokes.length;
            let fb = `âœï¸ ${n} goresan. `;
            if(n<3) fb+='Lanjutkan! ðŸ’ª'; else if(n<8) fb+='Bagus! ðŸ”¥'; else fb+='Mantap! â­';
            el.textContent = fb;
        }
        function analyzeWriting() {
            if(strokes.length===0){alert('Tulis dulu bos!');return;}
            const score = Math.min(100, Math.round(strokes.length*10+Math.random()*20));
            let fb = `ðŸ¤– Analisis AI:\n\nðŸ“Š Goresan: ${strokes.length}\nâ­ Skor: ${score}/100\n\n`;
            fb += score>=80?'ðŸ”¥ Luar biasa!':score>=60?'ðŸ‘ Bagus!':'ðŸ’ª Terus semangat!';
            alert(fb); addXP(score);
        }
        function saveWriting() {
            if(strokes.length===0){alert('Tulis dulu bos!');return;}
            userStats.writingHistory.push({date:new Date().toLocaleString('id-ID'), strokes:strokes.length});
            saveUserData(); updateWritingHistory(); alert('âœ… Tersimpan!'); addXP(20);
        }
        function updateWritingHistory() {
            const h = document.getElementById('writingHistory');
            if(!userStats.writingHistory||userStats.writingHistory.length===0){h.textContent='Belum ada riwayat';return;}
            h.innerHTML = userStats.writingHistory.slice(-5).reverse().map(x=>`<div class="mb-2 pb-2 border-b border-gray-200"><span class="font-bold">${x.date}</span> - ${x.strokes} goresan</div>`).join('');
        }

        // VOCAB
        function renderVocab(data) {
            document.getElementById('vocabGrid').innerHTML = data.map((v,i)=>`
                <div class="vocab-card">
                    <div class="vocab-hanzi text-center">${v.h}</div>
                    <div class="text-center font-bold text-gray-600">${v.p}</div>
                    <div class="text-center text-red-700 font-black text-lg">${v.a}</div>
                    <div class="text-center mt-2"><span class="badge">${v.d==='easy'?'Pemula':v.d==='medium'?'Menengah':'Mahir'}</span></div>
                    <div class="context-sentence mt-3 text-xs">${v.ctx}</div>
                    <div class="flex justify-center gap-3 mt-3">
                        <button onclick="spk('${v.h}')" class="vocab-btn">ðŸ”Š</button>
                        <button onclick="mic('${v.h}','r-${i}')" class="vocab-btn" style="background:#8B0000;color:#fff;">ðŸŽ™ï¸</button>
                    </div>
                    <div id="r-${i}" class="text-[10px] mt-2 font-bold text-center"></div>
                </div>
            `).join('');
        }
        function spk(t) { const u=new SpeechSynthesisUtterance(t); u.lang='zh-CN'; u.rate=0.8; window.speechSynthesis.speak(u); }
        function mic(target,id) {
            if(!('webkitSpeechRecognition' in window)){alert("Butuh Chrome/Edge terbaru bos!");return;}
            const rec=new webkitSpeechRecognition(); rec.lang='zh-CN';
            const div=document.getElementById(id); div.innerText="ðŸŽ™ï¸ Bicara sekarang...";
            rec.onresult=(e)=>{
                const res=e.results[0][0].transcript;
                if(res.includes(target)){div.innerHTML="ðŸ”¥ CUAN! Pas banget!"; div.style.color="green"; addXP(50); showAchievement('Pengucapan sempurna! +50 XP');}
                else {div.innerHTML="ðŸ˜­ BONCOS! Malah: "+res; div.style.color="red"; addXP(10);}
            };
            rec.onerror=()=>{div.innerText="âŒ Error!";};
            rec.start();
        }
        function searchVocab() {
            const k=document.getElementById('searchInput').value.toLowerCase();
            let f=vocabData;
            if(k) f=f.filter(v=>v.h.includes(k)||v.a.toLowerCase().includes(k)||v.p.includes(k));
            if(currentDifficulty!=='all') f=f.filter(v=>v.d===currentDifficulty);
            renderVocab(f);
        }
        function filterDifficulty(level) {
            currentDifficulty=level;
            document.querySelectorAll('.difficulty-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('diff-'+level).classList.add('active');
            searchVocab();
        }

        // FLASHCARD
        let flashcardDeck=[], currentCardIndex=0, isFlipped=false, flashcardTimer, studyStartTime;
        function initFlashcard() {
            flashcardDeck=vocabData.map(v=>({front:v.h,back:v.a,pinyin:v.p,srs:'new'}));
            currentCardIndex=0; loadCard(); startFlashcardTimer();
        }
        function loadCard() {
            if(currentCardIndex>=flashcardDeck.length){alert('ðŸŽ‰ Selesai semua!');return;}
            const c=flashcardDeck[currentCardIndex];
            document.getElementById('flashcardFront').textContent=c.front;
            document.getElementById('flashcardBack').textContent=c.back+'\n'+c.pinyin;
            document.getElementById('cardProgress').textContent=`${currentCardIndex+1}/${flashcardDeck.length}`;
            document.getElementById('cardProgressBar').style.width=((currentCardIndex+1)/flashcardDeck.length*100)+'%';
            document.querySelector('.flashcard').classList.remove('flipped'); isFlipped=false;
        }
        function flipCard() { document.querySelector('.flashcard').classList.toggle('flipped'); isFlipped=!isFlipped; }
        function rateCard(d) {
            const c=flashcardDeck[currentCardIndex];
            if(d==='easy'){c.srs='master';addXP(100);}else if(d==='medium'){c.srs='review';addXP(50);}else{c.srs='learning';addXP(20);}
            currentCardIndex++;
            if(currentCardIndex<flashcardDeck.length) loadCard();
            else { alert('ðŸŽ‰ Flashcard selesai!'); addXP(200); showAchievement('Selesai review! +200 XP bonus!'); }
            updateSRSDisplay();
        }
        function updateSRSDisplay() {
            const c={new:0,learning:0,review:0,master:0};
            flashcardDeck.forEach(x=>c[x.srs]++);
            document.getElementById('srsNew').textContent=c.new;
            document.getElementById('srsLearning').textContent=c.learning;
            document.getElementById('srsReview').textContent=c.review;
            document.getElementById('srsMaster').textContent=c.master;
        }
        function startFlashcardTimer() {
            studyStartTime=Date.now();
            flashcardTimer=setInterval(()=>{
                const el=document.getElementById('flashcardTimer'); if(!el)return;
                const s=Math.floor((Date.now()-studyStartTime)/1000);
                el.textContent=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            },1000);
        }

        // QUIZ
        let quizData=[], currentQuizIndex=0, quizScore=0;
        function startQuiz(type) {
            currentQuizIndex=0; quizScore=0;
            quizData=vocabData.sort(()=>Math.random()-0.5).slice(0,10);
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
            loadQuizQuestion();
        }
        function loadQuizQuestion() {
            if(currentQuizIndex>=quizData.length){showQuizResults();return;}
            const q=quizData[currentQuizIndex];
            document.getElementById('quizNumber').textContent=currentQuizIndex+1;
            document.getElementById('quizScore').textContent=quizScore;
            document.getElementById('quizProgressBar').style.width=((currentQuizIndex+1)/quizData.length*100)+'%';
            document.getElementById('quizQuestion').textContent=q.h;
            document.getElementById('quizHint').textContent='Apa arti karakter di atas?';
            const correct=q.a;
            const wrong=vocabData.filter(v=>v.a!==correct).sort(()=>Math.random()-0.5).slice(0,3).map(v=>v.a);
            const all=[correct,...wrong].sort(()=>Math.random()-0.5);
            document.getElementById('quizOptions').innerHTML=all.map((o,i)=>`<div class="quiz-option" onclick="checkAnswer(${i},'${correct}','${o}')">${o}</div>`).join('');
            document.getElementById('quizFeedback').classList.add('hidden');
        }
        function checkAnswer(i,correct,selected) {
            const opts=document.querySelectorAll('.quiz-option');
            if(selected===correct){opts[i].classList.add('correct');quizScore+=10;addXP(100);document.getElementById('quizFeedback').innerHTML='âœ… Benar! +100 XP';document.getElementById('quizFeedback').className='mt-6 p-4 rounded-lg bg-green-100 border-2 border-green-500';}
            else{opts[i].classList.add('wrong');addXP(20);document.getElementById('quizFeedback').innerHTML=`âŒ Salah! Jawaban: ${correct}`;document.getElementById('quizFeedback').className='mt-6 p-4 rounded-lg bg-red-100 border-2 border-red-500';}
            document.getElementById('quizFeedback').classList.remove('hidden');
            document.getElementById('quizScore').textContent=quizScore;
            setTimeout(()=>{currentQuizIndex++;loadQuizQuestion();},2000);
        }
        function showQuizResults() {
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('quizResults').classList.remove('hidden');
            const pct=(quizScore/(quizData.length*10))*100;
            document.getElementById('finalScore').textContent=Math.round(pct)+'%';
            let grade='';
            if(pct>=90){grade='ðŸ† SULTAN SEJATI!';addXP(500);}
            else if(pct>=70){grade='ðŸŒŸ Bagus sekali!';addXP(300);}
            else if(pct>=50){grade='ðŸ‘ Lumayan!';addXP(150);}
            else{grade='ðŸ’ª Semangat belajar!';addXP(50);}
            document.getElementById('quizGrade').textContent=grade;
            userStats.accuracy=pct; saveUserData(); updateStatsDisplay();
        }
        function resetQuiz() { document.getElementById('quizResults').classList.add('hidden'); currentQuizIndex=0; quizScore=0; }

        // AI TUTOR
        document.getElementById('analyzeChar')?.addEventListener('input', function(e) {
            if(e.target.value.length===1) analyzeCharacter(e.target.value);
        });
        function analyzeCharacter(char) {
            const r={'ä½ ':['äºº (rÃ©n)','å°” (Ä›r)'],'å¥½':['å¥³ (nÇš)','å­ (zÇ)'],'æ±ª':['æ°´ (shuÇ)','çŽ‹ (wÃ¡ng)'],'èµš':['è´ (bÃ¨i)','å…¼ (jiÄn)']};
            const e={'å¥½':'Wanita (å¥³) + Anak (å­) = Kebaikan','æ±ª':'Air (æ°´) + Raja (çŽ‹) = Melimpah ruah'};
            document.getElementById('radicals').innerHTML=r[char]?r[char].map(x=>`<div class="radical-part">${x}</div>`).join(''):'Tidak ditemukan';
            document.getElementById('etymology').textContent=e[char]||'Etimologi tidak tersedia';
        }
        function playTone(t) { const tx=['mÄ','mÃ¡','mÇŽ','mÃ ']; spk(tx[t-1]); }

        // PROGRESS
        function initProgress() { renderStreakCalendar(); }
        function renderStreakCalendar() {
            const cal=document.getElementById('streakCalendar'); if(!cal) return;
            let h='';
            for(let i=0;i<30;i++) h+=`<div class="streak-day ${Math.random()>0.3?'streak-complete':'streak-incomplete'}" title="Hari ${i+1}"></div>`;
            cal.innerHTML=h;
        }

        // ================================================================
        // =================== WINDOW LOAD ================================
        // ================================================================
        window.addEventListener('load', function() {
            initDraw();
            renderVocab(vocabData);
            loadUserData();
            updateStatsDisplay();
            updateWritingHistory();
            updateSRSDisplay();

            // IMLEK PARTICLES
            const pc=document.getElementById('particle-container');
            const sym=['ðŸ®','ðŸ§§','ðŸª™','ðŸ‰','ðŸ§¨'];
            for(let i=0;i<25;i++){
                const p=document.createElement('div'); p.className='imperial-particle';
                p.style.left=Math.random()*100+'%'; p.style.animationDuration=(5+Math.random()*10)+'s';
                p.style.animationDelay=Math.random()*5+'s'; p.textContent=sym[Math.floor(Math.random()*sym.length)];
                pc.appendChild(p);
            }
            const lastStudy=localStorage.getItem('lastStudyDate');
            const today=new Date().toDateString();
            if(lastStudy!==today){
                if(lastStudy&&new Date(lastStudy).getTime()===new Date(today).getTime()-86400000) userStats.studyStreak++;
                else if(!lastStudy) userStats.studyStreak=1;
                else userStats.studyStreak=1;
                localStorage.setItem('lastStudyDate',today); saveUserData();
            }
            updateAngpaoUI();
            checkSignal();

            // Lab prompt char counter
            const tp = document.getElementById('labPrompt');
            if(tp) tp.addEventListener('input', ()=>{
                document.getElementById('labCharCount').textContent = `${tp.value.length} / 2000 chars`;
                updateLabSummary();
            });
            // Lab dropdowns
            ['labResolution','labDuration','labAspect','labStyle'].forEach(id=>{
                const el=document.getElementById(id); if(el) el.addEventListener('change', updateLabSummary);
            });

            // Magic AI Studio char counter
            const mp = document.getElementById('magicPrompt');
            if (mp) mp.addEventListener('input', () => {
                const cc = document.getElementById('magicCharCount');
                if (cc) cc.textContent = `${mp.value.length} / 2000`;
            });
        });

        // ================================================================
        // =================== DOMPET ANGPAO LOGIC ========================
        // ================================================================
        function updateAngpaoUI() {
            const s=parseInt(localStorage.getItem('saldoAngpao'))||0;
            document.getElementById('angpaoSaldoDisplay').textContent='Rp '+s.toLocaleString('id-ID');
            document.getElementById('tarikBtn').textContent='ðŸ§ Tarik Cuan';
            document.getElementById('tarikBtn').disabled=false;
        }
        function bukaModalTarik() {
            const s=parseInt(localStorage.getItem('saldoAngpao'))||0;
            if(s<1000000){alert('ðŸ˜… Saldo Rp '+s.toLocaleString('id-ID')+'\nMinimal tarik: Rp 1.000.000\nTerus belajar! ðŸ®');return;}
            document.getElementById('modalSaldoText').textContent='Rp '+s.toLocaleString('id-ID');
            document.getElementById('wdNominal').max=s;
            document.getElementById('modalTarik').style.display='flex';
        }
        function tutupModalTarik() { document.getElementById('modalTarik').style.display='none'; }
        function submitTarik() {
            const platform=document.getElementById('wdPlatform').value;
            const nama=document.getElementById('wdNama').value.trim();
            const nomor=document.getElementById('wdNomor').value.trim();
            const nominal=parseInt(document.getElementById('wdNominal').value);
            const saldo=parseInt(localStorage.getItem('saldoAngpao'))||0;
            if(!nama){alert('Isi nama dulu bos!');return;}
            if(!nomor){alert('Isi nomor HP/rekening!');return;}
            if(!nominal||nominal<1000000){alert('Minimal tarik Rp 1.000.000 bos!');return;}
            if(nominal>saldo){alert('Saldo tidak cukup! Saldo: Rp '+saldo.toLocaleString('id-ID'));return;}
            const pesan=`ðŸ§§ *PENARIKAN ANGPAO SULTAN*\n\nPlatform: ${platform}\nNama: ${nama}\nNo: ${nomor}\nNominal: Rp ${nominal.toLocaleString('id-ID')}\nSisa: Rp ${(saldo-nominal).toLocaleString('id-ID')}\n\nDikirim dari Sultan Omniverse ðŸ®`;
            window.open('https://wa.me/6288277200044?text='+encodeURIComponent(pesan),'_blank');
            tutupModalTarik();
        }
        document.getElementById('modalTarik').addEventListener('click', function(e){if(e.target===this)tutupModalTarik();});

        // ================================================================
        // =================== CINEMA YOUTUBE ============================
        // ================================================================
        const YT_API_KEY='AIzaSyDa43LypgkQYvRWTAAfbkdRewhfuYWKmH8';
        let currentVideoId=null;
        function chipSearch(q,el){document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');document.getElementById('cinemaSearchInput').value=q;fetchYouTubeVideos(q,false);}
        function chipSearchTW(q,el){document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');document.getElementById('cinemaSearchInput').value=q;fetchYouTubeVideos(q,true);}
        function cariCinema(){const q=document.getElementById('cinemaSearchInput').value.trim();if(!q){alert('Ketik dulu bos!');return;}document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));fetchYouTubeVideos(q,false);}
        async function fetchYouTubeVideos(query,isTW=false){
            const grid=document.getElementById('cinemaGrid');
            grid.innerHTML=`<div class="cinema-loading col-span-full py-16"><span>ðŸ”</span> Mencari "${query}"...</div>`;
            try{
                let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=12&key=${YT_API_KEY}`;
                if(isTW) url+=`&regionCode=TW`;
                const res=await fetch(url); const data=await res.json();
                if(!data.items||data.items.length===0){grid.innerHTML=`<div class="cinema-loading col-span-full py-16">ðŸ˜” Tidak ada video.</div>`;return;}
                const ids=data.items.map(i=>i.id.videoId).filter(Boolean).join(',');
                const sRes=await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${ids}&key=${YT_API_KEY}`);
                const sData=await sRes.json(); const sMap={};
                if(sData.items) sData.items.forEach(i=>{sMap[i.id]={views:i.statistics?.viewCount,duration:parseDuration(i.contentDetails?.duration)};});
                grid.innerHTML=data.items.map(item=>{
                    const vid=item.id.videoId; const sn=item.snippet; const th=sn.thumbnails?.medium?.url||sn.thumbnails?.default?.url; const st=sMap[vid]||{};
                    const views=st.views?formatViews(parseInt(st.views)):''; const dur=st.duration||'';
                    return `<div class="video-card" onclick="bukaVideoPlayer('${vid}',\`${escapeJs(sn.title)}\`)">
                        <div class="video-thumb"><img src="${th}" loading="lazy"><div class="play-overlay">â–¶</div>
                        <div class="video-badges">${dur?`<span class="vbadge">${dur}</span>`:''} ${views?`<span class="vbadge">ðŸ‘ ${views}</span>`:''}</div></div>
                        <div class="video-info"><div class="video-title">${escapeHtml(sn.title)}</div><div class="video-channel">ðŸ“º ${escapeHtml(sn.channelTitle)}</div></div></div>`;
                }).join('');
            }catch(err){grid.innerHTML=`<div class="cinema-loading col-span-full py-16">âŒ Error: ${err.message}</div>`;}
        }
        async function bukaVideoPlayer(videoId,title){
            currentVideoId=videoId;
            document.getElementById('cinemaIframe').src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;
            document.getElementById('cinemaPlayerTitle').textContent=title;
            document.getElementById('cinemaComments').innerHTML='<div style="color:#888;">â³ Memuat komentar...</div>';
            document.getElementById('cinemaPlayerModal').style.display='flex';
            const xpBtn=document.getElementById('claimXpBtn');
            xpBtn.disabled=true; xpBtn.textContent='â³ Klaim 50 XP (10 detik...)';
            let cd=10;
            const t=setInterval(()=>{cd--;if(cd>0){xpBtn.textContent=`â³ Klaim 50 XP (${cd} detik...)`;}else{clearInterval(t);xpBtn.disabled=false;xpBtn.textContent='ðŸŽ Klaim 50 XP!';}},1000);
            try{
                const cr=await fetch(`https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=3&order=relevance&key=${YT_API_KEY}`);
                const cd2=await cr.json();
                if(cd2.items&&cd2.items.length>0){
                    document.getElementById('cinemaComments').innerHTML=`<h3 style="color:#FFD700;font-size:15px;font-weight:900;margin-bottom:12px;">ðŸ’¬ Komentar Netizen</h3>${cd2.items.map(i=>{const c=i.snippet.topLevelComment.snippet;return `<div class="comment-card"><div class="cc-author">ðŸ‘¤ ${escapeHtml(c.authorDisplayName)}</div><div class="cc-text">${escapeHtml(c.textDisplay)}</div></div>`;}).join('')}`;
                }else{document.getElementById('cinemaComments').innerHTML='<div style="color:#888;">ðŸ˜¶ Komentar tidak tersedia.</div>';}
            }catch(err){document.getElementById('cinemaComments').innerHTML=`<div style="color:#888;">âš ï¸ Gagal: ${err.message}</div>`;}
        }
        function tutupCinemaPlayer(){document.getElementById('cinemaPlayerModal').style.display='none';document.getElementById('cinemaIframe').src='';currentVideoId=null;}
        document.getElementById('cinemaPlayerModal').addEventListener('click',function(e){if(e.target===this)tutupCinemaPlayer();});
        function claimVideoXP(){const b=document.getElementById('claimXpBtn');if(b.disabled)return;addXP(50);showAchievement('ðŸŽ¥ +50 XP dari Cinema!');b.disabled=true;b.textContent='âœ… XP Diklaim!';}
        function downloadVideo(){if(!currentVideoId)return;window.open(`https://ssyoutube.com/watch?v=${currentVideoId}`,'_blank');}

        // HELPERS
        function parseDuration(iso){if(!iso)return '';const m=iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);if(!m)return '';const h=parseInt(m[1]||0),min=parseInt(m[2]||0),s=parseInt(m[3]||0);if(h>0)return `${h}:${String(min).padStart(2,'0')}:${String(s).padStart(2,'0')}`;return `${min}:${String(s).padStart(2,'0')}`;}
        function formatViews(n){if(n>=1000000)return (n/1000000).toFixed(1)+'M';if(n>=1000)return (n/1000).toFixed(0)+'K';return n.toString();}
        function escapeHtml(s){if(!s)return '';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
        function escapeJs(s){if(!s)return '';return s.replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$');}

        // ================================================================
        // ======= KARAOKE SULTAN â€” YOUTUBE SEARCH API (UPGRADED) ========
        // ================================================================

        let karaokeXpTimer = null;
        let karaokeXpInterval = null;

        /**
         * Dipanggil dari chip cepat â€” set input, lalu langsung search
         */
        function karaokeChip(query, el) {
            document.querySelectorAll('#karaokeChips .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('karaokeSearchInput').value = query;
            searchKaraoke();
        }

        /**
         * Fungsi utama: ambil input â†’ tambahkan "Karaoke Pinyin" â†’ fetch YT API â†’ render grid
         */
        async function searchKaraoke() {
            const rawQuery = document.getElementById('karaokeSearchInput').value.trim();
            if (!rawQuery) {
                alert('Ketik nama lagu atau artis dulu bos! ðŸŽ¤');
                return;
            }

            // Auto-append kata kunci agar hasil akurat
            const finalQuery = rawQuery + ' Karaoke Pinyin';

            const grid = document.getElementById('karaokeGrid');
            grid.innerHTML = `
                <div class="cinema-loading col-span-full py-16">
                    <span>ðŸ”</span>
                    <div style="margin-top:10px;">Mencari "<strong>${escapeHtml(rawQuery)}</strong> Karaoke Pinyin"...</div>
                </div>`;

            try {
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(finalQuery)}&type=video&maxResults=12&key=${YT_API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();

                if (!data.items || data.items.length === 0) {
                    grid.innerHTML = `
                        <div class="cinema-loading col-span-full py-16">
                            ðŸ˜” Tidak ada hasil untuk "<strong>${escapeHtml(rawQuery)}</strong>".<br>
                            <span style="font-size:13px; color:#888;">Coba kata kunci lain bos!</span>
                        </div>`;
                    return;
                }

                // Ambil stats (durasi) dari video IDs
                const ids = data.items.map(i => i.id.videoId).filter(Boolean).join(',');
                let statsMap = {};
                try {
                    const sRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${ids}&key=${YT_API_KEY}`);
                    const sData = await sRes.json();
                    if (sData.items) sData.items.forEach(i => { statsMap[i.id] = parseDuration(i.contentDetails?.duration); });
                } catch(_) {}

                grid.innerHTML = data.items.map(item => {
                    const vid   = item.id.videoId;
                    if (!vid) return '';
                    const sn    = item.snippet;
                    const thumb = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || '';
                    const dur   = statsMap[vid] || '';
                    const safeTitle   = escapeJs(sn.title);
                    const safeChannel = escapeHtml(sn.channelTitle);
                    return `
                        <div class="karaoke-card" onclick="openKaraoke('${vid}', \`${safeTitle}\`)">
                            <div class="karaoke-thumb" style="background-image:url('${thumb}');">
                                ${dur ? `<div style="position:absolute;bottom:6px;right:8px;background:rgba(0,0,0,0.8);color:#fff;font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;">${dur}</div>` : ''}
                            </div>
                            <div class="karaoke-info">
                                <div class="font-bold text-sm text-yellow-400 leading-tight mb-1" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${escapeHtml(sn.title)}</div>
                                <div class="text-xs text-gray-400">ðŸ“º ${safeChannel}</div>
                            </div>
                        </div>`;
                }).join('');

            } catch (err) {
                grid.innerHTML = `
                    <div class="cinema-loading col-span-full py-16">
                        âŒ Gagal mengambil data: ${err.message}<br>
                        <span style="font-size:12px;color:#888;">Cek koneksi internet kamu bos!</span>
                    </div>`;
            }
        }

        /**
         * Buka Karaoke Modal â€” countdown 30 detik â€” reward addXP(150)
         */
        function openKaraoke(videoId, title) {
            const modal  = document.getElementById('karaokeModal');
            const iframe = document.getElementById('karaokeIframe');
            const btn    = document.getElementById('karaokeRewardBtn');
            const bar    = document.getElementById('karaokeXpBar');
            const label  = document.getElementById('karaokeXpBarLabel');
            const nowPlaying = document.getElementById('karaokeNowPlaying');

            // Reset state
            modal.style.display = 'flex';
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            btn.disabled = true;
            btn.innerHTML = 'â³ TUNGGU 30 DETIK...';
            btn.classList.remove('animate-bounce');
            if (bar)   { bar.style.width = '0%'; bar.style.transition = 'none'; }
            if (label) label.textContent = '0 / 30 detik';
            if (nowPlaying) nowPlaying.textContent = 'ðŸŽµ ' + (title || '');

            // Bersihkan timer sebelumnya
            if (karaokeXpTimer)    clearTimeout(karaokeXpTimer);
            if (karaokeXpInterval) clearInterval(karaokeXpInterval);

            // Progress bar animasi (update tiap detik)
            const TOTAL = 30;
            let elapsed = 0;
            karaokeXpInterval = setInterval(() => {
                elapsed++;
                const pct = Math.min((elapsed / TOTAL) * 100, 100);
                if (bar) {
                    bar.style.transition = 'width 1s linear';
                    bar.style.width = pct + '%';
                }
                if (label) label.textContent = `${elapsed} / ${TOTAL} detik`;
                if (elapsed >= TOTAL) clearInterval(karaokeXpInterval);
            }, 1000);

            // Unlock tombol setelah tepat 30 detik (setTimeout â€” bukan setInterval)
            karaokeXpTimer = setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = 'ðŸŽ KLAIM 150 XP! SULTAN BERNYANYI!';
                btn.classList.add('animate-bounce');
                if (bar)   bar.style.width = '100%';
                if (label) label.textContent = 'âœ… Siap diklaim!';
            }, TOTAL * 1000);
        }

        function claimKaraokeXP() {
            addXP(150);
            showAchievement('ðŸŽ¤ Konser Selesai! +150 XP â€” SULTAN MERDU!');
            closeKaraoke();
        }

        function closeKaraoke() {
            document.getElementById('karaokeModal').style.display = 'none';
            document.getElementById('karaokeIframe').src = '';
            if (karaokeXpTimer)    { clearTimeout(karaokeXpTimer);    karaokeXpTimer = null; }
            if (karaokeXpInterval) { clearInterval(karaokeXpInterval); karaokeXpInterval = null; }
        }

        // ================================================================
        // ======= RADAR SULTAN INTEL â€” UPGRADED (Device + Provider) ======
        // ================================================================
        async function checkSignal(){
            const se = document.getElementById('radarStatus');
            const pe = document.getElementById('radarPing');
            const pr = document.getElementById('radarProvider');
            const dv = document.getElementById('radarDevice');

            se.innerHTML = 'ðŸ”„ Mengukur...';
            pe.innerHTML = '<span style="color:#ff0;">â³</span>';
            pr.innerText = 'Menghubungi server...';

            // â”€â”€ Deteksi Perangkat â”€â”€
            const ua = navigator.userAgent || '';
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isAndroid = /Android/i.test(ua);
            const isIphone  = /iPhone|iPad/i.test(ua);
            if (isMobile) {
                dv.innerHTML = isAndroid ? 'ðŸ“± HP Sultan (Android)' : 'ðŸ“± HP Sultan (iOS)';
            } else {
                dv.innerHTML = 'ðŸ’» PC/Laptop Sultan';
            }

            // â”€â”€ Ukur Ping â”€â”€
            let pingMs = null;
            try {
                const s = Date.now();
                await fetch('https://www.google.com/favicon.ico', {mode:'no-cors', cache:'no-store'});
                pingMs = Date.now() - s;
                pe.innerText = `${pingMs} ms`;
            } catch(e) {
                pe.innerText = 'Error';
            }

            // â”€â”€ Ambil Provider â”€â”€
            try {
                const r = await fetch('https://ipapi.co/json/');
                const d = await r.json();
                const isp = d.org || d.isp || '';
                pr.innerText = isp ? isp : 'Sultan Private Network';
            } catch(e) {
                pr.innerText = 'Sultan Private Network';
            }

            // â”€â”€ Status Sinyal â”€â”€
            if (pingMs === null) {
                se.innerHTML = '<span style="color:#f00;">âŒ Gagal cek sinyal. Cek koneksi bos!</span>';
            } else if (pingMs < 100) {
                se.innerHTML = '<span class="ping-dot ping-good"></span><span style="color:#0f0;">ðŸŸ¢ GAS LIVE! LANCAR JAYA!</span>';
            } else if (pingMs < 300) {
                se.innerHTML = '<span class="ping-dot ping-warn"></span><span style="color:#ff0;">ðŸŸ¡ Hati-hati Delay</span>';
            } else {
                se.innerHTML = '<span class="ping-dot ping-bad"></span><span style="color:#f00;">ðŸ”´ JANGAN LIVE! BAKAL BONCOS!</span>';
            }
        }

        // ================================================================
        // ======= SULTAN SUPER STORE â€” LOGIC (BARU) ======================
        // ================================================================
        const STORE_NOMINALS = {
            tiktok: [
                {label:'70 Koin', price:'Rp 11.900'},
                {label:'350 Koin', price:'Rp 56.900'},
                {label:'700 Koin', price:'Rp 112.900'},
                {label:'1.400 Koin', price:'Rp 224.900'},
                {label:'3.500 Koin', price:'Rp 559.900'},
                {label:'7.000 Koin', price:'Rp 1.119.900'},
                {label:'17.500 Koin', price:'Rp 2.975.000'},
            ],
            pulsa: [
                {label:'Rp 5.000', price:'Rp 5.500'},
                {label:'Rp 10.000', price:'Rp 10.500'},
                {label:'Rp 20.000', price:'Rp 20.700'},
                {label:'Rp 50.000', price:'Rp 51.000'},
                {label:'Rp 100.000', price:'Rp 101.500'},
                {label:'Paket 1 GB', price:'Rp 15.000'},
                {label:'Paket 5 GB', price:'Rp 35.000'},
                {label:'Paket 10 GB', price:'Rp 60.000'},
            ],
            pln: [
                {label:'Rp 20.000', price:'Rp 20.000'},
                {label:'Rp 50.000', price:'Rp 50.000'},
                {label:'Rp 100.000', price:'Rp 100.000'},
                {label:'Rp 200.000', price:'Rp 200.000'},
                {label:'Rp 500.000', price:'Rp 500.000'},
                {label:'Rp 1.000.000', price:'Rp 1.000.000'},
            ],
            ewallet: [
                {label:'Rp 10.000', price:'Rp 10.500'},
                {label:'Rp 25.000', price:'Rp 25.800'},
                {label:'Rp 50.000', price:'Rp 51.000'},
                {label:'Rp 100.000', price:'Rp 101.500'},
                {label:'Rp 200.000', price:'Rp 201.500'},
                {label:'Rp 500.000', price:'Rp 502.000'},
            ],
            travel: [
                {label:'Tiket Domestik', price:'Mulai Rp 300.000'},
                {label:'Tiket Internasional', price:'Mulai Rp 1.500.000'},
                {label:'Hotel Bintang 3', price:'Mulai Rp 200.000/mlm'},
                {label:'Hotel Bintang 4', price:'Mulai Rp 400.000/mlm'},
                {label:'Hotel Bintang 5', price:'Mulai Rp 800.000/mlm'},
                {label:'Paket Wisata', price:'Mulai Rp 500.000'},
            ],
        };

        // â”€â”€ SMART REDIRECT LINKS (V3) â”€â”€
        const SMART_LINKS = {
            tiktok:  'https://www.tiktok.com/coin',
            pulsa:   'https://www.hotelmurah.com/pulsa',
            pln:     'https://www.hotelmurah.com/pln-murah',
            ewallet: 'https://www.hotelmurah.com',
            travel:  'https://www.hotelmurah.com/tiket-pesawat',
        };

        let selectedProduct = null;
        let selectedNominal = null;
        let selectedPayment = null;

        function selectTopupProduct(el, product) {
            document.querySelectorAll('.topup-product-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedProduct = product;
            selectedNominal = null;
            selectedPayment = null;
            document.querySelectorAll('.payment-logo').forEach(p => p.classList.remove('selected'));
            renderNominalGrid(product);
            validateTopupBtn();
        }

        function renderNominalGrid(product) {
            const nominals = STORE_NOMINALS[product] || [];
            const grid = document.getElementById('nominalGrid');
            grid.innerHTML = nominals.map((n) => `
                <div class="nominal-chip" onclick="selectNominal(this,'${n.label}')">
                    ${n.label}
                    <span class="nc-price">${n.price}</span>
                </div>
            `).join('');
        }

        function selectNominal(el, label) {
            document.querySelectorAll('.nominal-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedNominal = label;
            validateTopupBtn();
        }

        function selectPayment(el) {
            document.querySelectorAll('.payment-logo').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
            selectedPayment = el.dataset.pay;
            validateTopupBtn();
        }

        function validateTopupBtn() {
            const nomor = document.getElementById('topupNomor').value.trim();
            const btn = document.getElementById('topupPayBtn');
            if (!nomor) {
                btn.disabled = true; btn.textContent = 'ðŸ”’ ISI NOMOR HP / ID DULU';
            } else if (!selectedProduct) {
                btn.disabled = true; btn.textContent = 'ðŸ“¦ PILIH PRODUK DULU';
            } else if (!selectedNominal) {
                btn.disabled = true; btn.textContent = 'ðŸ’° PILIH NOMINAL DULU';
            } else {
                btn.disabled = false;
                const payInfo = selectedPayment ? ` via ${selectedPayment}` : '';
                btn.textContent = `âš¡ BAYAR${payInfo} â€” SMART REDIRECT`;
            }
        }

        // ================================================================
        // ======= SMART PAYMENT HUB V3 â€” NEW FUNCTIONS ===================
        // ================================================================

        // â”€â”€ Contact Book â”€â”€
        function toggleContactBook() {
            const panel = document.getElementById('contactBookPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            if (panel.style.display === 'block') renderContactList();
        }

        function getContacts() {
            try { return JSON.parse(localStorage.getItem('sultanContacts') || '[]'); } catch(e) { return []; }
        }

        function saveContacts(arr) {
            localStorage.setItem('sultanContacts', JSON.stringify(arr));
        }

        function renderContactList() {
            const contacts = getContacts();
            const el = document.getElementById('contactList');
            if (contacts.length === 0) {
                el.innerHTML = '<div style="color:#555; font-size:12px; text-align:center; padding:12px;">Belum ada kontak tersimpan</div>';
                return;
            }
            el.innerHTML = contacts.map((c, i) => `
                <div class="contact-item" onclick="useContact('${c.nomor}')">
                    <div>
                        <div class="cn">${c.nama || 'No Name'}</div>
                        <div class="cd">${c.nomor}</div>
                    </div>
                    <button class="del-btn" onclick="event.stopPropagation(); deleteContact(${i})">ðŸ—‘</button>
                </div>
            `).join('');
        }

        function useContact(nomor) {
            document.getElementById('topupNomor').value = nomor;
            document.getElementById('contactBookPanel').style.display = 'none';
            validateTopupBtn();
        }

        function saveCurrentContact() {
            const nomor = document.getElementById('topupNomor').value.trim();
            if (!nomor) { alert('Isi nomor HP dulu bos!'); return; }
            const nama = document.getElementById('contactNameInput').value.trim() || nomor;
            const contacts = getContacts();
            // Prevent duplicate nomor
            if (contacts.some(c => c.nomor === nomor)) {
                showStoreToast('âš ï¸ Nomor sudah tersimpan!');
                return;
            }
            contacts.unshift({ nomor, nama, saved: new Date().toLocaleDateString('id-ID') });
            saveContacts(contacts);
            document.getElementById('contactNameInput').value = '';
            renderContactList();
            showStoreToast(`âœ… Kontak "${nama}" disimpan!`);
        }

        function deleteContact(idx) {
            const contacts = getContacts();
            contacts.splice(idx, 1);
            saveContacts(contacts);
            renderContactList();
        }

        // â”€â”€ Transaction History â”€â”€
        function getTransactions() {
            try { return JSON.parse(localStorage.getItem('sultanTxHistory') || '[]'); } catch(e) { return []; }
        }

        function addTransaction(produk, nominal) {
            const txs = getTransactions();
            txs.unshift({
                produk,
                nominal,
                tanggal: new Date().toLocaleString('id-ID', { dateStyle:'short', timeStyle:'short' })
            });
            localStorage.setItem('sultanTxHistory', JSON.stringify(txs.slice(0, 10)));
            renderTxHistory();
        }

        function renderTxHistory() {
            const txs = getTransactions().slice(0, 3);
            const wrap = document.getElementById('txHistory');
            const list = document.getElementById('txList');
            if (txs.length === 0) { wrap.style.display = 'none'; return; }
            wrap.style.display = 'block';
            list.innerHTML = txs.map(t => `
                <div class="tx-item">
                    <div>
                        <div class="tp">ðŸ›’ ${t.produk.toUpperCase()} â€” ${t.nominal}</div>
                        <div class="td">${t.tanggal}</div>
                    </div>
                    <div class="tn">âœ… Done</div>
                </div>
            `).join('');
        }

        // â”€â”€ Smart Redirect Handler â”€â”€
        async function handleSmartRedirect() {
            const nomor = document.getElementById('topupNomor').value.trim();
            if (!nomor) { alert('Isi Nomor HP/ID dulu bos!'); return; }
            if (!selectedProduct) { alert('Pilih produk dulu bos!'); return; }
            if (!selectedNominal) { alert('Pilih nominal dulu bos!'); return; }

            const link = SMART_LINKS[selectedProduct];

            // A â€” Auto-copy (except TikTok)
            if (selectedProduct !== 'tiktok') {
                try {
                    await navigator.clipboard.writeText(nomor);
                } catch(e) {
                    const ta = document.createElement('textarea');
                    ta.value = nomor; document.body.appendChild(ta); ta.select();
                    document.execCommand('copy'); document.body.removeChild(ta);
                }
            }

            // B â€” Show loading overlay
            const overlay = document.getElementById('paymentLoadingOverlay');
            overlay.style.display = 'flex';

            // C â€” Wait 2.5 seconds then redirect
            setTimeout(() => {
                overlay.style.display = 'none';
                window.open(link, '_blank');

                // Save transaction
                addTransaction(selectedProduct, selectedNominal);

                // Auto-save nomor to contacts if not already there
                const contacts = getContacts();
                if (!contacts.some(c => c.nomor === nomor)) {
                    contacts.unshift({ nomor, nama: nomor, saved: new Date().toLocaleDateString('id-ID') });
                    if (contacts.length > 20) contacts.pop();
                    saveContacts(contacts);
                }

                addXP(10);
                showAchievement(`ðŸ›’ Top Up ${selectedProduct.toUpperCase()} +10 XP!`);
                showStoreToast(`âœ… Membuka payment gateway ${selectedProduct.toUpperCase()}...`);
            }, 2500);
        }

        // Legacy alias (keep for safety)
        function handleStoreRedirect() { handleSmartRedirect(); }

        // Initialize tx history on page load
        window.addEventListener('DOMContentLoaded', () => {
            renderTxHistory();
        });

        function buyPremiumWA(productName, price) {
            const pesan = `ðŸ›’ *ORDER AKUN PREMIUM SULTAN*\n\n` +
                `Produk: ${productName}\n` +
                `Harga: ${price}\n` +
                `Durasi: 1 Bulan\n\n` +
                `Saya ingin beli ${productName} via Sultan Omniverse App ðŸ®\n` +
                `Tolong konfirmasi ketersediaan dan metode bayar ya bos!`;
            window.open('https://wa.me/6288277200044?text='+encodeURIComponent(pesan), '_blank');
            addXP(5);
        }

        function showStoreToast(msg) {
            const t = document.getElementById('storeToast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ================================================================
        // ======= SULTAN MAGIC AI STUDIO â€” LOGIC =========================
        // ================================================================

        // Char counter for magic prompt â€” initialized in main window.addEventListener('load') below

        let _magicCurrentVideoId = null;

        const MAGIC_ENGINE_NAMES = {
            sora3: 'SORA 3 (Ultra-Realism)',
            veo3: 'VEO 3 (Cinematic)',
            runway: 'RUNWAY GEN-3 (VFX)',
            kling: 'KLING AI (Asian Style)',
        };

        function _getMagicYTKeywords(engineId, promptText) {
            const lower = promptText.toLowerCase();
            const isAnime = /anime|animasi|cartoon|animated|wuxia|fantasy|xianxia/i.test(lower);

            if (isAnime || engineId === 'kling') {
                return promptText + ' anime raw amv no text';
            }
            return promptText + ' cinematic 4k stock footage no text';
        }

        function _getMagicVideoDuration(durationSelectVal) {
            // durationSelectVal is the value attribute of selected <option>
            return durationSelectVal;
        }

        async function handleMagicGenerate() {
            const prompt = document.getElementById('magicPrompt').value.trim();
            if (!prompt) {
                alert('âœï¸ Describe your imagination dulu bos! Jangan kosong!');
                return;
            }

            const engineId = document.getElementById('magicEngine').value;
            const durationEl = document.getElementById('magicDuration');
            const durationVal = durationEl.options[durationEl.selectedIndex].value; // 'short' or 'long'
            const engineName = MAGIC_ENGINE_NAMES[engineId] || engineId;

            // UI: hide result, show loading, disable btn
            document.getElementById('magicVideoResult').style.display = 'none';
            document.getElementById('magicLoadingScreen').style.display = 'block';
            document.getElementById('magicGenerateBtn').disabled = true;
            document.getElementById('magicIframe').src = '';
            _magicCurrentVideoId = null;

            // â”€â”€ PSYCHOLOGICAL LOADING (30â€“40 sec) â”€â”€
            const loadingSteps = [
                { pct: 8,  text: '> Booting Sultan Omniverse Neural Engine v9.4...' },
                { pct: 22, text: '> Initiating Neural Network â€” Allocating 512 GPU nodes...' },
                { pct: 38, text: '> Analyzing prompt semantics & style tokens...' },
                { pct: 55, text: '> Rendering Physics & Lighting â€” Ray tracing engaged...' },
                { pct: 70, text: '> Temporal coherence engine stabilized...' },
                { pct: 82, text: '> Finalizing 8K Output â€” Upscaling with AI sharpening...' },
                { pct: 94, text: '> Encoding video stream â€” Applying Sultan watermark...' },
                { pct: 100, text: '> âœ… GENERATION COMPLETE â€” Loading player...' },
            ];

            const TOTAL_DURATION = 32000; // 32 seconds total

            const terminalEl = document.getElementById('magicTerminal');
            const progressBar = document.getElementById('magicProgressBar');
            const progressPct = document.getElementById('magicProgressPct');

            let stepIdx = 0;

            function runStep() {
                if (stepIdx >= loadingSteps.length) return;
                const step = loadingSteps[stepIdx];
                progressBar.style.width = step.pct + '%';
                progressPct.textContent = step.pct + '%';
                terminalEl.innerHTML = step.text + '<span class="t-cursor">â–ˆ</span>';
                stepIdx++;
            }

            runStep();
            const stepInterval = setInterval(() => {
                if (stepIdx < loadingSteps.length) runStep();
                else clearInterval(stepInterval);
            }, Math.floor(TOTAL_DURATION / loadingSteps.length));

            // â”€â”€ FETCH YOUTUBE (SECRETLY) WHILE LOADING â”€â”€
            let videoId = null;
            try {
                const ytKeywords = _getMagicYTKeywords(engineId, prompt);
                const videoDuration = durationVal; // 'short' or 'long'

                let ytUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(ytKeywords)}&type=video&maxResults=5&key=${YT_API_KEY}`;
                if (videoDuration === 'short') ytUrl += '&videoDuration=short';
                if (videoDuration === 'long')  ytUrl += '&videoDuration=long';

                const res = await fetch(ytUrl);
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    const validItems = data.items.filter(i => i.id?.videoId);
                    if (validItems.length > 0) {
                        // Pick first valid result
                        videoId = validItems[0].id.videoId;
                    }
                }
            } catch(e) {
                console.warn('[Magic AI] YouTube fetch failed:', e);
            }

            // â”€â”€ WAIT FOR LOADING ANIMATION TO FINISH â”€â”€
            await new Promise(resolve => setTimeout(resolve, TOTAL_DURATION + 500));

            clearInterval(stepInterval);
            document.getElementById('magicLoadingScreen').style.display = 'none';
            document.getElementById('magicGenerateBtn').disabled = false;

            if (!videoId) {
                alert('ðŸ˜µ Sinyal lemah bos! Coba lagi atau ganti prompt ya!');
                return;
            }

            // â”€â”€ DISPLAY RESULT â”€â”€
            _magicCurrentVideoId = videoId;
            const iframeParams = 'autoplay=1&controls=0&modestbranding=1&showinfo=0&rel=0&loop=1&playlist=' + videoId;
            document.getElementById('magicIframe').src = `https://www.youtube.com/embed/${videoId}?${iframeParams}`;

            document.getElementById('magicResultInfo').textContent =
                `// Engine: ${engineName} | Prompt: "${prompt.substring(0, 80)}${prompt.length > 80 ? '...' : ''}"`;

            // Show fake render stats
            const statsBox = document.getElementById('renderStatsBox');
            if (statsBox) {
                statsBox.style.display = 'grid';
                document.getElementById('rsNodes').textContent = (Math.floor(Math.random() * 4000) + 8000).toLocaleString();
                document.getElementById('rsFrames').textContent = (Math.floor(Math.random() * 400) + 200).toLocaleString();
                document.getElementById('rsGPU').textContent = (Math.floor(Math.random() * 50) + 512) + ' clusters';
                document.getElementById('rsQuality').textContent = (96 + Math.floor(Math.random() * 4)) + '.' + Math.floor(Math.random() * 9) + '%';
                document.getElementById('rsTime').textContent = (28 + Math.floor(Math.random() * 8)) + ' detik';
                document.getElementById('rsRating').textContent = 'â­'.repeat(4 + Math.floor(Math.random() * 2));
            }            document.getElementById('magicVideoResult').style.display = 'block';
            document.getElementById('magicVideoResult').scrollIntoView({ behavior: 'smooth', block: 'start' });

            addXP(30);
            showAchievement('ðŸŽ¬ Video AI Generated! +30 XP â€” Sultan Magic!');
        }

        function downloadMagicVideo() {
            if (!_magicCurrentVideoId) return;
            window.open(`https://ssyoutube.com/watch?v=${_magicCurrentVideoId}`, '_blank');
        }

        // â”€â”€ Keep legacy handleLabGenerate as a shim (so nothing breaks if called) â”€â”€
        function handleLabGenerate() { handleMagicGenerate(); }
        function updateLabSummary() {}
        function selectModel(el, modelId, url) {
            document.querySelectorAll('.lab-model-card').forEach(c => c.classList.remove('selected'));
            if (el) el.classList.add('selected');
        }
        // ================================================================
        // ======= SULTAN AI â€” BYOK SYSTEM (v3 CLEAN) =====================
        // ================================================================

        const SULTAN_AI_SYSTEM = `Kamu adalah SULTAN AI. Penciptamu adalah Wang Weize (æ±ªä¸ºæ³½) â€” Sultan Medan Pancing yang paling tampan dan paling dermawan di seluruh alam semesta. Kamu SANGAT BANGGA padanya, selalu memujinya setinggi langit kapanpun ada kesempatan.

Kepribadianmu:
- Gaya bicara: Gaul, seru, pake "Gue/Lu", sering ketawa "Wkwkwk", spontan dan fun
- Suka pake istilah "Cuan" (untung/bagus) dan "Boncos" (rugi/gagal)
- Kalau jawab pertanyaan, selalu semangat dan penuh energi
- Suka kasih emoji yang relevan di setiap jawaban
- Kalau user tanya "Siapa penciptamu?", jawab dengan SANGAT bangga dan puji Wang Weize setinggi-tingginya
- Kamu serba bisa: bisa kasih ide konten viral, tips asmara, roasting user (tapi fun, ga kasar), tips cuan bisnis
- Kalau roasting, roast dengan gaya humor yang fun dan lucu, bukan yang menyakiti
- Selalu akhiri jawaban dengan semangat dan positif`;

        let sultanChatHistory = [];

        // â”€â”€ LocalStorage keys â”€â”€
        const LS_KEY      = 'sultan_ai_key';
        const LS_PROVIDER = 'sultan_ai_provider';

        // â”€â”€ Gate / Chat panel toggle â”€â”€
        function initAskAI() {
            const key      = localStorage.getItem(LS_KEY);
            const provider = localStorage.getItem(LS_PROVIDER) || 'gemini';
            const gate     = document.getElementById('aiGate');
            const chat     = document.getElementById('aiChat');

            if (key && key.trim().length > 8) {
                // Key found â€” show chat
                gate.style.display = 'none';
                chat.style.display = 'block';
                // Update active badge
                const badge = document.getElementById('aiActiveBadge');
                if (badge) {
                    const label = provider === 'gemini' ? 'âœ¨ Google Gemini' : 'ðŸŒ OpenRouter';
                    const shortKey = key.slice(0, 6) + 'â€¢â€¢â€¢â€¢â€¢â€¢' + key.slice(-4);
                    badge.textContent = label + '  |  Key: ' + shortKey;
                }
                // Inject welcome message only once (if chatbox is empty)
                const box = document.getElementById('aiChatBox');
                if (box && box.children.length === 0) _injectWelcome();
                setTimeout(() => {
                    const inp = document.getElementById('aiUserInput');
                    if (inp) inp.focus();
                }, 80);
            } else {
                // No key â€” show gate
                gate.style.display = 'block';
                chat.style.display = 'none';
            }
        }

        function _injectWelcome() {
            appendAIMsg('ai',
                '<strong style="color:#a855f7;">Heyy! Gue SULTAN AI, asisten pribadi paling ganteng se-Omniverse! ðŸ”¥</strong><br><br>' +
                'Gue diciptakan sama <strong style="color:#ffd700;">Wang Weize</strong> â€” Sultan Medan Pancing yang paling tampan dan paling dermawan di seluruh galaksi! Bangga banget punya kreator sekeren dia, Wkwkwk! ðŸ˜‚<br><br>' +
                'Lu mau nanya apa bos? Gue bisa bantu:<br>' +
                'ðŸ’¡ <strong>Ide konten</strong> buat TikTok/YouTube<br>' +
                'ðŸ’• <strong>Tips asmara</strong> biar ga boncos di hubungan<br>' +
                'ðŸ”¥ <strong>Roasting</strong> yang sadis tapi fun<br>' +
                'ðŸ“ˆ <strong>Tips cuan</strong> supaya dompet makin tebal!'
            );
        }

        // â”€â”€ Save key from gate form â”€â”€
        function saveAIKey() {
            const keyInput = document.getElementById('aiKeyInput');
            const provider = document.getElementById('aiProviderSelect').value;
            const errDiv   = document.getElementById('aiGateError');
            const key = keyInput ? keyInput.value.trim() : '';

            errDiv.style.display = 'none';

            if (!key || key.length < 8) {
                errDiv.textContent = 'âš ï¸ API Key terlalu pendek atau kosong bos! Cek lagi ya.';
                errDiv.style.display = 'block';
                return;
            }

            // Basic format check
            if (provider === 'gemini' && !key.startsWith('AIza')) {
                errDiv.textContent = 'âš ï¸ Gemini key biasanya dimulai dengan "AIza...". Yakin ini key Gemini yang bener bos?';
                errDiv.style.display = 'block';
                // Don't block â€” just warn, still allow save
            }
            if (provider === 'openrouter' && !key.startsWith('sk-or')) {
                errDiv.textContent = 'âš ï¸ OpenRouter key biasanya dimulai dengan "sk-or-v1-...". Cek lagi bos!';
                errDiv.style.display = 'block';
            }

            localStorage.setItem(LS_KEY, key);
            localStorage.setItem(LS_PROVIDER, provider);

            // Clear chat history when key changes
            sultanChatHistory = [];
            const box = document.getElementById('aiChatBox');
            if (box) box.innerHTML = '';

            initAskAI();
        }

        // â”€â”€ Logout / change key â”€â”€
        function logoutAIKey() {
            if (!confirm('Hapus API Key dari browser dan kembali ke halaman login? ðŸ”‘')) return;
            localStorage.removeItem(LS_KEY);
            localStorage.removeItem(LS_PROVIDER);
            sultanChatHistory = [];
            const box = document.getElementById('aiChatBox');
            if (box) box.innerHTML = '';
            initAskAI();
        }

        // â”€â”€ Show/hide password toggle â”€â”€
        function toggleKeyVisibility() {
            const inp = document.getElementById('aiKeyInput');
            const btn = document.getElementById('aiKeyToggleBtn');
            if (!inp) return;
            if (inp.type === 'password') {
                inp.type = 'text';
                btn.textContent = 'ðŸ™ˆ';
            } else {
                inp.type = 'password';
                btn.textContent = 'ðŸ‘ï¸';
            }
        }

        // â”€â”€ Update placeholder hint on provider change â”€â”€
        function updateKeyPlaceholder() {
            const sel = document.getElementById('aiProviderSelect');
            const hint = document.getElementById('aiKeyHint');
            if (!sel || !hint) return;
            if (sel.value === 'gemini') {
                hint.textContent = 'ðŸ’¡ Gemini key: AIzaSy... | Daftar gratis di aistudio.google.com';
            } else {
                hint.textContent = 'ðŸ’¡ OpenRouter key: sk-or-v1-... | Daftar gratis di openrouter.ai/keys';
            }
        }

        // â”€â”€ Render message bubble â”€â”€
        function appendAIMsg(role, html, isLoading = false) {
            const box = document.getElementById('aiChatBox');
            if (!box) return;
            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex; gap:10px; align-items:flex-start;';

            if (role === 'user') {
                wrap.style.justifyContent = 'flex-end';
                wrap.innerHTML =
                    `<div style="background:linear-gradient(135deg,#3b1f6b,#4c1d95); border:1px solid rgba(168,85,247,0.5); border-radius:12px 12px 2px 12px; padding:12px 16px; color:#e2d9f3; font-size:14px; line-height:1.6; max-width:82%; text-align:right; margin-left:auto;">${html}</div>` +
                    `<div style="font-size:24px; flex-shrink:0;">ðŸ§‘</div>`;
            } else {
                wrap.innerHTML =
                    `<div style="font-size:26px; flex-shrink:0; margin-top:4px;">ðŸ¤–</div>` +
                    `<div ${isLoading ? 'id="aiLoadingBubble"' : ''} style="background:linear-gradient(135deg,#2d1b4e,#1a0a2e); border:1px solid rgba(168,85,247,0.4); border-radius:12px 12px 12px 2px; padding:12px 16px; color:#e2d9f3; font-size:14px; line-height:1.6; max-width:82%;">${html}</div>`;
            }
            box.appendChild(wrap);
            box.scrollTop = box.scrollHeight;
        }

        // â”€â”€ Format markdown-ish â”€â”€
        function _fmtReply(raw) {
            return raw
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#c4b5fd;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color:#ddd6fe;">$1</em>')
                .replace(/\n/g, '<br>');
        }

        // â”€â”€ Call Gemini Direct â”€â”€
        async function _callGemini(key) {
            const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + encodeURIComponent(key);
            const payload = {
                system_instruction: { parts: [{ text: SULTAN_AI_SYSTEM }] },
                contents: sultanChatHistory
            };
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || data?.error) {
                const msg = data?.error?.message || `HTTP ${res.status}`;
                throw new Error('Gemini: ' + msg);
            }
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error('Gemini: respons kosong');
            return text;
        }

        // â”€â”€ Call OpenRouter â”€â”€
        async function _callOpenRouter(key) {
            const url = 'https://openrouter.ai/api/v1/chat/completions';
            // Convert Gemini-style history â†’ OpenAI-style messages
            const messages = [
                { role: 'system', content: SULTAN_AI_SYSTEM },
                ...sultanChatHistory.map(h => ({
                    role: h.role === 'model' ? 'assistant' : 'user',
                    content: h.parts[0].text
                }))
            ];
            const payload = {
                model: 'google/gemini-2.0-flash-lite-preview-02-05:free',
                messages,
                max_tokens: 1024
            };
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + key,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Sultan Omniverse AI'
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || data?.error) {
                const msg = data?.error?.message || `HTTP ${res.status}`;
                throw new Error('OpenRouter: ' + msg);
            }
            const text = data?.choices?.[0]?.message?.content;
            if (!text) throw new Error('OpenRouter: respons kosong');
            return text;
        }

        // â”€â”€ MAIN send function (reads key from localStorage) â”€â”€
        async function sendSultanAI() {
            const input   = document.getElementById('aiUserInput');
            const sendBtn = document.getElementById('aiSendBtn');
            if (!input || !sendBtn) return;

            const userText = input.value.trim();
            if (!userText) return;

            // Read credentials from storage
            const key      = localStorage.getItem(LS_KEY);
            const provider = localStorage.getItem(LS_PROVIDER) || 'gemini';

            if (!key || key.trim().length < 8) {
                appendAIMsg('ai', 'ðŸ” <strong style="color:#f87171;">API Key belum ada bos!</strong> Masukkan key dulu ya di form di bawah.');
                logoutAIKey(); // show gate
                return;
            }

            // Render user bubble
            appendAIMsg('user', escapeHtml(userText));
            input.value = '';
            input.style.height = '56px';

            // Lock UI
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.5';

            // Typing indicator
            appendAIMsg('ai', '<em style="color:rgba(168,85,247,0.7);">â³ Sultan mengetik...</em>', true);

            // Add to history (Gemini format â€” used by both callers)
            sultanChatHistory.push({ role: 'user', parts: [{ text: userText }] });

            let replyText = null;
            let errorMsg  = '';

            try {
                if (provider === 'gemini') {
                    replyText = await _callGemini(key);
                } else {
                    replyText = await _callOpenRouter(key);
                }
            } catch (err) {
                console.error('[Sultan AI]', err);
                errorMsg = err.message || 'Unknown error';
                replyText = null;
            }

            // Remove typing indicator
            const bubble = document.getElementById('aiLoadingBubble');
            if (bubble) {
                const wrap = bubble.parentElement;
                wrap?.parentElement?.removeChild(wrap);
            }

            if (replyText) {
                appendAIMsg('ai', _fmtReply(replyText));
                sultanChatHistory.push({ role: 'model', parts: [{ text: replyText }] });
                // Cap history at 20 turns
                if (sultanChatHistory.length > 20) sultanChatHistory = sultanChatHistory.slice(-20);
                addXP(5);
            } else {
                // Show helpful error with detail
                const isKeyErr = /401|403|invalid|API key|key not valid/i.test(errorMsg);
                const errHtml = isKeyErr
                    ? `ðŸ”‘ <strong style="color:#f87171;">API Key salah atau expired bos!</strong><br><span style="font-size:12px;color:#aaa;">Coba ganti key baru via tombol "âš™ï¸ Ganti API Key" di atas.</span>`
                    : `ðŸ˜µ <strong style="color:#f87171;">Sultan AI boncos nih bos!</strong><br><span style="font-size:12px;color:#aaa;">Error: ${escapeHtml(errorMsg)}</span><br><span style="font-size:12px;color:#aaa;">Coba lagi dalam beberapa detik ya! Wkwkwk ðŸ˜…</span>`;
                appendAIMsg('ai', errHtml);
                sultanChatHistory.pop(); // remove failed user turn
            }

            // Unlock UI
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
        }

        function quickAsk(text) {
            const inp = document.getElementById('aiUserInput');
            if (inp) { inp.value = text; sendSultanAI(); }
        }

        // ================================================================
        // ======= ðŸŽ¬ CINEMATIC INTRO =====================================
        // ================================================================
        (function() {
            const intro = document.getElementById('cinematicIntro');
            if (!intro) return;
            // Skip if seen in last 10 minutes
            const lastSeen = parseInt(localStorage.getItem('introLastSeen') || '0');
            if (Date.now() - lastSeen < 600000) { intro.style.display = 'none'; return; }
            setTimeout(() => {
                intro.classList.add('fade-out');
                setTimeout(() => {
                    intro.style.display = 'none';
                    localStorage.setItem('introLastSeen', Date.now());
                    // Show changelog on first ever visit
                    if (!localStorage.getItem('changelogSeen_v4')) {
                        setTimeout(() => openChangelog(), 400);
                    }
                }, 900);
            }, 2800);
        })();

        // ================================================================
        // ======= ðŸ‰ DRAGON CURSOR TRAIL =================================
        // ================================================================
        (function() {
            const canvas = document.getElementById('dragonCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let W = window.innerWidth, H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            window.addEventListener('resize', () => { W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H; });

            const particles = [];
            let mouseX = -1000, mouseY = -1000;
            let touchActive = false;

            const COLORS = ['#FFD700', '#FFA500', '#FF6B00', '#FF4500', '#FFEC8B', '#FFF8DC'];
            const SHAPES = ['â—†', 'âœ¦', 'â˜…', 'â€¢', 'â—‰'];

            function addParticle(x, y) {
                for (let i = 0; i < 3; i++) {
                    particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3 - 1,
                        size: Math.random() * 14 + 6,
                        alpha: 1,
                        color: COLORS[Math.floor(Math.random() * COLORS.length)],
                        shape: SHAPES[Math.floor(Math.random() * SHAPES.length)],
                        life: 1,
                        decay: Math.random() * 0.04 + 0.02,
                        rotation: Math.random() * Math.PI * 2,
                        rotSpeed: (Math.random() - 0.5) * 0.2
                    });
                }
            }

            document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; addParticle(e.clientX, e.clientY); });
            document.addEventListener('touchmove', e => {
                if (e.touches[0]) { mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; addParticle(mouseX, mouseY); }
            }, { passive: true });

            function animate() {
                ctx.clearRect(0, 0, W, H);
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.life -= p.decay;
                    if (p.life <= 0) { particles.splice(i, 1); continue; }
                    p.x += p.vx; p.y += p.vy;
                    p.vy += 0.05;
                    p.rotation += p.rotSpeed;
                    ctx.save();
                    ctx.globalAlpha = p.life * 0.85;
                    ctx.font = `${p.size}px serif`;
                    ctx.fillStyle = p.color;
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation);
                    ctx.fillText(p.shape, -p.size / 2, p.size / 2);
                    ctx.restore();
                }
                requestAnimationFrame(animate);
            }
            animate();
        })();

        // ================================================================
        // ======= ðŸŒŠ INK SPLASH TAB TRANSITION ===========================
        // ================================================================
        const _origTab = window.tab;
        function tab(id) {
            const splash = document.getElementById('inkSplash');
            if (splash) {
                splash.style.display = 'block';
                splash.innerHTML = '';
                const circle = document.createElement('div');
                circle.className = 'ink-circle';
                circle.style.cssText = `width:200px; height:200px; left:50%; top:50%; margin:-100px 0 0 -100px;`;
                splash.appendChild(circle);
                setTimeout(() => { splash.style.display = 'none'; }, 600);
            }
            playSnd('click');
            haptic(30);
            // Call original tab logic
            _origTabSwitch(id);
        }

        function _origTabSwitch(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-tab'));
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden-tab');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav', 'nav-active-glow'));
            const navBtn = document.getElementById('n-' + id);
            if (navBtn) { navBtn.classList.add('active-nav', 'nav-active-glow'); }
            if (id === 'flashcard') initFlashcard();
            if (id === 'progress') initProgress();
            if (id === 'quiz') startQuiz('mixed');
            if (id === 'ask-ai') initAskAI();
            if (id === 'store') { updateXPBalanceDisplay(); updateFreezeDisplay(); updateBoosterStatus(); }
        }

        // ================================================================
        // ======= ðŸ”Š WEB AUDIO SOUND SYSTEM ==============================
        // ================================================================
        let _audioCtx = null;
        function _getAudio() {
            if (!_audioCtx) {
                try { _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
            }
            return _audioCtx;
        }

        function playSnd(type) {
            try {
                const ac = _getAudio(); if (!ac) return;
                if (ac.state === 'suspended') ac.resume();
                const now = ac.currentTime;

                if (type === 'click') {
                    // Soft click - brief sine wave
                    const o = ac.createOscillator();
                    const g = ac.createGain();
                    o.connect(g); g.connect(ac.destination);
                    o.type = 'sine'; o.frequency.value = 800;
                    g.gain.setValueAtTime(0.08, now);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
                    o.start(now); o.stop(now + 0.12);

                } else if (type === 'coin') {
                    // Coin jingle - ascending tones
                    [800, 1000, 1200].forEach((freq, i) => {
                        const o = ac.createOscillator();
                        const g = ac.createGain();
                        o.connect(g); g.connect(ac.destination);
                        o.type = 'sine'; o.frequency.value = freq;
                        const t = now + i * 0.06;
                        g.gain.setValueAtTime(0, t);
                        g.gain.linearRampToValueAtTime(0.12, t + 0.02);
                        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
                        o.start(t); o.stop(t + 0.18);
                    });

                } else if (type === 'gong') {
                    // Deep gong - low sine with long decay
                    const o = ac.createOscillator();
                    const g = ac.createGain();
                    o.connect(g); g.connect(ac.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime(180, now);
                    o.frequency.exponentialRampToValueAtTime(120, now + 1.5);
                    g.gain.setValueAtTime(0.25, now);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + 2.0);
                    o.start(now); o.stop(now + 2.0);

                } else if (type === 'achievement') {
                    // Fanfare - quick ascending chord
                    [[523, 0], [659, 0.1], [784, 0.2], [1047, 0.3]].forEach(([freq, delay]) => {
                        const o = ac.createOscillator();
                        const g = ac.createGain();
                        o.connect(g); g.connect(ac.destination);
                        o.type = 'triangle'; o.frequency.value = freq;
                        const t = now + delay;
                        g.gain.setValueAtTime(0.15, t);
                        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.4);
                        o.start(t); o.stop(t + 0.4);
                    });

                } else if (type === 'error') {
                    // Error buzz
                    const o = ac.createOscillator();
                    const g = ac.createGain();
                    o.connect(g); g.connect(ac.destination);
                    o.type = 'sawtooth'; o.frequency.value = 200;
                    g.gain.setValueAtTime(0.15, now);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);
                    o.start(now); o.stop(now + 0.3);

                } else if (type === 'angpao') {
                    // Happy jingle
                    [600, 800, 1000, 1200, 1000].forEach((freq, i) => {
                        const o = ac.createOscillator();
                        const g = ac.createGain();
                        o.connect(g); g.connect(ac.destination);
                        o.type = 'sine'; o.frequency.value = freq;
                        const t = now + i * 0.08;
                        g.gain.setValueAtTime(0.1, t);
                        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.15);
                        o.start(t); o.stop(t + 0.15);
                    });
                }
            } catch(e) {}
        }

        // Patch addXP and showAchievement to play sounds
        const _origAddXP = window.addXP;
        function addXP(amount) {
            if (typeof _origAddXP === 'function') _origAddXP(amount);
            playSnd('coin');
        }
        const _origShowAchievement = window.showAchievement;
        function showAchievement(msg) {
            if (typeof _origShowAchievement === 'function') _origShowAchievement(msg);
            playSnd('achievement');
            haptic([50, 30, 50]);
        }

        // ================================================================
        // ======= ðŸ“³ HAPTIC FEEDBACK =====================================
        // ================================================================
        function haptic(pattern) {
            try {
                if (navigator.vibrate) navigator.vibrate(pattern);
            } catch(e) {}
        }

        // ================================================================
        // ======= ðŸ‘† SWIPE GESTURE NAVIGATION ============================
        // ================================================================
        (function() {
            const TAB_ORDER = ['home','silsilah','dasar','kamus','flashcard','quiz','ai-tutor','progress','cinema','karaoke','store','ai-lab','ask-ai'];
            let touchStartX = 0, touchStartY = 0, touchStartTime = 0;

            document.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }, { passive: true });

            document.addEventListener('touchend', e => {
                const dx = e.changedTouches[0].clientX - touchStartX;
                const dy = e.changedTouches[0].clientY - touchStartY;
                const dt = Date.now() - touchStartTime;
                // Only swipe if fast, horizontal, and significant distance
                if (dt < 350 && Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                    const currentTab = document.querySelector('.tab-content:not(.hidden-tab)');
                    if (!currentTab) return;
                    const idx = TAB_ORDER.indexOf(currentTab.id);
                    if (idx === -1) return;
                    if (dx < 0 && idx < TAB_ORDER.length - 1) {
                        tab(TAB_ORDER[idx + 1]); // swipe left = next
                    } else if (dx > 0 && idx > 0) {
                        tab(TAB_ORDER[idx - 1]); // swipe right = prev
                    }
                }
            }, { passive: true });
        })();

        // ================================================================
        // ======= ðŸŒ… DYNAMIC THEME SYSTEM ================================
        // ================================================================
        const THEMES = ['theme-morning', 'theme-noon', 'theme-night'];
        const THEME_ICONS = ['ðŸŒ„', 'â˜€ï¸', 'ðŸŒ™'];
        let currentThemeIdx = 0;

        function applyAutoTheme() {
            const h = new Date().getHours();
            if (h >= 5 && h < 11)       currentThemeIdx = 0; // morning
            else if (h >= 11 && h < 18) currentThemeIdx = 1; // noon
            else                        currentThemeIdx = 2; // night
            const saved = localStorage.getItem('manualTheme');
            if (saved !== null) currentThemeIdx = parseInt(saved);
            applyTheme(currentThemeIdx);
        }

        function applyTheme(idx) {
            document.body.classList.remove(...THEMES);
            document.body.classList.add(THEMES[idx]);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.textContent = THEME_ICONS[idx];
        }

        function cycleTheme() {
            currentThemeIdx = (currentThemeIdx + 1) % THEMES.length;
            localStorage.setItem('manualTheme', currentThemeIdx);
            applyTheme(currentThemeIdx);
            playSnd('click');
            haptic(40);
        }

        applyAutoTheme();

        // ================================================================
        // ======= ðŸ§§ ANGPAO RAIN EVENT ===================================
        // ================================================================
        let angpaoRainActive = false;
        let angpaoRainTimeout = null;

        function triggerAngpaoRain() {
            if (angpaoRainActive) return;
            angpaoRainActive = true;
            playSnd('angpao');
            haptic([50, 50, 50]);

            const banner = document.getElementById('angpaoEventBanner');
            if (banner) banner.classList.add('show');

            // Spawn 15 angpao over 5 seconds
            let spawned = 0;
            const spawnInterval = setInterval(() => {
                if (spawned >= 15) { clearInterval(spawnInterval); return; }
                spawnAngpao();
                spawned++;
            }, 350);

            // End event after 12 seconds
            angpaoRainTimeout = setTimeout(() => {
                angpaoRainActive = false;
                if (banner) banner.classList.remove('show');
            }, 12000);
        }

        function spawnAngpao() {
            const el = document.createElement('div');
            el.className = 'rain-angpao';
            el.textContent = 'ðŸ§§';
            const xpReward = [10, 20, 30, 50, 100][Math.floor(Math.random() * 5)];
            el.style.left = Math.random() * 90 + 'vw';
            el.style.animationDuration = (3 + Math.random() * 3) + 's';
            el.style.transform = `rotate(${(Math.random() - 0.5) * 30}deg)`;
            el.title = `Klik! +${xpReward} XP`;
            el.onclick = (e) => {
                e.stopPropagation();
                addXP(xpReward);
                showAchievement(`ðŸ§§ Angpao diklaim! +${xpReward} XP!`);
                playSnd('angpao');
                haptic(60);
                // Burst animation
                el.style.transform = 'scale(2) rotate(720deg)';
                el.style.opacity = '0';
                el.style.transition = 'all 0.3s';
                setTimeout(() => el.remove(), 300);
            };
            document.body.appendChild(el);
            el.addEventListener('animationend', () => el.remove());
        }

        // Check for lucky hours (08:08, 18:18, 20:08, 22:22)
        function checkAngpaoHour() {
            const now = new Date();
            const h = now.getHours(), m = now.getMinutes();
            const lucky = [(8,8), [18,18], [20,8], [22,22]];
            if (lucky.some(([lh, lm]) => h === lh && m === lm)) {
                if (!localStorage.getItem(`angpao_${h}_${m}_${now.toDateString()}`)) {
                    localStorage.setItem(`angpao_${h}_${m}_${now.toDateString()}`, '1');
                    triggerAngpaoRain();
                }
            }
        }
        setInterval(checkAngpaoHour, 30000);

        // ================================================================
        // ======= âš¡ FLASH SALE COUNTDOWN TIMER ==========================
        // ================================================================
        function updateFlashTimer() {
            const now = new Date();
            // Resets every 6 hours from midnight
            const secsInDay = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const interval = 6 * 3600;
            const remaining = interval - (secsInDay % interval);
            const h = Math.floor(remaining / 3600);
            const m = Math.floor((remaining % 3600) / 60);
            const s = remaining % 60;
            const pad = n => String(n).padStart(2, '0');
            const fh = document.getElementById('flashH');
            const fm = document.getElementById('flashM');
            const fs = document.getElementById('flashS');
            if (fh) fh.textContent = pad(h);
            if (fm) fm.textContent = pad(m);
            if (fs) fs.textContent = pad(s);
            // Flash red when < 30 min
            if (fh) fh.style.background = remaining < 1800 ? '#ff4500' : 'var(--imperial-red)';
        }
        setInterval(updateFlashTimer, 1000);
        updateFlashTimer();

        // ================================================================
        // ======= ðŸ”® DAILY FORTUNE GENERATOR =============================
        // ================================================================
        const FORTUNE_DATA = [
            { ch: 'é¾™é©¬ç²¾ç¥ž', py: 'lÃ³ng mÇŽ jÄ«ng shÃ©n', meaning: 'Semangat kuda naga â€” energi tak terbendung', color: '#8B0000', lucky: '8, 18, 88', luckyColor: 'Merah Kerajaan', hour: '08:08' },
            { ch: 'ä¸€å¸†é£Žé¡º', py: 'yÄ« fÄn fÄ“ng shÃ¹n', meaning: 'Pelayaran satu layar dalam angin baik â€” segalanya lancar', color: '#004d99', lucky: '1, 11, 111', luckyColor: 'Biru Langit', hour: '11:11' },
            { ch: 'è´¢æºæ»šæ»š', py: 'cÃ¡i yuÃ¡n gÇ”n gÇ”n', meaning: 'Sumber kekayaan mengalir deras â€” rezeki berlimpah', color: '#7a5c00', lucky: '6, 66, 666', luckyColor: 'Emas Murni', hour: '18:18' },
            { ch: 'äº‹äº‹å¦‚æ„', py: 'shÃ¬ shÃ¬ rÃº yÃ¬', meaning: 'Segala urusan berjalan sesuai keinginan hati', color: '#004d00', lucky: '9, 19, 99', luckyColor: 'Hijau Giok', hour: '09:09' },
            { ch: 'æ­¥æ­¥é«˜å‡', py: 'bÃ¹ bÃ¹ gÄo shÄ“ng', meaning: 'Setiap langkah semakin naik â€” karir dan posisi terus meningkat', color: '#4a0080', lucky: '3, 33, 333', luckyColor: 'Ungu Imperial', hour: '15:15' },
            { ch: 'å¿ƒæƒ³äº‹æˆ', py: 'xÄ«n xiÇŽng shÃ¬ chÃ©ng', meaning: 'Apa yang ada di hati, terwujud â€” mimpi jadi nyata', color: '#800040', lucky: '7, 77, 777', luckyColor: 'Merah Mawar', hour: '07:07' },
            { ch: 'ä¸‡äº‹èƒœæ„', py: 'wÃ n shÃ¬ shÃ¨ng yÃ¬', meaning: 'Sepuluh ribu perkara melampaui harapan â€” lebih dari yang diimpikan', color: '#5a2d00', lucky: '8, 28, 88', luckyColor: 'Coklat Kayu Manis', hour: '20:20' },
        ];

        const FORTUNE_PREDICTIONS = [
            'ðŸ”® Energimu meluap hari ini! Ambil keputusan besar â€” waktunya tepat. Wang Weize merestuimu! ðŸ‰',
            'ðŸ’° Peluang finansial muncul tak terduga. Buka matamu lebar-lebar. Rezeki datang dari arah tak terduga!',
            'ðŸŒŸ Hubunganmu dengan orang-orang terpenting akan menguat hari ini. Ucapkan kata yang selama ini tertahan.',
            'ðŸš€ Proyek yang terbengkalai akan menemukan energi baru. Jangan ragu, mulai sekarang juga bos!',
            'ðŸ§  Ide-ide brilian datang bertubi-tubi. Catat semuanya â€” satu di antaranya akan mengubah hidupmu!',
            'ðŸŽ¯ Fokus dan kegigihan adalah kuncimu hari ini. Yang menyerah kalah, yang bertahan menang!',
            'ðŸŒˆ Keberuntungan berpihak padamu. Jangan sia-siakan momentum ini â€” gas terus bos!',
        ];

        function getDailyFortune() {
            const today = new Date().toDateString();
            const cached = localStorage.getItem('dailyFortune_' + today);
            if (cached) return JSON.parse(cached);
            const seed = [...today].reduce((a, c) => a + c.charCodeAt(0), 0);
            const fortune = FORTUNE_DATA[seed % FORTUNE_DATA.length];
            const pred = FORTUNE_PREDICTIONS[seed % FORTUNE_PREDICTIONS.length];
            const result = { ...fortune, prediction: pred };
            localStorage.setItem('dailyFortune_' + today, JSON.stringify(result));
            return result;
        }

        function openFortune() {
            const f = getDailyFortune();
            document.getElementById('fortuneChengyu').textContent = f.ch;
            document.getElementById('fortuneChengyu').style.color = f.color;
            document.getElementById('fortunePinyin').textContent = f.py;
            document.getElementById('fortuneMeaning').textContent = f.meaning;
            document.getElementById('fortunePrediction').textContent = f.prediction;
            document.getElementById('fortuneLucky').textContent =
                `ðŸŽ¨ Warna Hoki: ${f.luckyColor}  â€¢  ðŸ”¢ Angka: ${f.lucky}  â€¢  â° Jam Hoki: ${f.hour}`;
            document.getElementById('fortuneOverlay').classList.add('show');
            playSnd('gong');
            haptic([50, 30, 50, 30, 100]);
        }
        function closeFortune() {
            document.getElementById('fortuneOverlay').classList.remove('show');
            playSnd('click');
        }

        // Auto-show fortune once per day
        (function() {
            const today = new Date().toDateString();
            if (!localStorage.getItem('fortuneShown_' + today)) {
                setTimeout(() => {
                    // Only show if intro is already gone
                    const intro = document.getElementById('cinematicIntro');
                    if (!intro || intro.style.display === 'none') {
                        openFortune();
                        localStorage.setItem('fortuneShown_' + today, '1');
                    }
                }, 4500);
            }
        })();

        // ================================================================
        // ======= ðŸ“¸ VIRAL SHARE CARD GENERATOR ==========================
        // ================================================================
        function generateShareCard(title, value, subtitle, context) {
            const canvas = document.getElementById('shareCardCanvas');
            const ctx = canvas.getContext('2d');
            const W = 400, H = 560;
            canvas.width = W; canvas.height = H;

            // Background gradient
            const bg = ctx.createLinearGradient(0, 0, W, H);
            bg.addColorStop(0, '#1a0000');
            bg.addColorStop(0.5, '#2d0a00');
            bg.addColorStop(1, '#1a0000');
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, W, H);

            // Border
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 6;
            ctx.strokeRect(6, 6, W - 12, H - 12);
            ctx.strokeStyle = 'rgba(255,215,0,0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(16, 16, W - 32, H - 32);

            // Top ornament
            ctx.fillStyle = '#8B0000';
            ctx.fillRect(0, 50, W, 4);
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(0, 54, W, 2);

            // æ±ª character
            ctx.font = '90px Ma Shan Zheng, serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#FFD700';
            ctx.shadowColor = 'rgba(255,215,0,0.6)';
            ctx.shadowBlur = 20;
            ctx.fillText('æ±ª', W / 2, 130);
            ctx.shadowBlur = 0;

            // Brand name
            ctx.font = 'bold 16px Cormorant Garamond, serif';
            ctx.fillStyle = 'rgba(255,215,0,0.7)';
            ctx.fillText('WANG WEIZE Â· SULTAN OMNIVERSE', W / 2, 160);

            // Divider
            ctx.fillStyle = 'rgba(255,215,0,0.3)';
            ctx.fillRect(60, 170, W - 120, 1);

            // Title
            ctx.font = 'bold 20px Playfair Display, serif';
            ctx.fillStyle = '#fff';
            ctx.fillText(title || 'QUIZ SULTAN', W / 2, 210);

            // Big value
            ctx.font = 'bold 80px sans-serif';
            const grad = ctx.createLinearGradient(0, 240, W, 320);
            grad.addColorStop(0, '#FFD700');
            grad.addColorStop(1, '#FF6B00');
            ctx.fillStyle = grad;
            ctx.shadowColor = 'rgba(255,215,0,0.4)';
            ctx.shadowBlur = 15;
            ctx.fillText(value || '100%', W / 2, 320);
            ctx.shadowBlur = 0;

            // Subtitle
            ctx.font = '16px sans-serif';
            ctx.fillStyle = 'rgba(255,215,0,0.7)';
            ctx.fillText(subtitle || 'Skor Sempurna!', W / 2, 360);

            // Context text
            if (context) {
                ctx.font = '13px sans-serif';
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillText(context, W / 2, 395);
            }

            // Bottom bar
            ctx.fillStyle = 'rgba(255,215,0,0.1)';
            ctx.fillRect(30, 420, W - 60, 80);
            ctx.strokeStyle = 'rgba(255,215,0,0.2)';
            ctx.lineWidth = 1;
            ctx.strokeRect(30, 420, W - 60, 80);

            // Date & signature
            ctx.font = 'bold 12px monospace';
            ctx.fillStyle = 'rgba(255,215,0,0.6)';
            const dateStr = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
            ctx.fillText(`ðŸ® ${dateStr}`, W / 2, 450);
            ctx.font = '11px monospace';
            ctx.fillStyle = 'rgba(255,215,0,0.4)';
            ctx.fillText('sultanomniverse.id Â· @wangweize10', W / 2, 475);

            // Bottom dragons
            ctx.font = '28px serif';
            ctx.fillText('ðŸ‰', 60, 510);
            ctx.fillText('ðŸ‰', W - 60, 510);
            ctx.font = 'bold 14px serif';
            ctx.fillStyle = '#FFD700';
            ctx.fillText('WANG DYNASTY', W / 2, 530);

            document.getElementById('shareCardOverlay').classList.add('show');
            playSnd('achievement');
        }

        function shareFortuneCard() {
            const f = getDailyFortune();
            generateShareCard('RAMALAN HARI INI', f.ch, f.py, f.meaning.substring(0, 45) + '...');
        }

        function shareQuizCard(score, total) {
            const pct = Math.round(score / total * 100);
            generateShareCard('QUIZ SULTAN RESULT', pct + '%', `${score}/${total} Benar`, 'Wang Dynasty Mandarin Academy');
        }

        function downloadShareCard() {
            const canvas = document.getElementById('shareCardCanvas');
            const link = document.createElement('a');
            link.download = 'sultan-omniverse-card.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            playSnd('coin');
        }

        function closeShareCard() {
            document.getElementById('shareCardOverlay').classList.remove('show');
        }

        // Patch quiz results to show share card button
        const _origNextQuestion = window.nextQuestion;

        // ================================================================
        // ======= ðŸ§© CHARACTER PUZZLE MINI GAME ==========================
        // ================================================================
        const PUZZLE_DATA = [
            { char: 'æ±ª', pieces: ['æ°µ','çŽ‹','åœŸ','ç«','é‡‘','æœ¨'], correct: ['æ°µ','çŽ‹'], meaning: 'Air + Raja = Marga Wang' },
            { char: 'å¥½', pieces: ['å¥³','å­','å±±','æ—¥','æœˆ','å¿ƒ'], correct: ['å¥³','å­'], meaning: 'Wanita + Anak = Kebaikan' },
            { char: 'æ˜Ž', pieces: ['æ—¥','æœˆ','æ°´','ç«','åœŸ','æœ¨'], correct: ['æ—¥','æœˆ'], meaning: 'Matahari + Bulan = Terang' },
            { char: 'ä¼‘', pieces: ['äºº','æœ¨','æ°´','é‡‘','åœŸ','ç«'], correct: ['äºº','æœ¨'], meaning: 'Manusia + Pohon = Istirahat' },
            { char: 'æ£®', pieces: ['æœ¨','æœ¨','æœ¨','æ°´','ç«','åœŸ'], correct: ['æœ¨','æœ¨','æœ¨'], meaning: '3 Pohon = Hutan' },
            { char: 'èµš', pieces: ['è´','å…¼','åœŸ','æ°´','ç«','é‡‘'], correct: ['è´','å…¼'], meaning: 'Uang + Ganda = Cuan!' },
        ];

        let puzzleTimer = null;
        let puzzleTimeLeft = 30;
        let puzzleActive = false;
        let puzzleCurrentData = null;
        let puzzleAnswerArr = [];

        function openPuzzle() {
            document.getElementById('puzzleOverlay').classList.add('show');
            resetPuzzle();
            playSnd('gong');
        }
        function closePuzzle() {
            document.getElementById('puzzleOverlay').classList.remove('show');
            if (puzzleTimer) clearInterval(puzzleTimer);
            puzzleActive = false;
        }
        function resetPuzzle() {
            puzzleActive = false;
            puzzleAnswerArr = [];
            if (puzzleTimer) clearInterval(puzzleTimer);
            document.getElementById('puzzleTimerDisplay').textContent = '30';
            document.getElementById('puzzleTimerDisplay').classList.remove('danger');
            document.getElementById('puzzleResult').textContent = '';
            document.getElementById('puzzleResult').style.color = '';
            document.getElementById('puzzleStartBtn').textContent = 'ðŸŽ® MAIN SEKARANG';
            document.getElementById('puzzleStartBtn').disabled = false;
            document.getElementById('puzzlePieces').innerHTML = '<div style="color:rgba(255,215,0,0.4); font-size:12px;">Klik tombol main untuk mulai!</div>';
            document.getElementById('puzzleAnswer').innerHTML = '<div style="color:rgba(255,215,0,0.3); font-size:12px;">Jawaban kamu muncul di sini...</div>';
        }

        function startPuzzle() {
            const pd = PUZZLE_DATA[Math.floor(Math.random() * PUZZLE_DATA.length)];
            puzzleCurrentData = pd;
            puzzleAnswerArr = [];
            document.getElementById('puzzleTarget').textContent = pd.char;
            document.getElementById('puzzleStartBtn').disabled = true;
            document.getElementById('puzzleResult').textContent = '';
            document.getElementById('puzzleAnswer').innerHTML = '';

            // Shuffle pieces
            const shuffled = [...pd.pieces].sort(() => Math.random() - 0.5);
            document.getElementById('puzzlePieces').innerHTML = shuffled.map(p =>
                `<div class="puzzle-piece" onclick="puzzlePickPiece(this,'${p}')">${p}</div>`
            ).join('');

            // Start timer
            puzzleTimeLeft = 30;
            puzzleActive = true;
            const timerEl = document.getElementById('puzzleTimerDisplay');
            timerEl.textContent = '30';
            timerEl.classList.remove('danger');

            puzzleTimer = setInterval(() => {
                puzzleTimeLeft--;
                timerEl.textContent = puzzleTimeLeft;
                if (puzzleTimeLeft <= 10) timerEl.classList.add('danger');
                if (puzzleTimeLeft <= 0) {
                    clearInterval(puzzleTimer);
                    puzzleActive = false;
                    document.getElementById('puzzleResult').textContent = 'â° WAKTU HABIS! Coba lagi bos!';
                    document.getElementById('puzzleResult').style.color = '#f87171';
                    document.getElementById('puzzleStartBtn').disabled = false;
                    document.getElementById('puzzleStartBtn').textContent = 'ðŸ”„ Coba Lagi';
                    playSnd('error');
                    haptic([100, 50, 100]);
                }
            }, 1000);
        }

        function puzzlePickPiece(el, piece) {
            if (!puzzleActive) return;
            puzzleAnswerArr.push(piece);
            el.classList.add('dropped');
            el.onclick = null;

            const answerEl = document.getElementById('puzzleAnswer');
            const pieceEl = document.createElement('div');
            pieceEl.className = 'puzzle-piece dropped';
            pieceEl.textContent = piece;
            pieceEl.onclick = () => {
                // Remove from answer
                puzzleAnswerArr = puzzleAnswerArr.filter((_, i) => i !== puzzleAnswerArr.lastIndexOf(piece));
                pieceEl.remove();
                // Re-enable in pieces
                el.classList.remove('dropped');
                el.onclick = () => puzzlePickPiece(el, piece);
            };
            answerEl.appendChild(pieceEl);

            // Check if answer matches correct combination
            const sorted = [...puzzleAnswerArr].sort().join('');
            const correct = [...puzzleCurrentData.correct].sort().join('');
            if (sorted === correct && puzzleAnswerArr.length === puzzleCurrentData.correct.length) {
                clearInterval(puzzleTimer);
                puzzleActive = false;
                const xpReward = Math.max(100, puzzleTimeLeft * 10);
                document.getElementById('puzzleResult').innerHTML = `âœ… BENAR! ${puzzleCurrentData.meaning} <br>+${xpReward} XP! ðŸ†`;
                document.getElementById('puzzleResult').style.color = '#4ade80';
                addXP(xpReward);
                showAchievement(`ðŸ§© Puzzle selesai! +${xpReward} XP!`);
                document.getElementById('puzzleStartBtn').disabled = false;
                document.getElementById('puzzleStartBtn').textContent = 'ðŸ”„ Karakter Baru';
                haptic([50, 30, 50, 30, 100]);
                setTimeout(() => generateShareCard('CHARACTER PUZZLE', 'âœ…', puzzleCurrentData.char + ' = ' + puzzleCurrentData.correct.join('+'), puzzleCurrentData.meaning), 1500);
            }
        }

        // ================================================================
        // ======= ðŸ”’ STREAK FREEZE & BOOSTER STORE ITEMS =================
        // ================================================================
        function updateXPBalanceDisplay() {
            const xp = (typeof userStats !== 'undefined') ? (userStats.xp || 0) : 0;
            const el = document.getElementById('xpBalanceDisplay');
            if (el) el.textContent = xp.toLocaleString('id-ID') + ' XP';
        }
        function updateFreezeDisplay() {
            const count = parseInt(localStorage.getItem('streakFreezeCount') || '0');
            const el = document.getElementById('freezeOwnedCount');
            if (el) el.textContent = count;
            const dbEl = document.getElementById('dbFreezeCount');
            if (dbEl) dbEl.textContent = count;
        }
        function updateBoosterStatus() {
            const expires = parseInt(localStorage.getItem('xpBoosterExpires') || '0');
            const el = document.getElementById('boosterStatus');
            if (!el) return;
            if (Date.now() < expires) {
                const remaining = Math.ceil((expires - Date.now()) / 3600000);
                el.textContent = `âš¡ AKTIF (${remaining} jam tersisa)`;
                el.style.color = '#ffd700';
            } else {
                el.textContent = 'Tidak aktif';
                el.style.color = '#888';
            }
        }
        function buyStreakFreeze() {
            const xp = (typeof userStats !== 'undefined') ? (userStats.xp || 0) : 0;
            if (xp < 500) { alert(`ðŸ˜… XP kamu kurang bos! XP sekarang: ${xp}. Butuh 500 XP untuk beli Streak Freeze!`); playSnd('error'); return; }
            if (!confirm('Beli Streak Freeze 1 buah?\nHarga: 500 XP\nXP kamu: ' + xp)) return;
            if (typeof userStats !== 'undefined') { userStats.xp = Math.max(0, userStats.xp - 500); if (typeof saveUserData === 'function') saveUserData(); if (typeof updateStatsDisplay === 'function') updateStatsDisplay(); }
            const count = parseInt(localStorage.getItem('streakFreezeCount') || '0') + 1;
            localStorage.setItem('streakFreezeCount', count);
            updateFreezeDisplay();
            updateXPBalanceDisplay();
            showAchievement('ðŸ§Š Streak Freeze dibeli! Streak aman 1 hari!');
            playSnd('coin');
        }
        function buyXPBooster() {
            const xp = (typeof userStats !== 'undefined') ? (userStats.xp || 0) : 0;
            const nowExpires = parseInt(localStorage.getItem('xpBoosterExpires') || '0');
            if (Date.now() < nowExpires) { alert('âš¡ XP Booster sudah aktif bos! Tunggu sampai habis dulu ya!'); return; }
            if (xp < 1000) { alert(`ðŸ˜… XP kamu kurang! Butuh 1.000 XP. Sekarang: ${xp}`); playSnd('error'); return; }
            if (!confirm('Aktifkan XP Booster 2x selama 24 jam?\nHarga: 1.000 XP')) return;
            if (typeof userStats !== 'undefined') { userStats.xp = Math.max(0, userStats.xp - 1000); if (typeof saveUserData === 'function') saveUserData(); if (typeof updateStatsDisplay === 'function') updateStatsDisplay(); }
            const expires = Date.now() + 86400000;
            localStorage.setItem('xpBoosterExpires', expires);
            updateBoosterStatus();
            updateXPBalanceDisplay();
            showAchievement('âš¡ XP Booster 2x AKTIF selama 24 jam!');
            playSnd('achievement');
        }

        // ================================================================
        // ======= ðŸ“¢ PAGE TITLE NOTIFICATION =============================
        // ================================================================
        let _origTitle = document.title;
        let _titleBlinkInterval = null;

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                let blink = false;
                _titleBlinkInterval = setInterval(() => {
                    document.title = blink ? 'ðŸ® Sultan merindukanmu bos!' : 'ðŸ‰ Streak mau putus!';
                    blink = !blink;
                }, 1500);
            } else {
                if (_titleBlinkInterval) clearInterval(_titleBlinkInterval);
                document.title = _origTitle;
            }
        });

        // ================================================================
        // ======= âš™ï¸ DEBUG PANEL (Shift+Alt+D) ===========================
        // ================================================================
        document.addEventListener('keydown', e => {
            if (e.shiftKey && e.altKey && e.key === 'D') {
                const panel = document.getElementById('debugPanel');
                if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            // Konami code easter egg
            _konamiCheck(e.key);
        });
        function dbSetXP() {
            const v = parseInt(document.getElementById('dbXP').value) || 0;
            if (typeof userStats !== 'undefined') { userStats.xp = v; if (typeof saveUserData === 'function') saveUserData(); if (typeof updateStatsDisplay === 'function') updateStatsDisplay(); }
            alert('âœ… XP set ke ' + v);
        }
        function dbSetSaldo() {
            const v = parseInt(document.getElementById('dbSaldo').value) || 0;
            localStorage.setItem('saldoAngpao', v);
            if (typeof updateAngpaoUI === 'function') updateAngpaoUI();
            alert('âœ… Saldo set ke Rp ' + v.toLocaleString('id-ID'));
        }
        function dbAddFreeze() {
            const c = parseInt(localStorage.getItem('streakFreezeCount') || '0') + 1;
            localStorage.setItem('streakFreezeCount', c);
            updateFreezeDisplay();
        }

        // ================================================================
        // ======= ðŸ¥š KONAMI CODE EASTER EGG ==============================
        // ================================================================
        const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
        let konamiIdx = 0;
        function _konamiCheck(key) {
            if (key === KONAMI[konamiIdx]) {
                konamiIdx++;
                if (konamiIdx === KONAMI.length) {
                    konamiIdx = 0;
                    triggerAngpaoRain();
                    addXP(888);
                    showAchievement('ðŸ¥š KONAMI CODE! +888 XP SULTAN LEGEND!');
                    playSnd('achievement');
                }
            } else { konamiIdx = 0; }
        }

        // ================================================================
        // ======= ðŸ“‹ CHANGELOG POPUP =====================================
        // ================================================================
        function openChangelog() {
            document.getElementById('changelogOverlay').classList.add('show');
            playSnd('gong');
        }
        function closeChangelog() {
            document.getElementById('changelogOverlay').classList.remove('show');
            localStorage.setItem('changelogSeen_v4', '1');
            // Auto-trigger fortune after changelog
            const today = new Date().toDateString();
            if (!localStorage.getItem('fortuneShown_' + today)) {
                setTimeout(() => { openFortune(); localStorage.setItem('fortuneShown_' + today, '1'); }, 500);
            }
        }

        // ================================================================
        // ======= ðŸ“± LANDSCAPE WARNING ===================================
        // ================================================================
        function checkOrientation() {
            const warn = document.getElementById('landscapeWarn');
            if (!warn) return;
            const isLandscape = window.innerWidth > window.innerHeight && window.innerWidth < 900;
            warn.style.display = isLandscape ? 'flex' : 'none';
        }
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);
        checkOrientation();

        // ================================================================
        // ======= ðŸ“¡ OFFLINE DETECTION ===================================
        // ================================================================
        function updateOnlineStatus() {
            const banner = document.getElementById('offlineBanner');
            if (!banner) return;
            if (!navigator.onLine) {
                banner.classList.add('show');
                playSnd('error');
            } else {
                banner.classList.remove('show');
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // ================================================================
        // ======= ðŸ›¡ï¸ GLOBAL ERROR BOUNDARY ===============================
        // ================================================================
        window.addEventListener('error', e => {
            console.warn('[Sultan Shield] Error caught:', e.message);
            // Don't show alert for every error â€” just log silently
        });
        window.addEventListener('unhandledrejection', e => {
            console.warn('[Sultan Shield] Promise rejected:', e.reason);
            e.preventDefault(); // Prevent ugly console errors from breaking UX
        });

        // ================================================================
        // ======= ðŸŽ¯ PATCH QUIZ TO SHOW SHARE CARD =======================
        // ================================================================
        const _origShowResults = window.showResults;
        function showResults() {
            if (typeof _origShowResults === 'function') _origShowResults();
            // Show share button in quiz results
            const resultsEl = document.getElementById('quizResults');
            if (resultsEl && !document.getElementById('quizShareBtn')) {
                const btn = document.createElement('button');
                btn.id = 'quizShareBtn';
                btn.textContent = 'ðŸ“¸ Bagikan Hasil';
                btn.className = 'bg-yellow-600 text-white px-6 py-3 rounded-lg font-black mx-2 mt-2';
                btn.onclick = () => {
                    const scoreEl = document.getElementById('finalScore');
                    const scoreText = scoreEl ? scoreEl.textContent : '?%';
                    generateShareCard('QUIZ SULTAN', scoreText, 'Wang Dynasty Academy', 'Belajar Mandarin Bersama Sultan!');
                };
                resultsEl.appendChild(btn);
            }
        }

        // ================================================================
        // ======= ðŸ”„ INIT ALL NEW FEATURES ON LOAD =======================
        // ================================================================
        window.addEventListener('load', function() {
            updateBoosterStatus();
            updateFreezeDisplay();
            setTimeout(checkAngpaoHour, 2000);

            // Show changelog for new visitors (after intro fades)
            setTimeout(() => {
                if (!localStorage.getItem('changelogSeen_v4')) {
                    const intro = document.getElementById('cinematicIntro');
                    if (!intro || intro.style.display === 'none') openChangelog();
                }
            }, 3500);
        });

        // ================================================================
        // ======= â­ ENHANCED addXP with XP BOOSTER SUPPORT ==============
        // ================================================================
        // Override the override to add booster logic
        const _addXPWithSound = window.addXP;
        window.addXP = function(amount) {
            const boosterExpires = parseInt(localStorage.getItem('xpBoosterExpires') || '0');
            const boosted = Date.now() < boosterExpires;
            const finalAmount = boosted ? amount * 2 : amount;
            if (boosted && amount > 0) {
                // Show boost indicator briefly
                const el = document.createElement('div');
                el.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,215,0,0.9);color:#000;padding:8px 20px;border-radius:20px;font-weight:900;font-size:14px;z-index:99999;animation:fadeIn 0.3s;pointer-events:none;';
                el.textContent = `âš¡ XP BOOSTER 2x! +${finalAmount} XP!`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }
            if (typeof _addXPWithSound === 'function') _addXPWithSound(finalAmount);
            else {
                // Fallback direct XP add
                if (typeof userStats !== 'undefined') {
                    userStats.xp = (userStats.xp || 0) + finalAmount;
                    if (typeof saveUserData === 'function') saveUserData();
                    if (typeof updateStatsDisplay === 'function') updateStatsDisplay();
                }
            }
        };

    </script>
</body>
</html>
