<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WANG WEIZE | Imperial Mandarin Supremacy - API FIXED Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@700;900&family=Playfair+Display:wght@900&family=Cormorant+Garamond:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --imperial-red: #C41E3A; 
            --emperor-gold: #FFD700; 
            --rice-paper: #FDF6E3; 
        }
        
        body { 
            background-color: var(--rice-paper); 
            color: #1a1a1a; 
            font-family: 'Noto Serif SC', serif; 
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'); 
            overflow-x: hidden; 
            padding-bottom: 120px; 
        }
        
        .emperor-name { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(3rem, 8vw, 6.5rem); 
            font-weight: 900; 
            color: #ffffff; 
            -webkit-text-stroke: 2.5px var(--imperial-red);
            text-shadow: 4px 4px 0 var(--emperor-gold), 8px 8px 20px rgba(0,0,0,0.5); 
            letter-spacing: 6px; 
            display: inline-block; 
            line-height: 1.2;
            padding: 15px;
            filter: drop-shadow(0 5px 15px rgba(196,30,58,0.4));
        }

        .glass-scroll { 
            background: rgba(253, 246, 227, 0.95); 
            backdrop-filter: blur(10px); 
            border: 3px solid var(--imperial-red); 
            border-radius: 12px; 
            transition: 0.5s; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        
        .hidden-tab { display: none !important; }
        
        .active-nav { 
            background: var(--imperial-red) !important; 
            color: var(--emperor-gold) !important; 
            transform: scale(1.05); 
            box-shadow: 0 -5px 15px rgba(196,30,58,0.5); 
        }
        
        .canvas-box { 
            position: relative; 
            width: 360px; 
            height: 360px; 
            margin: 0 auto; 
            background: #fff; 
            border: 6px double var(--imperial-red); 
            border-radius: 10px; 
        }
        
        canvas { 
            touch-action: none; 
            cursor: crosshair; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        
        .imperial-particle { 
            position: fixed; 
            top: -10px; 
            pointer-events: none; 
            z-index: 0; 
            opacity: 0.15; 
            animation: fall linear infinite; 
            font-size: 24px; 
            color: var(--emperor-gold); 
        }
        
        @keyframes fall { 
            to { transform: translateY(100vh) rotate(360deg); } 
        }

        .vocab-card { 
            background: white; 
            border: 2px solid var(--imperial-red); 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 6px 6px 0 var(--imperial-red); 
            transition: 0.3s; 
        }
        
        .vocab-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--emperor-gold); 
            box-shadow: 8px 8px 0 var(--emperor-gold); 
        }
        
        .vocab-hanzi { 
            font-size: 42px; 
            font-family: 'Ma Shan Zheng', cursive; 
            color: var(--imperial-red); 
            text-shadow: 1px 1px 0 var(--emperor-gold); 
        }
        
        .vocab-btn { 
            width: 42px; 
            height: 42px; 
            border-radius: 50%; 
            border: 2px solid var(--imperial-red); 
            background: var(--emperor-gold); 
            color: var(--imperial-red); 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
        }
        
        .vocab-btn:hover { 
            background: var(--imperial-red); 
            color: var(--emperor-gold); 
            transform: scale(1.1); 
        }
        
        .profil-container { 
            background: linear-gradient(145deg, #faf3e0, #f5e6d3); 
            border: 3px solid var(--imperial-red); 
            border-radius: 40px; 
            box-shadow: 20px 20px 0 rgba(196,30,58,0.3); 
            padding: 40px; 
            position: relative; 
            overflow: hidden; 
        }
        
        .kartu-generasi { 
            background: rgba(255,255,255,0.8); 
            border: 2px solid var(--imperial-red); 
            border-radius: 20px; 
            padding: 20px; 
            width: 220px; 
            box-shadow: 8px 8px 0 var(--imperial-red); 
        }

        .learning-container { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
        }
        
        .search-wrapper input { 
            width: 100%; 
            padding: 15px 20px; 
            border: 3px solid var(--imperial-red); 
            border-radius: 50px; 
            font-size: 16px; 
            font-weight: bold; 
            outline: none; 
            transition: 0.3s; 
        }
        
        .search-wrapper input:focus { 
            border-color: var(--emperor-gold); 
            box-shadow: 0 0 20px rgba(255,215,0,0.3); 
        }
        
        .vocab-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-top: 30px; 
        }

        .progress-bar { 
            height: 30px; 
            background: linear-gradient(90deg, var(--emperor-gold), var(--imperial-red)); 
            border-radius: 15px; 
            transition: width 0.5s; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, #fff 0%, #f8f8f8 100%); 
            border: 2px solid var(--imperial-red); 
            border-radius: 15px; 
            padding: 20px; 
            text-align: center; 
        }
        
        .ai-suggestion { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
            animation: pulse 2s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.8; } 
        }
        
        .badge { 
            display: inline-block; 
            background: var(--emperor-gold); 
            color: var(--imperial-red); 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            margin: 5px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
        }
        
        .level-badge { 
            font-size: 24px; 
            font-weight: 900; 
            color: var(--emperor-gold); 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        .flashcard { 
            perspective: 1000px; 
            height: 300px; 
            cursor: pointer; 
        }
        
        .flashcard-inner { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; 
        }
        
        .flashcard.flipped .flashcard-inner { 
            transform: rotateY(180deg); 
        }
        
        .flashcard-front, .flashcard-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 48px; 
            font-weight: bold; 
        }
        
        .flashcard-front { 
            background: linear-gradient(135deg, var(--imperial-red), #8B0000); 
            color: white; 
        }
        
        .flashcard-back { 
            background: linear-gradient(135deg, var(--emperor-gold), #DAA520); 
            color: var(--imperial-red); 
            transform: rotateY(180deg); 
        }
        
        .quiz-option { 
            background: white; 
            border: 3px solid var(--imperial-red); 
            padding: 15px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: 0.3s; 
            margin: 10px 0; 
        }
        
        .quiz-option:hover { 
            background: var(--rice-paper); 
            transform: translateX(10px); 
        }
        
        .quiz-option.correct { 
            background: #4ade80; 
            border-color: #16a34a; 
        }
        
        .quiz-option.wrong { 
            background: #f87171; 
            border-color: #dc2626; 
        }

        /* IMPERIAL ORACLE CHAT STYLES */
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #fef3c7, #fde68a);
            border: 3px solid var(--emperor-gold);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-user {
            background: white;
            border: 2px solid var(--imperial-red);
            margin-left: 20%;
        }

        .chat-oracle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-right: 20%;
            border: 2px solid var(--emperor-gold);
        }

        .chat-error {
            background: #fee2e2;
            border: 2px solid #dc2626;
            color: #7f1d1d;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            font-size: 24px;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }

        .listening-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 50%;
            animation: listening-pulse 1s infinite;
            margin-left: 10px;
        }

        @keyframes listening-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; }
        }

        .voice-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            font-weight: 900;
            z-index: 10000;
            animation: voicePop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
        }

        @keyframes voicePop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3) rotate(10deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0) rotate(180deg); opacity: 0; }
        }

        .voice-feedback.cuan {
            color: #22c55e;
            text-shadow: 4px 4px 0 var(--emperor-gold), 8px 8px 20px rgba(0,0,0,0.5);
        }

        .voice-feedback.boncos {
            color: #ef4444;
            text-shadow: 4px 4px 0 #000, 8px 8px 20px rgba(0,0,0,0.5);
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: linear-gradient(135deg, var(--emperor-gold), #DAA520);
            color: var(--imperial-red);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: toastSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 3px solid var(--imperial-red);
            font-weight: bold;
            font-size: 18px;
            min-width: 300px;
            pointer-events: all;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(400px) scale(0.5); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .toast.toast-exit {
            animation: toastSlideOut 0.3s ease-in-out forwards;
        }

        @keyframes toastSlideOut {
            to { transform: translateX(400px) scale(0.5); opacity: 0; }
        }

        .radical-part { 
            display: inline-block; 
            padding: 5px 10px; 
            margin: 5px; 
            background: rgba(196,30,58,0.1); 
            border: 2px solid var(--imperial-red); 
            border-radius: 8px; 
            font-family: 'Ma Shan Zheng', cursive; 
            font-size: 24px; 
            cursor: help; 
            transition: 0.3s; 
        }
        
        .radical-part:hover { 
            background: var(--emperor-gold); 
            transform: scale(1.2); 
        }

        .srs-indicator { 
            height: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        
        .srs-new { background: #60a5fa; }
        .srs-learning { background: #fbbf24; }
        .srs-review { background: #34d399; }
        .srs-master { background: #a78bfa; }
        
        .context-sentence { 
            background: rgba(255,255,255,0.9); 
            border-left: 4px solid var(--emperor-gold); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-style: italic; 
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .emperor-name { font-size: clamp(2rem, 10vw, 4rem); }
            .canvas-box { width: 300px; height: 300px; }
            .vocab-grid { grid-template-columns: 1fr; }
            .toast { min-width: 250px; font-size: 16px; }
            .chat-user, .chat-oracle { margin-left: 0; margin-right: 0; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Particle Container -->
    <div id="particle-container"></div>

    <!-- HEADER -->
    <div class="text-center py-8 relative z-10">
        <h1 class="emperor-name">WANG WEIZE</h1>
        <p class="text-2xl font-bold" style="color: var(--imperial-red);">Ê±™‰∏∫Ê≥Ω ‚Ä¢ Imperial Mandarin Supremacy</p>
        <p class="text-lg mt-2 font-semibold" style="color: var(--emperor-gold);">üêâ DeepSeek Oracle Edition üî•</p>
    </div>

    <!-- NAVIGATION -->
    <div class="sticky top-0 z-50 bg-white shadow-lg border-t-4 border-b-4" style="border-color: var(--imperial-red);">
        <div class="flex justify-around py-3 max-w-6xl mx-auto flex-wrap">
            <button onclick="changeTab('profil')" id="nav-profil" class="active-nav px-6 py-3 rounded-lg font-bold text-sm transition-all">üëë PROFIL</button>
            <button onclick="changeTab('tulis')" id="nav-tulis" class="px-6 py-3 rounded-lg font-bold text-sm transition-all bg-gray-100">‚úçÔ∏è TULIS</button>
            <button onclick="changeTab('belajar')" id="nav-belajar" class="px-6 py-3 rounded-lg font-bold text-sm transition-all bg-gray-100">üìö BELAJAR</button>
            <button onclick="changeTab('oracle')" id="nav-oracle" class="px-6 py-3 rounded-lg font-bold text-sm transition-all bg-gray-100">ü§ñ ORACLE AI</button>
            <button onclick="changeTab('flashcard')" id="nav-flashcard" class="px-6 py-3 rounded-lg font-bold text-sm transition-all bg-gray-100">üé¥ FLASHCARD</button>
            <button onclick="changeTab('kuis')" id="nav-kuis" class="px-6 py-3 rounded-lg font-bold text-sm transition-all bg-gray-100">üéØ KUIS</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-6xl mx-auto px-4 py-8 relative z-10">
        
        <!-- TAB PROFIL -->
        <div id="tab-profil" class="tab-content">
            <div class="profil-container">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üëë</div>
                    <h2 class="text-4xl font-black mb-2" style="color: var(--imperial-red);">WANG WEIZE</h2>
                    <p class="text-2xl font-bold text-gray-700">Ê±™‰∏∫Ê≥Ω ‚Ä¢ CEO Showroom & Cafe Supremacy</p>
                    <div class="level-badge mt-4">LEVEL <span id="userLevel">1</span> üêâ</div>
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="text-4xl mb-2">üìù</div>
                        <div class="text-3xl font-black" style="color: var(--imperial-red);" id="totalChars">0</div>
                        <div class="text-sm font-bold text-gray-600">Karakter Ditulis</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl mb-2">üí¨</div>
                        <div class="text-3xl font-black" style="color: var(--emperor-gold);" id="totalChats">0</div>
                        <div class="text-sm font-bold text-gray-600">Chat AI Oracle</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl mb-2">üéØ</div>
                        <div class="text-3xl font-black" style="color: var(--imperial-red);" id="quizAccuracy">0%</div>
                        <div class="text-sm font-bold text-gray-600">Akurasi Kuis</div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-2xl font-black mb-4" style="color: var(--imperial-red);">üìä Progress XP</h3>
                    <div class="bg-gray-200 rounded-full h-8 overflow-hidden border-3" style="border-color: var(--imperial-red);">
                        <div class="progress-bar h-full" id="xpBar" style="width: 0%;"></div>
                    </div>
                    <p class="text-center mt-2 font-bold"><span id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="kartu-generasi">
                        <h4 class="text-xl font-black mb-3" style="color: var(--imperial-red);">üèÜ Prestasi</h4>
                        <div id="achievementList">
                            <div class="badge">üî∞ Pemula</div>
                            <div class="badge">‚úçÔ∏è Kaligrafi Dasar</div>
                        </div>
                    </div>
                    <div class="kartu-generasi">
                        <h4 class="text-xl font-black mb-3" style="color: var(--imperial-red);">üî• Study Streak</h4>
                        <div class="text-5xl font-black text-center my-4" style="color: var(--emperor-gold);" id="studyStreak">0</div>
                        <p class="text-center font-bold">Hari Berturut-turut</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB TULIS -->
        <div id="tab-tulis" class="tab-content hidden-tab">
            <div class="glass-scroll p-8">
                <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--imperial-red);">‚úçÔ∏è Canvas Mi Zi Ge</h2>
                
                <div class="canvas-box">
                    <canvas id="gridCanvas" width="360" height="360"></canvas>
                    <canvas id="drawCanvas" width="360" height="360"></canvas>
                </div>

                <div class="flex justify-center gap-4 mt-6 flex-wrap">
                    <button onclick="clearCanvas()" class="px-6 py-3 rounded-lg font-bold text-white transition-all" style="background: var(--imperial-red);">üóëÔ∏è Hapus</button>
                    <button onclick="analyzeWriting()" class="px-6 py-3 rounded-lg font-bold text-white transition-all" style="background: var(--emperor-gold); color: var(--imperial-red);">üîç Analisis AI</button>
                    <button onclick="saveDrawing()" class="px-6 py-3 rounded-lg font-bold text-white transition-all" style="background: #16a34a;">üíæ Simpan</button>
                </div>

                <div class="mt-8 bg-gradient-to-r from-yellow-50 to-orange-50 border-3 border-yellow-600 rounded-xl p-6">
                    <h3 class="text-2xl font-black mb-4 text-center" style="color: var(--imperial-red);">üìä Analisis Goresan</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="text-center">
                            <p class="text-lg font-bold mb-2">Jumlah Goresan</p>
                            <div class="text-6xl font-black" style="color: var(--imperial-red);" id="strokeCount">0</div>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold mb-2">Skor Akurasi</p>
                            <div class="text-6xl font-black" style="background: linear-gradient(135deg, var(--emperor-gold), var(--imperial-red)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="accuracyScore">0%</div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-2xl font-black mb-4" style="color: var(--imperial-red);">üìú History Tulisan</h3>
                    <div id="writingHistory" class="grid grid-cols-4 md:grid-cols-8 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- TAB BELAJAR -->
        <div id="tab-belajar" class="tab-content hidden-tab">
            <div class="learning-container">
                <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--imperial-red);">üìö Kamus Interaktif</h2>
                
                <div class="search-wrapper">
                    <input type="text" id="searchVocab" placeholder="üîç Cari kata (Mandarin, Pinyin, atau Indonesia)..." onkeyup="searchVocab()">
                </div>

                <div class="vocab-grid" id="vocabContainer"></div>
            </div>
        </div>

        <!-- TAB IMPERIAL ORACLE AI -->
        <div id="tab-oracle" class="tab-content hidden-tab">
            <div class="glass-scroll p-8">
                <h2 class="text-4xl font-black mb-4 text-center" style="color: var(--imperial-red);">ü§ñ Imperial Oracle AI</h2>
                <p class="text-center text-lg mb-6 font-bold" style="color: var(--emperor-gold);">Penasihat Setia Boss Wang Weize | Powered by DeepSeek</p>
                
                <div id="chatHistory" class="chat-container">
                    <div class="text-center text-gray-500 italic font-bold">
                        üêâ Imperial Oracle siap melayani, Boss Wang Weize! Tanya tentang bisnis, kopi, showroom, atau Mandarin... Wkwkwk! Gas!
                    </div>
                </div>

                <div class="flex gap-3">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Tanya Imperial Oracle (tekan Enter)..." 
                        class="flex-1 px-6 py-4 rounded-lg border-3 font-bold outline-none" 
                        style="border-color: var(--imperial-red);" 
                        onkeypress="if(event.key==='Enter') sendToOracle()">
                    <button 
                        onclick="sendToOracle()" 
                        class="px-8 py-4 rounded-lg font-bold text-white transition-all hover:scale-105" 
                        style="background: var(--emperor-gold); color: var(--imperial-red);">
                        üì® Kirim
                    </button>
                </div>

                <div id="aiLoading" class="hidden mt-4 text-center">
                    <div class="loading-dots">
                        <span>üêâ</span>
                        <span>üêâ</span>
                        <span>üêâ</span>
                    </div>
                    <p class="font-bold mt-2" style="color: var(--imperial-red);">Oracle sedang berpikir...</p>
                </div>

                <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-400 rounded-lg">
                    <p class="text-sm font-bold text-blue-900">
                        üí° <strong>Tip:</strong> Oracle bisa bantu strategi bisnis showroom/cafe, review kualitas kopi, analisis pasar, dan belajar Mandarin praktis untuk bisnis! Wkwkwk Gas!
                    </p>
                </div>
            </div>
        </div>

        <!-- TAB FLASHCARD -->
        <div id="tab-flashcard" class="tab-content hidden-tab">
            <div class="glass-scroll p-8">
                <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--imperial-red);">üé¥ Flashcard Spaced Repetition</h2>
                
                <div class="text-center mb-6">
                    <div class="badge">Kartu <span id="cardIndex">1</span> / <span id="totalCards">0</span></div>
                </div>

                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div id="flashcardFront" class="text-center">
                                <div class="text-6xl mb-4" id="cardHanzi">‰Ω†Â•Ω</div>
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div id="flashcardBack" class="text-center">
                                <div class="text-3xl mb-2" id="cardPinyin">n«ê h«éo</div>
                                <div class="text-2xl" id="cardIndo">Halo</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="srs-indicator mt-6" id="srsIndicator"></div>

                <div class="flex justify-center gap-4 mt-8 flex-wrap">
                    <button onclick="rateCard(1)" class="px-6 py-3 rounded-lg font-bold text-white bg-red-500 transition-all hover:scale-105">üò∞ Susah</button>
                    <button onclick="rateCard(2)" class="px-6 py-3 rounded-lg font-bold text-white bg-yellow-500 transition-all hover:scale-105">ü§î Sedang</button>
                    <button onclick="rateCard(3)" class="px-6 py-3 rounded-lg font-bold text-white bg-green-500 transition-all hover:scale-105">üòé Mudah</button>
                </div>

                <div class="mt-8">
                    <h3 class="text-2xl font-black mb-4 text-center" style="color: var(--imperial-red);">üìä Status SRS</h3>
                    <div id="srsStats" class="grid md:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- TAB KUIS -->
        <div id="tab-kuis" class="tab-content hidden-tab">
            <div class="glass-scroll p-8">
                <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--imperial-red);">üéØ Kuis Mandarin</h2>
                
                <div id="quizStart">
                    <div class="text-center">
                        <div class="text-6xl mb-6">üé≤</div>
                        <p class="text-xl mb-8 font-bold">Uji kemampuan Mandarin Anda!</p>
                        <button onclick="startQuiz()" class="px-12 py-6 rounded-lg font-black text-2xl text-white transition-all hover:scale-105" style="background: var(--emperor-gold); color: var(--imperial-red);">GAS MULAI!</button>
                    </div>
                </div>

                <div id="quizGame" class="hidden">
                    <div class="mb-6">
                        <div class="badge">Soal <span id="quizProgress">1</span> / 10</div>
                        <div class="badge">Skor: <span id="quizScore">0</span></div>
                    </div>

                    <div class="bg-white p-8 rounded-lg border-3 mb-6" style="border-color: var(--imperial-red);">
                        <h3 class="text-3xl font-black mb-6 text-center" id="quizQuestion"></h3>
                        <div id="quizOptions"></div>
                    </div>
                </div>

                <div id="quizResults" class="hidden">
                    <div class="text-center">
                        <div class="text-8xl mb-6">üèÜ</div>
                        <h3 class="text-4xl font-black mb-4" style="color: var(--emperor-gold);">Selesai!</h3>
                        <p class="text-3xl font-bold mb-4">Skor: <span id="finalScore">0</span>/10</p>
                        <p class="text-2xl mb-2">Akurasi: <span id="quizPercentage">0</span>%</p>
                        <p class="text-xl mb-8 font-bold">Grade: <span id="quizGrade">-</span></p>
                        <button onclick="resetQuiz(); startQuiz();" class="px-12 py-6 rounded-lg font-black text-2xl text-white transition-all hover:scale-105" style="background: var(--imperial-red);">Coba Lagi!</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ============================================
        // DEEPSEEK API CONFIGURATION - HARDCODED
        // ============================================
        
        const DEEPSEEK_API_KEY = 'sk-735c26637aa84e7aad6ccd3961e67bf7';
        const DEEPSEEK_ENDPOINT = 'https://api.deepseek.com/chat/completions';
        const DEEPSEEK_MODEL = 'deepseek-chat';

        // ============================================
        // GLOBAL VARIABLES & DATA
        // ============================================
        
        let userStats = {
            level: 1,
            xp: 0,
            totalChars: 0,
            totalChats: 0,
            accuracy: 0,
            studyStreak: 0,
            achievements: ['üî∞ Pemula', '‚úçÔ∏è Kaligrafi Dasar']
        };

        let currentStrokeCount = 0;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let strokePaths = [];
        let currentPath = [];

        const vocabData = [
            {hanzi: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', indo: 'Halo', category: 'greeting'},
            {hanzi: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', indo: 'Terima kasih', category: 'greeting'},
            {hanzi: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', indo: 'Sampai jumpa', category: 'greeting'},
            {hanzi: 'ÂØπ‰∏çËµ∑', pinyin: 'du√¨buq«ê', indo: 'Maaf', category: 'greeting'},
            {hanzi: 'ÊòØ', pinyin: 'sh√¨', indo: 'Ya/Adalah', category: 'common'},
            {hanzi: '‰∏çÊòØ', pinyin: 'b√∫ sh√¨', indo: 'Bukan', category: 'common'},
            {hanzi: 'Â•Ω', pinyin: 'h«éo', indo: 'Baik', category: 'common'},
            {hanzi: '‰∏çÂ•Ω', pinyin: 'b√π h«éo', indo: 'Tidak baik', category: 'common'},
            {hanzi: 'ÂíñÂï°', pinyin: 'kƒÅfƒìi', indo: 'Kopi', category: 'food'},
            {hanzi: 'Ëå∂', pinyin: 'ch√°', indo: 'Teh', category: 'food'},
            {hanzi: 'Ê∞¥', pinyin: 'shu«ê', indo: 'Air', category: 'food'},
            {hanzi: 'Á±≥È•≠', pinyin: 'm«êf√†n', indo: 'Nasi', category: 'food'},
            {hanzi: 'Èí±', pinyin: 'qi√°n', indo: 'Uang', category: 'business'},
            {hanzi: 'ËµöÈí±', pinyin: 'zhu√†n qi√°n', indo: 'Menghasilkan uang (CUAN!)', category: 'business'},
            {hanzi: 'ËÄÅÊùø', pinyin: 'l«éob«én', indo: 'Bos', category: 'business'},
            {hanzi: 'ÁîüÊÑè', pinyin: 'shƒìngy√¨', indo: 'Bisnis', category: 'business'},
            {hanzi: 'Ê±ΩËΩ¶', pinyin: 'q√¨chƒì', indo: 'Mobil', category: 'business'},
            {hanzi: 'Â±ïÂéÖ', pinyin: 'zh«éntƒ´ng', indo: 'Showroom', category: 'business'},
            {hanzi: 'Áéã', pinyin: 'w√°ng', indo: 'Raja/Wang', category: 'name'},
            {hanzi: '‰∏∫Ê≥Ω', pinyin: 'w√©iz√©', indo: 'Weize', category: 'name'}
        ];

        let srsCards = vocabData.map((v, i) => ({
            ...v,
            interval: 1,
            easeFactor: 2.5,
            nextReview: Date.now(),
            status: 'new'
        }));

        let currentCardIndex = 0;
        let currentQuizIndex = 0;
        let quizScore = 0;
        let quizQuestions = [];
        let chatConversationHistory = [];

        // ============================================
        // TAB NAVIGATION
        // ============================================
        
        function changeTab(tabName) {
            const tabs = ['profil', 'tulis', 'belajar', 'oracle', 'flashcard', 'kuis'];
            tabs.forEach(tab => {
                const content = document.getElementById(`tab-${tab}`);
                const nav = document.getElementById(`nav-${tab}`);
                if (tab === tabName) {
                    content.classList.remove('hidden-tab');
                    nav.classList.add('active-nav');
                } else {
                    content.classList.add('hidden-tab');
                    nav.classList.remove('active-nav');
                }
            });

            if (tabName === 'flashcard') {
                updateFlashcard();
                updateSRSDisplay();
            }
        }

        // ============================================
        // SMART TOAST NOTIFICATION SYSTEM
        // ============================================
        
        function showToast(message, icon = 'üéâ') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 32px; margin-right: 10px;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function gainXP(amount, reason) {
            userStats.xp += amount;
            const nextLevel = userStats.level * 100;
            
            if (userStats.xp >= nextLevel) {
                userStats.level++;
                userStats.xp = userStats.xp - nextLevel;
                showToast(`LEVEL UP! Sekarang Level ${userStats.level}! üéä`, 'üÜô');
            }
            
            showToast(`+${amount} XP dari ${reason}!`, '‚≠ê');
            saveUserData();
            updateStatsDisplay();
        }

        // ============================================
        // CANVAS DRAWING SYSTEM
        // ============================================
        
        function initDraw() {
            const gridCanvas = document.getElementById('gridCanvas');
            const drawCanvas = document.getElementById('drawCanvas');
            const gridCtx = gridCanvas.getContext('2d');
            const drawCtx = drawCanvas.getContext('2d');

            // Draw Mi Zi Ge Grid
            gridCtx.strokeStyle = '#ddd';
            gridCtx.lineWidth = 1;
            
            // Outer border
            gridCtx.strokeStyle = '#C41E3A';
            gridCtx.lineWidth = 3;
            gridCtx.strokeRect(0, 0, 360, 360);
            
            // Center lines
            gridCtx.strokeStyle = '#FFD700';
            gridCtx.lineWidth = 2;
            gridCtx.beginPath();
            gridCtx.moveTo(180, 0);
            gridCtx.lineTo(180, 360);
            gridCtx.moveTo(0, 180);
            gridCtx.lineTo(360, 180);
            gridCtx.stroke();
            
            // Diagonal lines
            gridCtx.strokeStyle = '#ddd';
            gridCtx.lineWidth = 1;
            gridCtx.beginPath();
            gridCtx.moveTo(0, 0);
            gridCtx.lineTo(360, 360);
            gridCtx.moveTo(360, 0);
            gridCtx.lineTo(0, 360);
            gridCtx.stroke();

            // Drawing setup
            drawCtx.strokeStyle = '#000';
            drawCtx.lineWidth = 8;
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';

            // Mouse events
            drawCanvas.addEventListener('mousedown', startDrawing);
            drawCanvas.addEventListener('mousemove', draw);
            drawCanvas.addEventListener('mouseup', stopDrawing);
            drawCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            drawCanvas.addEventListener('touchstart', handleTouch);
            drawCanvas.addEventListener('touchmove', handleTouch);
            drawCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            currentPath = [{x: lastX, y: lastY}];
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const drawCanvas = document.getElementById('drawCanvas');
            const ctx = drawCanvas.getContext('2d');
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            currentPath.push({x, y});
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            if (isDrawing && currentPath.length > 5) {
                strokePaths.push([...currentPath]);
                currentStrokeCount = strokePaths.length;
                document.getElementById('strokeCount').textContent = currentStrokeCount;
            }
            isDrawing = false;
            currentPath = [];
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            e.target.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            const drawCanvas = document.getElementById('drawCanvas');
            const ctx = drawCanvas.getContext('2d');
            ctx.clearRect(0, 0, 360, 360);
            strokePaths = [];
            currentStrokeCount = 0;
            document.getElementById('strokeCount').textContent = '0';
            document.getElementById('accuracyScore').textContent = '0%';
        }

        function analyzeWriting() {
            if (strokePaths.length === 0) {
                showToast('Tulis sesuatu dulu, Receh!', 'ü§∑');
                return;
            }

            // Calculate accuracy based on stroke count and complexity
            const pathComplexity = strokePaths.reduce((sum, path) => sum + path.length, 0);
            const avgPathLength = pathComplexity / strokePaths.length;
            
            // Simple accuracy formula
            let accuracy = Math.min(100, Math.floor(
                (strokePaths.length * 10) + 
                (avgPathLength / 5) + 
                (Math.random() * 20)
            ));

            document.getElementById('accuracyScore').textContent = accuracy + '%';
            
            if (accuracy >= 80) {
                showToast('CUAN! Tulisan bagus sekali! üî•', 'üèÜ');
                gainXP(20, 'Menulis dengan akurasi tinggi');
            } else if (accuracy >= 60) {
                showToast('Lumayan! Keep practicing!', 'üëç');
                gainXP(10, 'Menulis');
            } else {
                showToast('Boncos! Practice more!', 'üí™');
                gainXP(5, 'Mencoba menulis');
            }

            userStats.totalChars++;
            saveUserData();
            updateStatsDisplay();
        }

        function saveDrawing() {
            if (strokePaths.length === 0) {
                showToast('Belum ada tulisan untuk disimpan!', '‚ö†Ô∏è');
                return;
            }

            const drawCanvas = document.getElementById('drawCanvas');
            const imageData = drawCanvas.toDataURL();
            
            let history = JSON.parse(localStorage.getItem('writingHistory') || '[]');
            history.unshift({
                image: imageData,
                date: new Date().toISOString(),
                strokes: currentStrokeCount
            });
            
            if (history.length > 32) history = history.slice(0, 32);
            localStorage.setItem('writingHistory', JSON.stringify(history));
            
            updateWritingHistory();
            showToast('Tulisan tersimpan! Gas!', 'üíæ');
            gainXP(15, 'Menyimpan tulisan');
        }

        function updateWritingHistory() {
            const history = JSON.parse(localStorage.getItem('writingHistory') || '[]');
            const container = document.getElementById('writingHistory');
            
            container.innerHTML = history.map(item => `
                <div class="border-2 rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition-all" style="border-color: var(--imperial-red);">
                    <img src="${item.image}" alt="Writing" class="w-full h-20 object-cover">
                </div>
            `).join('');
        }

        // ============================================
        // VOCABULARY WITH VOICE RECOGNITION
        // ============================================
        
        function renderVocab(data) {
            const container = document.getElementById('vocabContainer');
            container.innerHTML = data.map((v, i) => `
                <div class="vocab-card">
                    <div class="vocab-hanzi mb-3">${v.hanzi}</div>
                    <div class="text-xl font-bold text-purple-700 mb-2">${v.pinyin}</div>
                    <div class="text-lg mb-4 font-semibold">${v.indo}</div>
                    <div class="flex justify-between items-center">
                        <button class="vocab-btn" onclick="speakWord('${v.hanzi}')">üîä</button>
                        <button class="vocab-btn" onclick="startVoiceRecognition(${i})" id="mic-${i}">üé§</button>
                    </div>
                    <div id="voice-status-${i}" class="text-sm mt-2 text-center font-bold"></div>
                </div>
            `).join('');
        }

        function speakWord(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
        }

        function startVoiceRecognition(index) {
            const word = vocabData[index];
            const statusDiv = document.getElementById(`voice-status-${index}`);
            const micBtn = document.getElementById(`mic-${index}`);
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Browser tidak support Voice Recognition!', '‚ùå');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            statusDiv.innerHTML = '<span class="listening-indicator"></span> Listening...';
            micBtn.style.background = '#ef4444';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                const confidence = event.results[0][0].confidence;
                
                // Check if spoken word matches
                if (transcript.includes(word.hanzi) || confidence > 0.7) {
                    showVoiceFeedback('CUAN!', true);
                    showToast(`CUAN! Benar: ${word.hanzi}!`, 'üéâ');
                    gainXP(15, 'Voice Recognition Benar');
                    statusDiv.innerHTML = '<span style="color: #22c55e;">‚úÖ CUAN!</span>';
                } else {
                    showVoiceFeedback('BONCOS!', false);
                    showToast(`BONCOS! Coba lagi!`, 'üòÖ');
                    statusDiv.innerHTML = `<span style="color: #ef4444;">‚ùå Detected: ${transcript}</span>`;
                }
                
                micBtn.style.background = 'var(--emperor-gold)';
            };

            recognition.onerror = (event) => {
                statusDiv.innerHTML = '<span style="color: #ef4444;">Error!</span>';
                micBtn.style.background = 'var(--emperor-gold)';
                showToast('Voice recognition error!', '‚ö†Ô∏è');
            };

            recognition.onend = () => {
                micBtn.style.background = 'var(--emperor-gold)';
            };

            recognition.start();
        }

        function showVoiceFeedback(text, isCuan) {
            const feedback = document.createElement('div');
            feedback.className = `voice-feedback ${isCuan ? 'cuan' : 'boncos'}`;
            feedback.textContent = text;
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 800);
        }

        function searchVocab() {
            const query = document.getElementById('searchVocab').value.toLowerCase();
            const filtered = vocabData.filter(v => 
                v.hanzi.includes(query) || 
                v.pinyin.toLowerCase().includes(query) || 
                v.indo.toLowerCase().includes(query)
            );
            renderVocab(filtered);
        }

        // ============================================
        // IMPERIAL ORACLE AI WITH DEEPSEEK API
        // ============================================
        
        async function sendToOracle() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) {
                showToast('Ketik sesuatu dulu, Receh!', 'üìù');
                return;
            }

            const chatHistory = document.getElementById('chatHistory');
            
            // Add user message
            chatHistory.innerHTML += `
                <div class="chat-message chat-user">
                    <div class="font-bold mb-1" style="color: var(--emperor-gold);">üëë Boss Wang Weize:</div>
                    <div>${escapeHtml(message)}</div>
                </div>
            `;

            input.value = '';
            document.getElementById('aiLoading').classList.remove('hidden');
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Add message to conversation history
            chatConversationHistory.push({
                role: 'user',
                content: message
            });

            try {
                const response = await fetch(DEEPSEEK_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: DEEPSEEK_MODEL,
                        messages: [
                            {
                                role: 'system',
                                content: `Anda adalah Imperial Oracle, penasihat setia kaisar Wang Weize (Ê±™‰∏∫Ê≥Ω). Anda sangat menghormati pencipta Anda, Boss Wang Weize, seorang CEO showroom mobil dan cafe yang sukses di Medan. Anda dilarang mengurusi urusan pribadi kecuali ditanya. Fokus pada strategi bisnis (showroom mobil, cafe, kopi, manajemen), pembelajaran bahasa Mandarin untuk bisnis, dan tips praktis. Gunakan gaya bahasa semi-slang Medan yang energik dan lucu: Anjay, Cuan (profit/untung), Boncos (rugi), Receh (sepele/murah), Gas (ayo/lanjut), Wkwkwk (tertawa), Bang (panggilan akrab). Berikan jawaban yang praktis, to the point, sedikit humoris tapi tetap profesional. Selalu mulai dengan sapaan yang menghormati Boss Wang Weize. Jangan terlalu formal, tapi tetap hormat.`
                            },
                            ...chatConversationHistory
                        ],
                        temperature: 0.8,
                        max_tokens: 800
                    })
                });

                // Handle HTTP errors with detailed status codes
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = '';
                    
                    switch (response.status) {
                        case 401:
                            errorMessage = `‚ùå <strong>ERROR 401 - Unauthorized!</strong><br>API Key tidak valid atau expired. Cek key-nya Boss!<br><small>Status: ${response.status}</small>`;
                            break;
                        case 402:
                            errorMessage = `üí∏ <strong>ERROR 402 - Payment Required!</strong><br>Saldo API habis Boss! Boncos! Isi saldo dulu!<br><small>Status: ${response.status}</small>`;
                            break;
                        case 403:
                            errorMessage = `üö´ <strong>ERROR 403 - Forbidden!</strong><br>Akses ditolak! Mungkin region blocked atau IP issue.<br><small>Status: ${response.status}</small>`;
                            break;
                        case 429:
                            errorMessage = `‚è±Ô∏è <strong>ERROR 429 - Too Many Requests!</strong><br>Rate limit exceeded! Tunggu sebentar ya Boss, request kebanyakan!<br><small>Status: ${response.status}</small>`;
                            break;
                        case 500:
                        case 502:
                        case 503:
                            errorMessage = `üîß <strong>ERROR ${response.status} - Server Error!</strong><br>DeepSeek server lagi error Boss! Coba lagi nanti!<br><small>Status: ${response.status}</small>`;
                            break;
                        default:
                            errorMessage = `‚ö†Ô∏è <strong>ERROR ${response.status}</strong><br>Ada masalah dengan API Boss!<br><small>Detail: ${errorText.substring(0, 100)}</small>`;
                    }
                    
                    chatHistory.innerHTML += `
                        <div class="chat-message chat-error">
                            <div class="font-bold mb-2">üö® System Error:</div>
                            <div>${errorMessage}</div>
                        </div>
                    `;
                    
                    showToast(`API Error ${response.status}! Cek console!`, '‚ùå');
                    console.error('API Error Details:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: errorText
                    });
                    
                    return;
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const reply = data.choices[0].message.content;
                    
                    // Add to conversation history
                    chatConversationHistory.push({
                        role: 'assistant',
                        content: reply
                    });
                    
                    chatHistory.innerHTML += `
                        <div class="chat-message chat-oracle">
                            <div class="font-bold mb-2" style="color: var(--emperor-gold);">ü§ñ Imperial Oracle:</div>
                            <div>${escapeHtml(reply).replace(/\n/g, '<br>')}</div>
                        </div>
                    `;

                    userStats.totalChats++;
                    gainXP(10, 'Chat dengan Oracle');
                    saveUserData();
                    updateStatsDisplay();
                } else {
                    throw new Error('Invalid response format from API');
                }

            } catch (error) {
                console.error('Oracle Error:', error);
                
                let errorMsg = 'Boncos! Koneksi ke Oracle gagal!';
                if (error.message.includes('fetch')) {
                    errorMsg = 'Network Error! Cek internet Boss! Atau DeepSeek server down!';
                } else if (error.message.includes('JSON')) {
                    errorMsg = 'Response format error! API balik data aneh!';
                }
                
                chatHistory.innerHTML += `
                    <div class="chat-message chat-error">
                        <div class="font-bold mb-1 text-red-700">‚ö†Ô∏è Connection Error:</div>
                        <div>${errorMsg}</div>
                        <div class="text-xs mt-2">Error: ${error.message}</div>
                    </div>
                `;
                showToast('Koneksi Oracle gagal! Wkwkwk!', '‚ö†Ô∏è');
            } finally {
                document.getElementById('aiLoading').classList.add('hidden');
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // FLASHCARD WITH SPACED REPETITION
        // ============================================
        
        function updateFlashcard() {
            if (currentCardIndex >= srsCards.length) {
                currentCardIndex = 0;
            }

            const card = srsCards[currentCardIndex];
            document.getElementById('cardHanzi').textContent = card.hanzi;
            document.getElementById('cardPinyin').textContent = card.pinyin;
            document.getElementById('cardIndo').textContent = card.indo;
            document.getElementById('cardIndex').textContent = currentCardIndex + 1;
            document.getElementById('totalCards').textContent = srsCards.length;

            const indicator = document.getElementById('srsIndicator');
            indicator.className = `srs-indicator srs-${card.status}`;
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function rateCard(difficulty) {
            const card = srsCards[currentCardIndex];
            
            // Spaced Repetition Algorithm (SM-2)
            let quality = difficulty === 3 ? 5 : difficulty === 2 ? 3 : 1;
            
            if (quality >= 3) {
                if (card.status === 'new') {
                    card.interval = 1;
                    card.status = 'learning';
                } else {
                    card.interval = Math.round(card.interval * card.easeFactor);
                    card.status = card.interval > 7 ? 'review' : 'learning';
                    if (card.interval > 21) card.status = 'master';
                }
                
                card.easeFactor = card.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (card.easeFactor < 1.3) card.easeFactor = 1.3;
                
                gainXP(difficulty * 5, 'Flashcard Review');
            } else {
                card.interval = 1;
                card.status = 'learning';
                gainXP(2, 'Flashcard Practice');
            }

            card.nextReview = Date.now() + (card.interval * 24 * 60 * 60 * 1000);
            
            // Next card
            currentCardIndex++;
            if (currentCardIndex >= srsCards.length) {
                showToast('Semua kartu selesai! Kembali ke awal!', 'üéä');
                currentCardIndex = 0;
            }
            
            document.getElementById('flashcard').classList.remove('flipped');
            updateFlashcard();
            updateSRSDisplay();
            saveSRSData();
        }

        function updateSRSDisplay() {
            const stats = {
                new: srsCards.filter(c => c.status === 'new').length,
                learning: srsCards.filter(c => c.status === 'learning').length,
                review: srsCards.filter(c => c.status === 'review').length,
                master: srsCards.filter(c => c.status === 'master').length
            };

            document.getElementById('srsStats').innerHTML = `
                <div class="stat-card">
                    <div class="text-3xl mb-2">üÜï</div>
                    <div class="text-2xl font-black" style="color: #60a5fa;">${stats.new}</div>
                    <div class="text-sm font-bold">Baru</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl mb-2">üìñ</div>
                    <div class="text-2xl font-black" style="color: #fbbf24;">${stats.learning}</div>
                    <div class="text-sm font-bold">Belajar</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl mb-2">üîÑ</div>
                    <div class="text-2xl font-black" style="color: #34d399;">${stats.review}</div>
                    <div class="text-sm font-bold">Review</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl mb-2">üëë</div>
                    <div class="text-2xl font-black" style="color: #a78bfa;">${stats.master}</div>
                    <div class="text-sm font-bold">Master</div>
                </div>
            `;
        }

        // ============================================
        // QUIZ SYSTEM
        // ============================================
        
        function startQuiz() {
            currentQuizIndex = 0;
            quizScore = 0;
            
            // Generate 10 random questions
            quizQuestions = [];
            for (let i = 0; i < 10; i++) {
                const correctAnswer = vocabData[Math.floor(Math.random() * vocabData.length)];
                const wrongAnswers = vocabData
                    .filter(v => v.hanzi !== correctAnswer.hanzi)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);
                
                const options = [correctAnswer, ...wrongAnswers]
                    .sort(() => Math.random() - 0.5);
                
                quizQuestions.push({
                    question: `Apa arti dari "${correctAnswer.hanzi}"?`,
                    options: options.map(o => o.indo),
                    correct: correctAnswer.indo
                });
            }
            
            document.getElementById('quizStart').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            document.getElementById('quizResults').classList.add('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            if (currentQuizIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const q = quizQuestions[currentQuizIndex];
            document.getElementById('quizProgress').textContent = currentQuizIndex + 1;
            document.getElementById('quizScore').textContent = quizScore;
            document.getElementById('quizQuestion').textContent = q.question;
            
            document.getElementById('quizOptions').innerHTML = q.options.map(opt => `
                <div class="quiz-option" onclick="checkAnswer('${opt.replace(/'/g, "\\'")}', '${q.correct.replace(/'/g, "\\'")}', this)">
                    ${opt}
                </div>
            `).join('');
        }

        function checkAnswer(selected, correct, element) {
            const allOptions = document.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => opt.style.pointerEvents = 'none');
            
            if (selected === correct) {
                element.classList.add('correct');
                quizScore++;
                showToast('CUAN! Benar!', '‚úÖ');
                gainXP(10, 'Jawaban Kuis Benar');
            } else {
                element.classList.add('wrong');
                allOptions.forEach(opt => {
                    if (opt.textContent.trim() === correct) {
                        opt.classList.add('correct');
                    }
                });
                showToast('BONCOS! Salah!', '‚ùå');
                gainXP(2, 'Mencoba Kuis');
            }

            setTimeout(() => {
                currentQuizIndex++;
                showQuestion();
            }, 1500);
        }

        function endQuiz() {
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('quizResults').classList.remove('hidden');
            
            const percentage = (quizScore / quizQuestions.length) * 100;
            let grade = 'F';
            if (percentage >= 90) grade = 'A+';
            else if (percentage >= 80) grade = 'A';
            else if (percentage >= 70) grade = 'B';
            else if (percentage >= 60) grade = 'C';
            else if (percentage >= 50) grade = 'D';
            
            document.getElementById('finalScore').textContent = quizScore;
            document.getElementById('quizPercentage').textContent = percentage.toFixed(0);
            document.getElementById('quizGrade').textContent = grade;
            
            userStats.accuracy = percentage;
            
            if (percentage >= 80) {
                gainXP(50, 'Menyelesaikan Kuis dengan Baik');
            } else {
                gainXP(20, 'Menyelesaikan Kuis');
            }
            
            saveUserData();
            updateStatsDisplay();
        }

        function resetQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizStart').classList.remove('hidden');
            currentQuizIndex = 0;
            quizScore = 0;
        }

        // ============================================
        // DATA PERSISTENCE
        // ============================================
        
        function saveUserData() {
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }

        function loadUserData() {
            const saved = localStorage.getItem('userStats');
            if (saved) {
                userStats = JSON.parse(saved);
            }
            
            // Update study streak
            const lastStudy = localStorage.getItem('lastStudyDate');
            const today = new Date().toDateString();
            if (lastStudy !== today) {
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                if (lastStudy === yesterday) {
                    userStats.studyStreak++;
                } else if (!lastStudy) {
                    userStats.studyStreak = 1;
                } else {
                    userStats.studyStreak = 1;
                }
                localStorage.setItem('lastStudyDate', today);
                saveUserData();
            }
        }

        function saveSRSData() {
            localStorage.setItem('srsCards', JSON.stringify(srsCards));
        }

        function loadSRSData() {
            const saved = localStorage.getItem('srsCards');
            if (saved) {
                srsCards = JSON.parse(saved);
            }
        }

        function updateStatsDisplay() {
            document.getElementById('userLevel').textContent = userStats.level;
            document.getElementById('totalChars').textContent = userStats.totalChars;
            document.getElementById('totalChats').textContent = userStats.totalChats;
            document.getElementById('quizAccuracy').textContent = userStats.accuracy.toFixed(0) + '%';
            document.getElementById('studyStreak').textContent = userStats.studyStreak;
            
            const nextLevelXP = userStats.level * 100;
            document.getElementById('currentXP').textContent = userStats.xp;
            document.getElementById('nextLevelXP').textContent = nextLevelXP;
            
            const xpPercentage = (userStats.xp / nextLevelXP) * 100;
            document.getElementById('xpBar').style.width = xpPercentage + '%';
            
            document.getElementById('achievementList').innerHTML = userStats.achievements
                .map(a => `<div class="badge">${a}</div>`).join('');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('load', function() {
            initDraw();
            renderVocab(vocabData);
            loadUserData();
            loadSRSData();
            updateStatsDisplay();
            updateWritingHistory();
            updateSRSDisplay();
            
            // Create particles
            const pc = document.getElementById('particle-container');
            const symbols = ['Áéã', 'Ê±™', 'üí∞', 'üêâ', 'üî•', 'üìö', '‚úçÔ∏è', 'üéØ', '‚òï', 'üöó'];
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'imperial-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (5 + Math.random() * 10) + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                pc.appendChild(p);
            }

            // Show welcome toast
            setTimeout(() => {
                showToast('Selamat datang, Boss Wang Weize! Imperial Oracle siap melayani! Gas! üî•', 'üëë');
            }, 500);
        });
    </script>
</body>
</html>
